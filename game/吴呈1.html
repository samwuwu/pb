<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>航空安全打鼹鼠</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Noto+Sans+SC:wght@400;500;600;700;900&display=swap"
        rel="stylesheet">
    <style>
        /* --- CSS Variables Definition (OPTIMIZED DARK THEME) --- */
        :root {
            /* Optimized Dark Theme Palette */
            --primary-bg: #121218;
            /* Softer dark background */
            --secondary-bg: #1F1F26;
            /* Warmer container bg */
            --tertiary-bg: #2B2B34;
            /* Comfortable card backgrounds */
            --ui-border: #404048;
            /* More visible borders */
            --ui-border-light: #525258;
            /* Clear lighter borders */
            --text-primary: #2C3E50;
            /* Dark text for white background */
            --text-secondary: #5A6C7D;
            /* Medium gray for secondary text */
            --text-muted: #7F8C8D;
            /* Light gray for muted text */

            /* Optimized Action Colors with Better Contrast */
            --accent-blue: #5B9BD5;
            --accent-blue-light: #7BB3E8;
            --accent-blue-dark: #4682B4;
            --accent-blue-gradient: linear-gradient(135deg, #5B9BD5 0%, #7BB3E8 50%, #4682B4 100%);

            --accent-green: #4CAF50;
            --accent-green-light: #66BB6A;
            --accent-green-dark: #388E3C;
            --accent-green-gradient: linear-gradient(135deg, #4CAF50 0%, #66BB6A 50%, #388E3C 100%);

            --accent-red: #F44336;
            --accent-red-light: #EF5350;
            --accent-red-dark: #D32F2F;
            --accent-red-gradient: linear-gradient(135deg, #F44336 0%, #EF5350 50%, #D32F2F 100%);

            --accent-negative: #E53935;
            --gold: #FFC107;
            --gold-light: #FFD54F;
            --gold-dark: #FF8F00;
            --gold-gradient: linear-gradient(135deg, #FFC107 0%, #FFD54F 50%, #FF8F00 100%);

            /* Optimized Glow Effects */
            --glow-blue: 0 0 20px rgba(91, 155, 213, 0.4);
            --glow-green: 0 0 20px rgba(76, 175, 80, 0.4);
            --glow-gold: 0 0 20px rgba(255, 193, 7, 0.5);
            --glow-red: 0 0 20px rgba(244, 67, 54, 0.4);

            /* Enhanced Shadows */
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.15);
            --shadow-medium: 0 8px 32px rgba(0, 0, 0, 0.25);
            --shadow-strong: 0 12px 48px rgba(0, 0, 0, 0.35);
            --shadow-inset: inset 0 2px 8px rgba(0, 0, 0, 0.2);

            /* Mapping for convenience - these names match the old theme */
            --primary-pink: var(--accent-blue);
            --secondary-pink: var(--accent-blue-dark);
            --light-blue: var(--secondary-bg);
            --dark-blue: var(--accent-blue);
            --share-blue: var(--accent-blue);
            --share-blue-dark: var(--accent-blue-dark);
            --green: var(--accent-green);
            --dark-green: var(--accent-green-dark);
            --bomb-red: var(--accent-red);
            --text-dark: var(--text-primary);
            /* Inverted role */
            --background-light: var(--secondary-bg);
            /* Inverted role */
            --background-dark: var(--primary-bg);
            /* Inverted role */
            --score-positive: var(--green);
            --score-negative: var(--accent-negative);

            /* Mole Colors (Unchanged) */
            --mole-body: #6d4c41;
            --mole-belly: #a1887f;
            --mole-nose: #ff8a80;
            --dirt-color: #8B4513;
            --claw-color: #c5b1aa;
        }

        /* --- Global Styles Reset and Base Settings --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            /* Optimize for Chinese text rendering */
            text-rendering: optimizeLegibility;
            -webkit-font-feature-settings: "kern" 1;
            font-feature-settings: "kern" 1;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', 'SimSun', '宋体', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 100vh;
            /* Enhanced font rendering for Chinese */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-feature-settings: "kern" 1;
        }

        /* Removed animated background particles to improve performance */

        /* Removed floating cloud animations for a cleaner, tech look */

        .container {
            width: 100%;
            max-width: 500px;
            height: 100%;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 24px;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(30, 60, 114, 0.2);
        }

        /* Enhanced container glow effect */
        .container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg,
                    rgba(74, 144, 226, 0.2) 0%,
                    rgba(80, 227, 194, 0.2) 25%,
                    rgba(255, 215, 0, 0.2) 50%,
                    rgba(80, 227, 194, 0.2) 75%,
                    rgba(74, 144, 226, 0.2) 100%);
            border-radius: 34px;
            z-index: -1;
            /* Removed animation for better performance */
            opacity: 0.4;
        }

        /* Removed borderGlow animation for performance */

        .container.shake {
            animation: screenShake 0.4s ease-in-out;
        }

        @keyframes screenShake {

            0%,
            100% {
                transform: translateX(0);
            }

            20% {
                transform: translateX(-8px) rotate(-1deg);
            }

            40% {
                transform: translateX(8px) rotate(1deg);
            }

            60% {
                transform: translateX(-5px) rotate(-0.5deg);
            }

            80% {
                transform: translateX(5px) rotate(0.5deg);
            }
        }

        /* Removed sparkle animation */

        /* --- Rule Page Styles --- */
        #rulePage {
            padding: 20px 10px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
            z-index: 10;
        }

        .page-title {
            text-align: center;
            margin-bottom: 15px;
            width: 100%;
        }

        .page-title h1 {
            font-size: 2.2rem;
            margin-bottom: 12px;
            color: #1e3c72;
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            letter-spacing: 1px;
            line-height: 1.2;
            position: relative;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.8), 0 0 10px rgba(30, 60, 114, 0.3);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-weight: 700;
        }

        /* Removed blurred background for better readability */

        @keyframes titleShimmer {

            0%,
            100% {
                background-position: 0% 50%;
                filter: brightness(1);
            }

            50% {
                background-position: 100% 50%;
                filter: brightness(1.2);
            }
        }

        .page-title .icon {
            font-size: 4rem;
            display: block;
            margin: 15px auto;
            color: #2a5298;
            animation: iconFloat 3s ease-in-out infinite;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.8), 0 0 8px rgba(42, 82, 152, 0.4);
            position: relative;
        }

        .page-title .icon::before {
            content: '✈️';
            position: absolute;
            top: 0;
            left: 0;
            background: var(--accent-blue-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: blur(4px);
            opacity: 0.5;
            z-index: -1;
        }

        @keyframes iconFloat {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        .high-score-display {
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: #2C3E50;
            background: linear-gradient(135deg,
                    rgba(255, 193, 7, 0.2) 0%,
                    rgba(255, 213, 79, 0.15) 50%,
                    rgba(255, 143, 0, 0.2) 100%);
            padding: 8px 20px;
            border-radius: 20px;
            margin-bottom: 18px;
            border: 2px solid #d68910;
            position: relative;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
            backdrop-filter: blur(5px);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .high-score-display::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--gold-gradient);
            border-radius: 22px;
            z-index: -1;
            /* Removed animation for better performance */
        }

        .high-score-display i {
            color: var(--gold);
            margin-right: 8px;
            filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.5));
        }

        /* Removed scoreGlow animation for performance */

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* --- Story Intro Styles --- */
        #story-container {
            position: relative;
            flex-grow: 1;
            width: 100%;
            margin-bottom: 18px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 25px;
            border: 2px solid #1e3c72;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(8px);
        }

        #story-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg,
                    var(--accent-blue) 0%,
                    var(--accent-green) 25%,
                    var(--accent-blue) 50%,
                    var(--accent-green) 75%,
                    var(--accent-blue) 100%);
            border-radius: 26px;
            z-index: -1;
            /* Removed animation for better performance */
        }

        /* Removed containerBorder animation for performance */

        .story-slide {
            position: absolute;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
            text-align: center;
            pointer-events: none;
            width: 90%;
        }

        .story-slide.active {
            opacity: 1;
            pointer-events: auto;
        }

        .story-slide h3 {
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.4rem;
            line-height: 1.3;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.9), 0 0 8px rgba(30, 60, 114, 0.2);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .story-slide p {
            font-size: 1.05rem;
            line-height: 1.6;
            color: #2c3e50;
            min-height: 100px;
            font-weight: 400;
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.9);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .typing-cursor {
            animation: blink 0.7s infinite;
            color: #1e3c72;
            font-weight: bold;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        #next-story-btn {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: #1e3c72;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 18px;
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(30, 60, 114, 0.4);
            transition: all 0.3s ease;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
        }

        #next-story-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #next-story-btn:hover {
            background: #2a5298;
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(42, 82, 152, 0.5);
        }

        @keyframes buttonAppear {
            0% {
                opacity: 0;
                transform: translateY(10px) scale(0.9);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        #skip-story-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(30, 60, 114, 0.9);
            color: white;
            border: 1px solid #1e3c72;
            border-radius: 12px;
            padding: 8px 14px;
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 15;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 8px rgba(30, 60, 114, 0.3);
        }

        #skip-story-btn:hover {
            background: #2a5298;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(42, 82, 152, 0.4);
        }

        /* --- Start Button Mole --- */
        #start-mole-container {
            position: relative;
            width: 90px;
            height: 90px;
            margin-top: 25px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.8) translateY(20px);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            filter: drop-shadow(var(--shadow-medium));
        }

        #start-mole-container.story-complete {
            opacity: 0.85;
            transform: scale(1) translateY(0);
            pointer-events: auto;
            animation: startMoleBreath 2s ease-in-out infinite;
        }

        #start-mole-container.story-complete:hover {
            opacity: 1;
            transform: scale(1.1) translateY(-2px);
            filter: drop-shadow(var(--shadow-strong)) drop-shadow(var(--glow-green));
        }

        @keyframes startMoleBreath {

            0%,
            100% {
                transform: scale(1) translateY(0);
                filter: drop-shadow(var(--shadow-medium));
            }

            50% {
                transform: scale(1.02) translateY(-1px);
                filter: drop-shadow(var(--shadow-medium)) drop-shadow(0 0 15px rgba(80, 227, 194, 0.2));
            }
        }

        #start-mole-btn {
            width: 50px;
            height: 50px;
            position: relative;
            transition: transform 0.2s ease-out;
        }

        #start-mole-container:hover #start-mole-btn {
            transform: scale(1.1);
        }

        .start-text {
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            font-size: 1.1rem;
            font-weight: 500;
            color: #2C3E50;
            margin-top: 10px;
            pointer-events: none;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        #start-mole-container:hover .start-text {
            color: #1e3c72;
            transform: translateY(-1px);
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.9), 0 0 8px rgba(30, 60, 114, 0.3);
        }

        #hammer-sfx {
            position: absolute;
            font-size: 40px;
            top: -15px;
            right: -15px;
            transform: rotate(45deg);
            opacity: 0;
            pointer-events: none;
        }

        #start-mole-container.smashed #hammer-sfx {
            opacity: 1;
            animation: hammer-smash 0.4s ease-out forwards;
        }

        #start-mole-container.smashed #start-mole-btn {
            animation: mole-squash 0.4s ease-out forwards;
        }

        @keyframes hammer-smash {
            0% {
                transform: rotate(45deg) scale(1);
                top: -15px;
                right: -15px;
            }

            50% {
                transform: rotate(-20deg) scale(1.2);
                top: 5px;
                right: 5px;
            }

            100% {
                transform: rotate(-20deg) scale(1.2);
                opacity: 0;
            }
        }

        @keyframes mole-squash {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2, 0.6);
            }

            100% {
                transform: scale(0);
                opacity: 0;
            }
        }


        /* --- Game Page Styles --- */
        #gamePage {
            display: none;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 10px;
            position: relative;
            flex-shrink: 0;
        }

        .help-btn {
            /* Position help button as a normal flex item to avoid overlapping with other header elements */
            position: relative;
            margin: 0 12px;
            /* remove centering transform */
            background: linear-gradient(135deg,
                    var(--tertiary-bg) 0%,
                    var(--secondary-bg) 50%,
                    var(--tertiary-bg) 100%);
            border: 2px solid var(--ui-border-light);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.3rem;
            color: var(--accent-blue);
            box-shadow: var(--shadow-medium), var(--glow-blue);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .help-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center,
                    rgba(74, 144, 226, 0.2) 0%,
                    transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .help-btn:hover {
            transform: translate(-50%, -50%) scale(1.15) rotate(15deg);
            border-color: var(--accent-blue);
            box-shadow: var(--shadow-strong), 0 0 25px rgba(74, 144, 226, 0.4);
        }

        .help-btn:hover::before {
            opacity: 1;
        }

        .help-btn:active {
            transform: translate(-50%, -50%) scale(1.05) rotate(15deg);
        }

        .score,
        .time {
            padding: 10px 18px;
            border-radius: 28px;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            min-width: 100px;
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            position: relative;
            backdrop-filter: blur(15px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            /* Enhanced font rendering */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* --- Time Progress Bar --- */
        .time-bar-container {
            width: 100%;
            height: 8px;
            background: var(--ui-border-light);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 6px;
        }

        .time-bar {
            height: 100%;
            width: 100%;
            background: var(--accent-green);
            transition: width 0.3s linear, background 0.3s linear;
        }

        .score {
            background: linear-gradient(135deg,
                    rgba(30, 60, 114, 0.9) 0%,
                    rgba(42, 82, 152, 0.8) 50%,
                    rgba(30, 60, 114, 0.9) 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .score::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(74, 144, 226, 0.1),
                    transparent);
            transition: left 0.6s;
        }

        .score:hover::before {
            left: 100%;
        }

        .time {
            background: var(--accent-green-gradient);
            color: white;
            border: 2px solid var(--accent-green);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: timeGlow 2s ease-in-out infinite;
        }

        .score i,
        .time i {
            margin-right: 10px;
            font-size: 1.1rem;
            filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.3));
        }

        .score i {
            color: var(--accent-blue);
            animation: starTwinkle 1.5s ease-in-out infinite;
        }

        .time i {
            color: var(--primary-bg);
        }

        @keyframes timeGlow {

            0%,
            100% {
                box-shadow: var(--shadow-medium), var(--glow-green);
            }

            50% {
                box-shadow: var(--shadow-medium), 0 0 25px rgba(80, 227, 194, 0.5);
            }
        }

        @keyframes starTwinkle {

            0%,
            100% {
                transform: scale(1) rotate(0deg);
                filter: drop-shadow(0 0 4px rgba(74, 144, 226, 0.3));
            }

            50% {
                transform: scale(1.1) rotate(180deg);
                filter: drop-shadow(0 0 8px rgba(74, 144, 226, 0.5));
            }
        }

        .time.bonus-effect {
            animation: timeBonusPulse 0.6s ease-out;
        }

        .time.warning {
            background: var(--accent-red-gradient) !important;
            border-color: var(--accent-red) !important;
            animation: timeWarning 1s ease-in-out infinite !important;
        }

        .time.critical {
            background: linear-gradient(135deg,
                    var(--accent-red) 0%,
                    var(--accent-red-light) 50%,
                    var(--accent-red-dark) 100%) !important;
            border-color: var(--accent-red-light) !important;
            animation: timeCritical 0.5s ease-in-out infinite !important;
        }

        @keyframes timeBonusPulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: var(--shadow-medium), var(--glow-green);
            }

            50% {
                transform: scale(1.15);
                box-shadow: var(--shadow-strong), 0 0 30px var(--gold);
            }
        }

        @keyframes timeWarning {

            0%,
            100% {
                box-shadow: var(--shadow-medium), var(--glow-red);
                transform: scale(1);
            }

            50% {
                box-shadow: var(--shadow-strong), 0 0 25px rgba(255, 71, 87, 0.6);
                transform: scale(1.05);
            }
        }

        @keyframes timeCritical {

            0%,
            100% {
                box-shadow: var(--shadow-medium), var(--glow-red);
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                box-shadow: var(--shadow-strong), 0 0 35px rgba(255, 71, 87, 0.8);
                transform: scale(1.08);
                filter: brightness(1.2);
            }
        }

        .combo-counter {
            position: absolute;
            top: 75px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.8rem;
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            font-weight: 700;
            color: white;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            z-index: 50;
            text-shadow: 0 0 15px var(--gold), 2px 2px 4px rgba(0, 0, 0, 0.8);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .combo-counter::before {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: blur(8px);
            opacity: 0.7;
            z-index: -1;
        }

        .combo-counter::after {
            content: '✨';
            position: absolute;
            top: -10px;
            right: -20px;
            font-size: 1.5rem;
            animation: sparkle 1s ease-in-out infinite;
            opacity: 0;
        }

        .combo-counter.active {
            opacity: 1;
            animation: comboExplosion 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .combo-counter.active::after {
            opacity: 1;
        }

        @keyframes comboExplosion {
            0% {
                transform: translateX(-50%) scale(0.5) rotate(-10deg);
                opacity: 0;
                filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.3));
            }

            50% {
                transform: translateX(-50%) scale(1.4) rotate(5deg);
                opacity: 1;
                filter: drop-shadow(0 0 25px rgba(255, 215, 0, 0.8));
            }

            100% {
                transform: translateX(-50%) scale(1) rotate(0deg);
                opacity: 1;
                filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.6));
            }
        }

        @keyframes sparkle {

            0%,
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 0.6;
            }

            50% {
                transform: scale(1.3) rotate(180deg);
                opacity: 1;
            }
        }

        /* --- PARTICLE EFFECTS --- */
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 100;
            border-radius: 50%;
            animation: particleExplosion 0.8s ease-out forwards;
        }

        .particle.success {
            background: radial-gradient(circle, var(--accent-green) 0%, var(--accent-green-light) 50%, transparent 100%);
            box-shadow: 0 0 6px var(--accent-green);
        }

        .particle.error {
            background: radial-gradient(circle, var(--accent-red) 0%, var(--accent-red-light) 50%, transparent 100%);
            box-shadow: 0 0 6px var(--accent-red);
        }

        .particle.bonus {
            background: radial-gradient(circle, var(--gold) 0%, var(--gold-light) 50%, transparent 100%);
            box-shadow: 0 0 8px var(--gold);
        }

        @keyframes particleExplosion {
            0% {
                opacity: 1;
                transform: scale(0) rotate(0deg) translate(0, 0);
            }

            20% {
                opacity: 1;
                transform: scale(1) rotate(90deg) translate(calc(var(--vx) * 0.3), calc(var(--vy) * 0.3));
            }

            100% {
                opacity: 0;
                transform: scale(0.3) rotate(360deg) translate(var(--vx), var(--vy));
            }
        }

        /* Hit ripple effect */
        .hit-ripple {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 90;
            animation: rippleExpand 0.6s ease-out forwards;
        }

        .hit-ripple.success {
            border: 3px solid var(--accent-green);
            box-shadow: 0 0 20px rgba(80, 227, 194, 0.4);
        }

        .hit-ripple.error {
            border: 3px solid var(--accent-red);
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.4);
        }

        .hit-ripple.bonus {
            border: 4px solid var(--gold);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.6);
        }

        @keyframes rippleExpand {
            0% {
                width: 20px;
                height: 20px;
                opacity: 1;
                transform: translate(-50%, -50%) scale(0);
            }

            100% {
                width: 120px;
                height: 120px;
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* Screen flash effects */
        .screen-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 200;
            opacity: 0;
            animation: screenFlash 0.3s ease-out forwards;
        }

        .screen-flash.success {
            background: radial-gradient(circle at center,
                    rgba(80, 227, 194, 0.2) 0%,
                    transparent 70%);
        }

        .screen-flash.combo {
            background: radial-gradient(circle at center,
                    rgba(255, 215, 0, 0.3) 0%,
                    transparent 70%);
        }

        .screen-flash.bomb {
            background: radial-gradient(circle at center,
                    rgba(255, 71, 87, 0.4) 0%,
                    transparent 70%);
        }

        @keyframes screenFlash {
            0% {
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        .game-board {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, auto);
            gap: 12px;
            padding: 18px;
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
            justify-content: center;
            align-content: center;
            position: relative;
        }

        .game-board::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 30% 70%,
                    rgba(74, 144, 226, 0.05) 0%,
                    transparent 50%),
                radial-gradient(circle at 70% 30%,
                    rgba(80, 227, 194, 0.05) 0%,
                    transparent 50%),
                radial-gradient(circle at 50% 50%,
                    rgba(255, 215, 0, 0.02) 0%,
                    transparent 60%);
            border-radius: 20px;
            pointer-events: none;
            z-index: 0;
            animation: backgroundPulse 8s ease-in-out infinite;
        }

        @keyframes backgroundPulse {

            0%,
            100% {
                opacity: 0.6;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.02);
            }
        }

        .hole {
            position: relative;
            background: radial-gradient(ellipse at center,
                    #1A1A1D 0%,
                    #0F0F12 40%,
                    #000000 85%,
                    #000000 100%);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            aspect-ratio: 1 / 1;
            width: 100%;
            max-width: 125px;
            height: auto;
            margin: 0 auto;
            box-shadow:
                inset 0 12px 24px rgba(0, 0, 0, 0.8),
                inset 0 -2px 6px rgba(255, 255, 255, 0.05),
                0 4px 12px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(58, 58, 66, 0.3);
            z-index: 1;
        }

        .hole::before {
            content: '';
            position: absolute;
            top: 15%;
            left: 15%;
            right: 15%;
            bottom: 15%;
            background: radial-gradient(ellipse at center,
                    rgba(0, 0, 0, 0.9) 0%,
                    transparent 70%);
            border-radius: 50%;
            transition: all 0.3s;
        }

        .hole:hover {
            transform: scale(1.08);
            box-shadow:
                inset 0 12px 24px rgba(0, 0, 0, 0.9),
                inset 0 -2px 6px rgba(255, 255, 255, 0.08),
                0 6px 20px rgba(0, 0, 0, 0.4),
                0 0 15px rgba(74, 144, 226, 0.1);
            border-color: rgba(74, 144, 226, 0.2);
        }

        .hole:hover::before {
            background: radial-gradient(ellipse at center,
                    rgba(0, 0, 0, 0.95) 0%,
                    transparent 60%);
        }

        /* --- ENHANCED MOLE ANIMATIONS --- */
        .mole {
            position: absolute;
            width: 78%;
            height: 78%;
            bottom: 6%;
            left: 11%;
            cursor: pointer;
            z-index: 20;
            opacity: 0;
            transform: scale(0.3) translateY(20px);
            pointer-events: none;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.4));
            transition: filter 0.3s;
        }

        .mole.active {
            animation: molePopUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            pointer-events: auto;
        }

        .mole.hiding {
            animation: molePopDown 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards !important;
            pointer-events: none;
        }

        .mole.hit {
            animation: moleHitEffect 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards !important;
            pointer-events: none;
        }

        .mole:hover {
            filter: drop-shadow(0 6px 16px rgba(0, 0, 0, 0.5)) drop-shadow(0 0 12px rgba(74, 144, 226, 0.2));
            /* Remove transform animation to prevent conflict with hide animation */
        }

        @keyframes molePopUp {
            0% {
                opacity: 0;
                transform: scale(0.3) translateY(20px) rotate(-5deg);
                filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.2));
            }

            60% {
                opacity: 1;
                transform: scale(1.1) translateY(-2px) rotate(2deg);
                filter: drop-shadow(0 6px 16px rgba(0, 0, 0, 0.5));
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0px) rotate(0deg);
                filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.4));
            }
        }

        @keyframes molePopDown {
            0% {
                opacity: 1;
                transform: scale(1) translateY(0px) rotate(0deg);
                filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.4));
            }

            40% {
                opacity: 0.8;
                transform: scale(0.9) translateY(5px) rotate(-2deg);
                filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
            }

            100% {
                opacity: 0;
                transform: scale(0.3) translateY(20px) rotate(-5deg);
                filter: drop-shadow(0 1px 4px rgba(0, 0, 0, 0.2));
            }
        }

        @keyframes moleHitEffect {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
                filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.4));
            }

            25% {
                transform: scale(1.3) rotate(-10deg);
                opacity: 1;
                filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.6)) drop-shadow(0 0 20px rgba(255, 215, 0, 0.4));
            }

            50% {
                transform: scale(1.1) rotate(5deg);
                opacity: 0.8;
                filter: drop-shadow(0 6px 16px rgba(0, 0, 0, 0.5)) drop-shadow(0 0 15px rgba(255, 215, 0, 0.3));
            }

            100% {
                transform: scale(0) rotate(25deg);
                opacity: 0;
                filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.2));
            }
        }

        /* --- Mole Body Parts (Unchanged) --- */
        .mole-body {
            position: absolute;
            width: 100%;
            height: 100%;
            background: var(--mole-body);
            border-radius: 50%;
            box-shadow: inset 0 -10px 15px rgba(0, 0, 0, 0.2);
            z-index: 2;
            animation: moleBodyBreath 3s ease-in-out infinite;
        }

        @keyframes moleBodyBreath {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        .mole-belly {
            position: absolute;
            width: 70%;
            height: 60%;
            background: var(--mole-belly);
            border-radius: 50%;
            bottom: 5%;
            left: 15%;
        }

        .eye {
            position: absolute;
            width: 22%;
            height: 22%;
            background: white;
            border-radius: 50%;
            top: 25%;
            border: 2px solid #333;
            transition: all 0.2s ease;
            animation: eyeBlink 4s ease-in-out infinite;
        }

        .eye.left {
            left: 20%;
        }

        .eye.right {
            right: 20%;
        }

        .pupil {
            position: absolute;
            width: 50%;
            height: 50%;
            background: black;
            border-radius: 50%;
            top: 25%;
            left: 25%;
            transition: all 0.3s ease;
            animation: pupilMove 6s ease-in-out infinite;
        }

        .pupil::after {
            content: '';
            position: absolute;
            width: 30%;
            height: 30%;
            background: white;
            border-radius: 50%;
            top: 20%;
            left: 20%;
        }

        /* Mole expressions */
        .mole[data-type="danger"] .pupil {
            animation: pupilAlert 2s ease-in-out infinite;
        }

        .mole[data-type="safe"] .pupil {
            animation: pupilCalm 3s ease-in-out infinite;
        }

        .mole[data-type="bomb"] .eye {
            animation: eyeScared 1s ease-in-out infinite;
        }

        .mole[data-type="bonus"] .eye {
            animation: eyeHappy 1.5s ease-in-out infinite;
        }

        @keyframes eyeBlink {

            0%,
            90%,
            100% {
                height: 22%;
                top: 25%;
            }

            95% {
                height: 2%;
                top: 36%;
            }
        }

        @keyframes pupilMove {

            0%,
            100% {
                left: 25%;
                top: 25%;
            }

            25% {
                left: 35%;
                top: 25%;
            }

            50% {
                left: 25%;
                top: 35%;
            }

            75% {
                left: 15%;
                top: 25%;
            }
        }

        @keyframes pupilAlert {

            0%,
            100% {
                transform: scale(1.2);
                left: 20%;
            }

            50% {
                transform: scale(1.3);
                left: 30%;
            }
        }

        @keyframes pupilCalm {

            0%,
            100% {
                transform: scale(0.9);
            }

            50% {
                transform: scale(1);
            }
        }

        @keyframes eyeScared {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.3);
            }
        }

        @keyframes eyeHappy {

            0%,
            100% {
                border-radius: 50%;
            }

            50% {
                border-radius: 50% 50% 0% 0%;
                transform: scaleY(0.7);
            }
        }

        .nose {
            position: absolute;
            width: 18%;
            height: 14%;
            background: var(--mole-nose);
            border-radius: 50%;
            top: 48%;
            left: 41%;
            box-shadow: inset 0 2px 3px rgba(255, 255, 255, 0.5);
        }

        .ear {
            position: absolute;
            width: 20%;
            height: 20%;
            background: var(--mole-body);
            border: 2px solid #5d4037;
            border-radius: 50%;
            top: 15%;
            z-index: 1;
        }

        .ear.left {
            left: 10%;
        }

        .ear.right {
            right: 10%;
        }

        .paw {
            position: absolute;
            width: 25%;
            height: 20%;
            background: var(--mole-body);
            border-radius: 40% 40% 50% 50%;
            bottom: -5%;
            box-shadow: inset 0 -3px 5px rgba(0, 0, 0, 0.2);
            z-index: 21;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            padding: 0 2px 1px;
        }

        .paw.left {
            left: 15%;
            transform: rotate(-15deg);
        }

        .paw.right {
            right: 15%;
            transform: rotate(15deg);
        }

        .claw {
            width: 20%;
            height: 40%;
            background-color: var(--claw-color);
            border-radius: 2px 2px 0 0;
        }

        /* --- Helmet (Unchanged) --- */
        .helmet {
            position: absolute;
            width: 80%;
            height: 35%;
            background: linear-gradient(145deg, #FFD700, #FFA500);
            border: 2px solid #FF8C00;
            border-radius: 50% 50% 25% 25%;
            box-shadow:
                0 2px 0 #FF8C00 inset,
                0 -2px 0 #FFFF99 inset,
                0 2px 6px rgba(0, 0, 0, 0.3);
            top: 0%;
            left: 10%;
            z-index: 5;
        }

        .head-icon {
            position: absolute;
            top: -25%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.2rem;
            z-index: 30;
            text-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
            /* Adjusted for dark theme */
            pointer-events: none;
        }

        .item-indicator {
            position: absolute;
            top: -55%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-bg);
            border: 3px solid var(--accent-blue);
            border-radius: 20px;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            white-space: nowrap;
            /* 将物品文字改为白色以提高可见性 */
            color: #fff;
            width: auto;
            max-width: none;
            min-width: 80px;
            overflow: visible;
            text-overflow: clip;
            z-index: 30;
        }

        .mole[data-type="bonus"] .item-indicator,
        .mole[data-type="bomb"] .item-indicator {
            display: none;
            /* Hide the text box for special moles */
        }

        .mole[data-type="bonus"] .head-icon,
        .mole[data-type="bomb"] .head-icon {
            top: -25%;
        }

        .mole[data-type="bonus"] .item-indicator {
            border-color: var(--gold);
            animation: goldShine 1.5s infinite;
        }

        .mole[data-type="bomb"] .item-indicator {
            border-color: var(--bomb-red);
            animation: bombPulse 1s infinite;
        }

        @keyframes goldShine {

            0%,
            100% {
                box-shadow: 0 0 15px var(--gold);
            }

            50% {
                box-shadow: 0 0 5px var(--gold);
            }
        }

        @keyframes bombPulse {

            0%,
            100% {
                transform: translateX(-50%) scale(1);
            }

            50% {
                transform: translateX(-50%) scale(1.1);
            }
        }

        .score-float {
            position: absolute;
            font-size: 1.8rem;
            font-weight: 700;
            pointer-events: none;
            z-index: 150;
            opacity: 1;
            white-space: nowrap;
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            animation: scoreFloatEffect 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
        }

        .score-float.positive {
            background: var(--accent-green-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: drop-shadow(0 0 8px rgba(80, 227, 194, 0.6));
        }

        .score-float.negative {
            background: var(--accent-red-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: drop-shadow(0 0 8px rgba(233, 69, 96, 0.6));
        }

        .score-float::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: inherit;
            filter: blur(4px);
            opacity: 0.5;
            z-index: -1;
        }

        @keyframes scoreFloatEffect {
            0% {
                transform: translate(-50%, 0) scale(0.8);
                opacity: 0;
            }

            20% {
                transform: translate(-50%, -10px) scale(1.2);
                opacity: 1;
            }

            40% {
                transform: translate(-50%, -20px) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -60px) scale(0.9);
                opacity: 0;
            }
        }

        /* --- Game End Page Styles --- */
        .game-end {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(30, 60, 114, 0.95) 0%, rgba(42, 82, 152, 0.95) 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 24px;
        }

        .game-end h2 {
            font-size: 2rem;
            margin-bottom: 15px;
            color: white;
            text-align: center;
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .game-end .final-score-container {
            text-align: center;
            margin-bottom: 10px;
        }

        .game-end .final-score {
            font-size: 4rem;
            color: white;
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            font-weight: 700;
            animation: scoreReveal 1s ease-out forwards;
            text-shadow: 0 0 20px var(--accent-blue), 2px 2px 4px rgba(0, 0, 0, 0.8);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        @keyframes scoreReveal {
            0% {
                transform: scale(0.5) rotate(-10deg);
                opacity: 0;
                filter: drop-shadow(0 0 5px rgba(74, 144, 226, 0.3));
            }

            50% {
                transform: scale(1.2) rotate(5deg);
                opacity: 1;
                filter: drop-shadow(0 0 30px rgba(74, 144, 226, 0.8));
            }

            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
                filter: drop-shadow(0 0 20px rgba(74, 144, 226, 0.6));
            }
        }

        .new-high-score {
            font-size: 1.2rem;
            color: var(--gold);
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            font-weight: 600;
            animation: newHighScoreGlow 1.5s infinite;
        }

        @keyframes newHighScoreGlow {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
                text-shadow: 0 0 15px var(--gold);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.1);
                text-shadow: 0 0 5px var(--gold);
            }
        }

        .game-end-comment {
            font-size: 1.6rem;
            color: white;
            margin-bottom: 20px;
            text-align: center;
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            font-weight: 500;
            animation: commentFadeIn 0.8s ease-out 0.5s forwards;
            opacity: 0;
            text-shadow: 0 0 10px var(--accent-green), 2px 2px 4px rgba(0, 0, 0, 0.8);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        @keyframes commentFadeIn {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- AUDIO VISUALIZATION --- */
        .audio-wave {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            align-items: flex-end;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 60;
        }

        .audio-wave.active {
            opacity: 0.7;
        }

        .wave-bar {
            width: 3px;
            background: var(--accent-blue-gradient);
            border-radius: 2px;
            animation: waveAnimation 0.6s ease-in-out infinite;
        }

        .wave-bar:nth-child(1) {
            height: 8px;
            animation-delay: 0s;
        }

        .wave-bar:nth-child(2) {
            height: 12px;
            animation-delay: 0.1s;
        }

        .wave-bar:nth-child(3) {
            height: 16px;
            animation-delay: 0.2s;
        }

        .wave-bar:nth-child(4) {
            height: 12px;
            animation-delay: 0.3s;
        }

        .wave-bar:nth-child(5) {
            height: 8px;
            animation-delay: 0.4s;
        }

        @keyframes waveAnimation {

            0%,
            100% {
                transform: scaleY(0.3);
            }

            50% {
                transform: scaleY(1);
            }
        }

        /* --- ACHIEVEMENT SYSTEM --- */
        .achievement-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg,
                    var(--tertiary-bg) 0%,
                    var(--secondary-bg) 100%);
            border: 2px solid var(--gold);
            border-radius: 15px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-strong), var(--glow-gold);
            transform: translateX(100%);
            opacity: 0;
            z-index: 300;
            backdrop-filter: blur(15px);
            animation: achievementSlideIn 0.5s ease-out forwards;
        }

        .achievement-popup.hide {
            animation: achievementSlideOut 0.5s ease-in forwards;
        }

        .achievement-icon {
            font-size: 2rem;
            animation: achievementIconSpin 2s ease-in-out infinite;
        }

        .achievement-text {
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            color: var(--text-primary);
        }

        .achievement-title {
            font-size: 1.1rem;
            margin-bottom: 2px;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .achievement-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
        }

        @keyframes achievementSlideIn {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }

            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes achievementSlideOut {
            0% {
                transform: translateX(0);
                opacity: 1;
            }

            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes achievementIconSpin {

            0%,
            100% {
                transform: rotate(0deg) scale(1);
            }

            25% {
                transform: rotate(-10deg) scale(1.1);
            }

            50% {
                transform: rotate(0deg) scale(1.2);
            }

            75% {
                transform: rotate(10deg) scale(1.1);
            }
        }

        /* --- STREAK INDICATOR --- */
        .streak-indicator {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 45;
        }

        .streak-indicator.active {
            opacity: 1;
        }

        .streak-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--ui-border);
            transition: all 0.3s;
        }

        .streak-dot.filled {
            background: var(--gold-gradient);
            box-shadow: 0 0 8px var(--gold);
            transform: scale(1.2);
        }

        /* --- POWER-UP EFFECTS --- */
        .power-up-glow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            pointer-events: none;
            z-index: 15;
            opacity: 0;
            animation: powerUpPulse 1s ease-in-out infinite;
        }

        .power-up-glow.bonus {
            background: radial-gradient(circle,
                    rgba(255, 215, 0, 0.3) 0%,
                    rgba(255, 215, 0, 0.1) 50%,
                    transparent 100%);
            box-shadow: 0 0 20px var(--gold);
        }

        .power-up-glow.active {
            opacity: 1;
        }

        @keyframes powerUpPulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.3;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
        }

        .buttons-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding: 0 15px;
            max-width: 90%;
        }

        .btn-restart,
        .btn-home,
        .btn-share {
            border: none;
            padding: 16px 32px;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 30px;
            color: white;
            cursor: pointer;
            margin: 10px;
            width: 100%;
            max-width: 260px;
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .btn-restart {
            background: var(--accent-blue-gradient);
            box-shadow: var(--shadow-medium), var(--glow-blue);
        }

        .btn-home {
            background: var(--accent-green-gradient);
            box-shadow: var(--shadow-medium), var(--glow-green);
        }

        .btn-share {
            background: linear-gradient(135deg,
                    var(--accent-blue) 0%,
                    var(--accent-green) 50%,
                    var(--accent-blue-dark) 100%);
            box-shadow: var(--shadow-medium), 0 0 20px rgba(74, 144, 226, 0.3);
        }

        .btn-restart::before,
        .btn-home::before,
        .btn-share::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.3),
                    transparent);
            transition: left 0.6s;
        }

        .btn-restart:hover,
        .btn-home:hover,
        .btn-share:hover {
            transform: translateY(-3px) scale(1.05);
        }

        .btn-restart:hover {
            box-shadow: var(--shadow-strong), 0 0 30px rgba(74, 144, 226, 0.5);
        }

        .btn-home:hover {
            box-shadow: var(--shadow-strong), 0 0 30px rgba(80, 227, 194, 0.5);
        }

        .btn-share:hover {
            box-shadow: var(--shadow-strong), 0 0 30px rgba(74, 144, 226, 0.4);
        }

        .btn-restart:hover::before,
        .btn-home:hover::before,
        .btn-share:hover::before {
            left: 100%;
        }

        .btn-restart:active,
        .btn-home:active,
        .btn-share:active {
            transform: translateY(-1px) scale(1.02);
        }

        /* --- Help Modal Styles --- */
        .help-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            padding: 20px;
            border-radius: 24px;
        }

        .help-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            color: var(--accent-blue);
            cursor: pointer;
            z-index: 10;
            transition: transform 0.3s;
        }

        .help-close:hover {
            transform: rotate(90deg) scale(1.2);
        }

        .help-content {
            background: rgba(248, 249, 250, 0.95);
            border-radius: 20px;
            padding: 25px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            border: 2px solid var(--accent-blue);
            width: 100%;
            color: var(--text-primary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .help-content h3 {
            color: var(--accent-blue);
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.5rem;
        }

        .help-content h4 {
            color: var(--accent-green);
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            font-weight: 500;
            margin: 15px 0 10px 0;
            font-size: 1.2rem;
        }

        .help-content ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }

        .help-content li {
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        /* --- Screenshot Modal Styles --- */
        .screenshot-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            /* Darker overlay */
            display: none;
            /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 300;
            padding: 20px;
        }

        .screenshot-modal-content {
            background: var(--secondary-bg);
            /* Dark modal */
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            border: 1px solid var(--ui-border);
        }

        .screenshot-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2rem;
            color: var(--text-secondary);
            cursor: pointer;
            line-height: 1;
        }

        .screenshot-modal p {
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 15px;
        }

        #screenshotImage {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 15px;
            border: 3px solid var(--accent-blue);
            margin-bottom: 20px;
        }

        .btn-download {
            background: linear-gradient(45deg, var(--green), var(--dark-green));
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 20px;
            color: var(--primary-bg);
            /* Dark text on light button */
            cursor: pointer;
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            text-decoration: none;
            display: inline-block;
        }

        /* --- Share Card for Screenshot (Updated to Dark Theme) --- */
        .share-card {
            position: absolute;
            left: -9999px;
            /* Keep it off-screen */
            width: 400px;
            height: 600px;
            background: linear-gradient(160deg, #2C3E50 0%, #1A1A1D 100%);
            /* New dark gradient */
            color: var(--text-primary);
            font-family: 'Noto Sans SC', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .share-card h1 {
            font-size: 2.5rem;
            text-shadow: 0 0 10px var(--accent-blue);
            margin-bottom: 10px;
            color: var(--accent-blue);
        }

        .share-card .share-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--accent-green);
            text-shadow: 0 0 15px rgba(80, 227, 194, 0.5);
        }

        .share-card .share-score {
            font-size: 6.5rem;
            font-weight: bold;
            line-height: 1;
            color: var(--gold);
            text-shadow: 3px 3px 0px rgba(0, 0, 0, 0.2), 0 0 25px var(--gold);
            margin-bottom: 15px;
        }

        .share-card .share-combo {
            font-size: 1.8rem;
            color: var(--text-primary);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px 15px;
            border-radius: 10px;
        }

        .share-card .share-combo i {
            color: var(--gold);
            margin-right: 8px;
        }

        .share-card .share-comment {
            font-size: 2rem;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin-bottom: 30px;
            color: var(--accent-green);
        }

        .share-card .share-footer {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        /* --- Responsive Optimization (Largely Unchanged) --- */
        @media (max-width: 600px) and (orientation: portrait) {
            .container {
                border-radius: 0;
                padding: 15px;
                border: none;
            }

            .page-title h1 {
                font-size: 2rem;
            }

            .rules {
                font-size: 0.9rem;
                padding: 15px;
            }

            .rules h3 {
                font-size: 1.3rem;
            }

            .btn-start {
                padding: 14px 25px;
                font-size: 1.1rem;
                max-width: 280px;
            }

            .game-board {
                gap: 8px;
                max-width: 95vw;
            }

            .item-indicator {
                font-size: 0.75rem;
                padding: 4px 8px;
                height: auto;
                top: -35%;
                width: auto;
                max-width: none;
                min-width: 70px;
                overflow: visible;
                text-overflow: clip;
            }

            .game-end h2 {
                font-size: 1.7rem;
            }

            .game-end .final-score {
                font-size: 3.5rem;
            }

            .game-end-comment {
                font-size: 1.4rem;
            }

            .btn-restart,
            .btn-home,
            .btn-share {
                max-width: 220px;
                font-size: 1rem;
                padding: 12px 20px;
            }

            /* Mobile-specific optimizations */
            #skip-story-btn {
                top: 15px;
                right: 15px;
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            #next-story-btn {
                bottom: 15px;
                right: 15px;
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            .story-slide p {
                font-size: 1rem;
                line-height: 1.6;
            }

            /* Enhanced touch targets for mobile */
            .hole {
                min-height: 60px;
                min-width: 60px;
            }

            /* Better mobile button spacing */
            #start-mole-container {
                margin-top: 25px;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .hole:active {
                transform: scale(0.95);
                transition: transform 0.1s;
            }

            #start-mole-container:active {
                transform: scale(0.95) translateY(0) !important;
            }

            .btn-restart:active,
            .btn-home:active,
            .btn-share:active {
                transform: scale(0.95);
            }
        }

        @media (max-height: 700px) {
            .rules {
                max-height: 35vh;
            }

            .game-end h2 {
                font-size: 1.5rem;
            }

            .game-end .final-score {
                font-size: 3rem;
            }

            .game-end-comment {
                font-size: 1.2rem;
            }

            .items-info {
                max-height: 25vh;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="rulePage">
            <div class="page-title">
                <h1>航空安全打鼹鼠</h1>
                <i class="fas fa-plane icon"></i>
            </div>

            <div class="high-score-display">
                <i class="fas fa-crown"></i> 最高分: <span id="highScoreDisplay">0</span>
            </div>

            <div id="story-container">
                <button id="skip-story-btn">跳过介绍</button>
                <div class="story-slide">
                    <h3>✈️ 欢迎来到云端机场，安全守护者！🛡️</h3>
                    <p data-text="你的任务 🎯，就是守护这片蓝天的安宁 ☁️✨。一群淘气的鼹鼠 🐹 正准备托运行李 🧳，但它们好像携带了一些不能托运的东西... 🤔⚠️"></p>
                </div>
                <div class="story-slide">
                    <h3>🔨 揪出捣蛋鬼！😈</h3>
                <!-- 修复文字乱码并简化描述 -->
                <p data-text="有些鼹鼠 🐹 是十足的“破坏王”，它们头顶着 🔥打火机、🔋充电宝 这类不能托运的危险物品 ⚠️... 看到它们就立刻敲下去！💥"></p>
                </div>
                <div class="story-slide">
                    <h3>🤗 放过好孩子！😇</h3>
                <!-- 修复文字内容和编码问题 -->
                <p data-text="但要小心 ⚠️，有些鼹鼠 🐹 只是想带上心爱的 🧸玩具 或 📚书籍 去度假 🏖️☀️。它们是无辜的旅客 👨‍👩‍👧‍👦 ，请放过它们哦！💕😊"></p>
                </div>
                <div class="story-slide">
                    <h3>🚨 远离大麻烦！ 💣</h3>
                    <p data-text="在这些鼹鼠 🐹 中，藏着一个真正的麻烦制造者——炸弹鼹鼠 💣😱！无论如何都 <strong>不要碰它</strong> ❌🚫！危险 ⚠️！"></p>
                </div>
                <div class="story-slide">
                    <h3>🌟 抓住幸运星！ ⭐</h3>
                    <p data-text="当然，冒险中总有惊喜 🎉✨！迅速敲击奖励鼹鼠 🐹⭐，你会获得额外的分数 📈 和宝贵的游戏时间 ⏰⏳！太棒了 🎊！"></p>
                </div>
                <div class="story-slide">
                    <h3>🎯 现在，你已了解所有秘密... 🔍</h3>
                    <p data-text="去吧，创造你的最高分传奇 🏆🌟！加油，安全守护者 💪🛡️！准备好了吗 🚀？开始你的冒险吧 🎮✈️！"></p>
                </div>
                <button id="next-story-btn">下一页 &rarr;</button>
            </div>

            <div id="start-mole-container">
                <div id="hammer-sfx">🔨</div>
                <div id="start-mole-btn">
                    <div class="ear left"></div>
                    <div class="ear right"></div>
                    <div class="mole-body">
                        <div class="mole-belly"></div>
                        <div class="eye left">
                            <div class="pupil"></div>
                        </div>
                        <div class="eye right">
                            <div class="pupil"></div>
                        </div>
                        <div class="nose"></div>
                    </div>
                </div>
                <div class="start-text">开始游戏</div>
            </div>
        </div>

        <div id="gamePage">
            <div class="game-header">
                <div class="score">
                    <i class="fas fa-star"></i>
                    <span id="scoreDisplay">0</span>
                </div>
                <div class="help-btn">
                    <i class="fas fa-question-circle"></i>
                </div>
                <div class="time">
                    <i class="fas fa-clock"></i>
                    <span id="timeDisplay">60</span>
                </div>
            </div>

            <!-- 时间进度条：根据剩余时间变化长度和颜色 -->
            <div class="time-bar-container">
                <div class="time-bar" id="timeProgressBar"></div>
            </div>

            <div class="combo-counter" id="comboCounter"></div>

            <div class="audio-wave" id="audioWave">
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
            </div>

            <div class="streak-indicator" id="streakIndicator">
                <div class="streak-dot"></div>
                <div class="streak-dot"></div>
                <div class="streak-dot"></div>
                <div class="streak-dot"></div>
                <div class="streak-dot"></div>
            </div>

            <div class="game-board" id="gameBoard">
            </div>

            <div id="gameEnd" class="game-end">
                <h2 id="endMessage">游戏结束</h2>
                <div class="final-score-container">
                    <div class="final-score" id="finalScore">0</div>
                    <div class="new-high-score" id="newHighScore" style="display: none;">新纪录! 🎉</div>
                </div>
                <div class="game-end-comment"></div>

                <div class="buttons-container">
                    <button class="btn-restart">再玩一次</button>
                    <!-- 去掉返回主页按钮以简化游戏流程 -->
                    <button class="btn-share"><i class="fas fa-camera-retro"></i> 分享战绩图</button>
                </div>
            </div>

            <div class="help-modal" id="helpModal">
                <span class="help-close"><i class="fas fa-times"></i></span>
                <div class="help-content">
                    <h3>游戏帮助</h3>
                    <p>找出不能托运的物品，确保航空安全！</p>

                    <h4>不能托运的物品（危险品）</h4>
                    <ul id="dangerItemsList"></ul>

                    <h4>可以托运的物品（安全品）</h4>
                    <ul id="safeItemsList"></ul>

                    <h4>特殊物品</h4>
                    <ul id="specialItemsList"></ul>

                    <p style="text-align: center; margin-top: 15px; color: var(--text-secondary);">
                        注意：不同航空公司可能有特殊规定，请以实际情况为准。
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="screenshotModal" class="screenshot-modal">
        <div class="screenshot-modal-content">
            <span id="screenshotClose" class="screenshot-close">&times;</span>
            <p>长按或右键保存图片分享吧！</p>
            <img id="screenshotImage" src="" alt="游戏战绩截图" />
            <a id="downloadLink" class="btn-download" download="航空安全打鼹鼠-战绩.png">下载图片</a>
        </div>
    </div>

    <div id="shareCard" class="share-card">
        <h1>我的战绩</h1>
        <i class="fas fa-plane-departure share-icon"></i>
        <div class="share-score" id="shareScore">0</div>
        <div class="share-combo">
            <i class="fas fa-bolt"></i> 最高连击: <span id="shareMaxCombo">0</span>
        </div>
        <div class="share-comment" id="shareComment">干得不错！</div>
        <p class="share-footer">航空安全打鼹鼠</p>
    </div>

    <audio id="correctSound" preload="auto">
        <!-- 修复音频资源的 URL，移除无效的前缀 -->
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>
    <audio id="wrongSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"
            type="audio/mpeg">
    </audio>
    <audio id="gameStartSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-game-show-suspense-waiting-667.mp3" type="audio/mpeg">
    </audio>
    <audio id="gameEndSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-sad-game-over-trombone-471.mp3" type="audio/mpeg">
    </audio>
    <audio id="comboSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-bonus-extra-in-a-video-game-2064.mp3"
            type="audio/mpeg">
    </audio>
    <audio id="bombSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-explosion-in-battle-2809.mp3" type="audio/mpeg">
    </audio>

    <script>
        (function () {
            // --- Game Configuration ---
            const gameConfig = {
                moleSpeed: { min: 1200, max: 2200 },
                moleUpTime: { min: 1200, max: 2000 },
                dangerProbability: 0.45,
                specialMoleProbability: 0.15,
                scores: {
                    hitDanger: 10,
                    hitSafe: -5,
                    missDanger: -3,
                    missEmpty: -3,
                    hitBomb: -25,
                    hitBonus: 20,
                },
                // 游戏时长（秒）
                gameDuration: 60,
                comboBonus: 2,
                bonusTime: 5,
            };

            // --- Item Configuration ---
            const items = [
                { type: "danger", symbol: "🔥", name: "打火机", reason: "易燃物品，禁止托运" },
                { type: "danger", symbol: "🧨", name: "火柴", reason: "易燃物品，禁止托运" },
                { type: "danger", symbol: "🔋", name: "锂电池", reason: "有起火风险，禁止托运" },
                { type: "danger", symbol: "🔌", name: "充电宝", reason: "含锂电池，禁止托运" },
                { type: "danger", symbol: "📶", name: "充电移动WIFI", reason: "含锂电池，禁止托运" },
                { type: "safe", symbol: "👕", name: "衣服", reason: "普通衣物，可托运" },
                { type: "safe", symbol: "📚", name: "书籍", reason: "普通物品，可托运" },
                { type: "safe", symbol: "🧴", name: "洗漱品", reason: "普通化妆品，可托运" },
                { type: "safe", symbol: "🧸", name: "玩具", reason: "普通玩具，可托运" },
                { type: "bomb", symbol: "💣", name: "炸弹", reason: "危险！点击会扣分！" },
                { type: "bonus", symbol: "⭐", name: "奖励星", reason: "奖励！点击加分加时间！" },
            ];

            // --- DOM Element Caching ---
            const DOM = {
                container: document.querySelector('.container'),
                rulePage: document.getElementById('rulePage'),
                gamePage: document.getElementById('gamePage'),
                startMoleContainer: document.getElementById('start-mole-container'),
                gameBoard: document.getElementById('gameBoard'),
                scoreDisplay: document.getElementById('scoreDisplay'),
                time: document.querySelector('.time'), // Cache the .time element
                timeDisplay: document.getElementById('timeDisplay'),
                gameEnd: document.getElementById('gameEnd'),
                finalScore: document.getElementById('finalScore'),
                endMessage: document.getElementById('endMessage'),
                restartBtn: document.querySelector('.btn-restart'),
                // homeBtn is removed as the return home feature is no longer needed
                btnShare: document.querySelector('.btn-share'),
                helpBtn: document.querySelector('.help-btn'),
                helpModal: document.getElementById('helpModal'),
                helpClose: document.querySelector('.help-close'),
                dangerItemsList: document.getElementById('dangerItemsList'),
                safeItemsList: document.getElementById('safeItemsList'),
                specialItemsList: document.getElementById('specialItemsList'),
                itemsInfoList: document.getElementById('itemsInfoList'),
                gameEndComment: document.querySelector('.game-end-comment'),
                highScoreDisplay: document.getElementById('highScoreDisplay'),
                newHighScore: document.getElementById('newHighScore'),
                comboCounter: document.getElementById('comboCounter'),
                screenshotModal: document.getElementById('screenshotModal'),
                screenshotImage: document.getElementById('screenshotImage'),
                screenshotClose: document.getElementById('screenshotClose'),
                downloadLink: document.getElementById('downloadLink'),
                shareCard: document.getElementById('shareCard'),
                shareScore: document.getElementById('shareScore'),
                shareComment: document.getElementById('shareComment'),
                shareMaxCombo: document.getElementById('shareMaxCombo'),
                audioWave: document.getElementById('audioWave'),
                streakIndicator: document.getElementById('streakIndicator'),
                // 进度条元素
                timeProgressBar: document.getElementById('timeProgressBar'),
            };

            // Audio elements
            const audioElements = {
                correct: document.getElementById('correctSound'),
                wrong: document.getElementById('wrongSound'),
                gameStart: document.getElementById('gameStartSound'),
                gameEnd: document.getElementById('gameEndSound'),
                combo: document.getElementById('comboSound'),
                bomb: document.getElementById('bombSound'),
            };

            // --- 自定义音效配置 ---
            // 使用 WebAudio API 生成不同频率的短音调，避免加载外部音频失败或跨域限制。
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            /**
             * 以给定频率播放简短的蜂鸣音
             * @param {number} frequency 音频频率（赫兹）
             * @param {number} duration 播放时长（秒）
             */
            function playBeep(frequency, duration = 0.3) {
                if (!audioCtx) return;
                try {
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
                    // 控制音量
                    gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + duration);
                } catch (e) {
                    console.warn('Beep error:', e);
                }
            }

            // 将每个音效对应到不同的频率和持续时间，使用更柔和的组合
            const soundFreqMap = {
                // 正确击中：中高频，短促
                correctSound: { freq: 600, duration: 0.12 },
                // 错误击中：低频，稍长
                wrongSound: { freq: 300, duration: 0.18 },
                // 游戏开始：中音，适中
                gameStartSound: { freq: 500, duration: 0.25 },
                // 游戏结束：较低频率，较长
                gameEndSound: { freq: 250, duration: 0.3 },
                // 连击提示：高音，短
                comboSound: { freq: 850, duration: 0.1 },
                // 炸弹：极低频，较长
                bombSound: { freq: 150, duration: 0.35 }
            };

            function playSound(audioElement) {
                if (!audioElement) return;
                // 使用自定义音调替代外部音频文件，提高跨域加载兼容性
                try {
                    const soundSetting = soundFreqMap[audioElement.id];
                    if (soundSetting && typeof soundSetting === 'object') {
                        playBeep(soundSetting.freq, soundSetting.duration);
                    } else {
                        // 默认音效
                        playBeep(500, 0.2);
                    }
                    // 音频波形展示
                    showAudioWave();
                } catch (e) {
                    console.warn("Error playing sound:", e);
                }
            }

            // Mobile vibration utility function
            function vibrate(pattern) {
                if ('vibrate' in navigator) {
                    try {
                        navigator.vibrate(pattern);
                    } catch (e) {
                        console.warn("Vibration failed:", e);
                    }
                }
            }

            // --- Game Variables ---
            let score = 0;
            let timeLeft = gameConfig.gameDuration;
            let gameActive = false;
            let gameTimer = null;
            let moleTimer = null;
            let currentMoles = [];
            let highScore = 0;
            let combo = 0;
            let maxCombo = 0;
            let typeInterval = null;

            // New variables for enhanced features
            let streak = 0;
            let achievements = [];
            let audioWaveTimeout = null;
            let totalHits = 0;
            let perfectHits = 0;

            // Achievement definitions
            const achievementList = [
                { id: 'first_hit', title: '初次出击', desc: '击中第一个危险鼹鼠', icon: '🎯', condition: () => totalHits >= 1 },
                { id: 'combo_master', title: '连击大师', desc: '达成5连击', icon: '⚡', condition: () => combo >= 5 },
                { id: 'perfect_10', title: '完美十击', desc: '连续击中10个危险鼹鼠', icon: '💎', condition: () => perfectHits >= 10 },
                { id: 'speed_demon', title: '闪电之手', desc: '在5秒内击中5个鼹鼠', icon: '⚡', condition: () => false }, // Special timing condition
                { id: 'high_scorer', title: '得分王', desc: '单局得分超过100', icon: '👑', condition: () => score >= 100 },
                { id: 'bomb_avoider', title: '拆弹专家', desc: '整局游戏不碰炸弹', icon: '🛡️', condition: () => false }, // Special condition
                { id: 'time_master', title: '时间管理大师', desc: '获得3次时间奖励', icon: '⏰', condition: () => false }, // Special condition
            ];

            // Achievement and audio functions
            function showAchievement(achievement) {
                const popup = document.createElement('div');
                popup.className = 'achievement-popup';
                popup.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-text">
                        <div class="achievement-title">${achievement.title}</div>
                        <div class="achievement-desc">${achievement.desc}</div>
                    </div>
                `;

                document.body.appendChild(popup);

                setTimeout(() => {
                    popup.classList.add('hide');
                    setTimeout(() => popup.remove(), 500);
                }, 3000);

                // Play achievement sound (if available)
                playSound(audioElements.combo);
                vibrate([100, 50, 100]);
            }

            function checkAchievements() {
                achievementList.forEach(achievement => {
                    if (!achievements.includes(achievement.id) && achievement.condition()) {
                        achievements.push(achievement.id);
                        showAchievement(achievement);

                        // Save to localStorage
                        localStorage.setItem('whackAMoleAchievements', JSON.stringify(achievements));
                    }
                });
            }

            function showAudioWave() {
                if (DOM.audioWave) {
                    DOM.audioWave.classList.add('active');
                    clearTimeout(audioWaveTimeout);
                    audioWaveTimeout = setTimeout(() => {
                        DOM.audioWave.classList.remove('active');
                    }, 600);
                }
            }

            function updateStreakIndicator() {
                if (DOM.streakIndicator) {
                    const dots = DOM.streakIndicator.querySelectorAll('.streak-dot');
                    dots.forEach((dot, index) => {
                        if (index < streak) {
                            dot.classList.add('filled');
                        } else {
                            dot.classList.remove('filled');
                        }
                    });

                    if (streak > 0) {
                        DOM.streakIndicator.classList.add('active');
                    } else {
                        DOM.streakIndicator.classList.remove('active');
                    }
                }
            }

            function initGameBoard() {
                DOM.gameBoard.innerHTML = '';
                for (let i = 0; i < 9; i++) {
                    const hole = document.createElement('div');
                    hole.className = 'hole';
                    hole.dataset.id = i;
                    DOM.gameBoard.appendChild(hole);
                }
            }

            function initItemsInfo() {
                DOM.dangerItemsList.innerHTML = '';
                DOM.safeItemsList.innerHTML = '';
                DOM.specialItemsList.innerHTML = '';

                items.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span style="font-size: 1.4rem;">${item.symbol}</span> ${item.name} - ${item.reason}`;
                    if (item.type === 'danger') DOM.dangerItemsList.appendChild(li);
                    else if (item.type === 'safe') DOM.safeItemsList.appendChild(li);
                    else DOM.specialItemsList.appendChild(li);
                });
            }

            function startGame() {
                DOM.rulePage.style.display = 'none';
                DOM.gamePage.style.display = 'flex';

                score = 0;
                timeLeft = gameConfig.gameDuration;
                gameActive = true;
                currentMoles = [];
                combo = 0;
                maxCombo = 0;

                // Reset new variables
                streak = 0;
                totalHits = 0;
                perfectHits = 0;

                updateScore();
                updateTime();
                updateComboDisplay();

                DOM.gameEnd.style.display = 'none';
                DOM.newHighScore.style.display = 'none';

                initGameBoard();
                createMoles();

                clearInterval(gameTimer);
                gameTimer = setInterval(() => {
                    if (gameActive) {
                        timeLeft--;
                        updateTime();
                        if (timeLeft <= 0) {
                            endGame('时间到！');
                        }
                    }
                }, 1000);

                playSound(audioElements.gameStart);
            }

            function updateScore() { if (DOM.scoreDisplay) DOM.scoreDisplay.textContent = score; }
            function updateTime() {
                if (DOM.timeDisplay) {
                    DOM.timeDisplay.textContent = timeLeft;

                    // 更新时间进度条宽度与颜色
                    if (DOM.timeProgressBar && gameConfig && gameConfig.gameDuration) {
                        const percent = Math.max(0, timeLeft / gameConfig.gameDuration);
                        DOM.timeProgressBar.style.width = `${percent * 100}%`;
                        // 根据剩余时间调整颜色：绿色 >50%，金色 >25%，红色其余
                        let barColor;
                        if (percent > 0.5) {
                            barColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-green');
                        } else if (percent > 0.25) {
                            barColor = getComputedStyle(document.documentElement).getPropertyValue('--gold');
                        } else {
                            barColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-red');
                        }
                        // 去除可能的空格
                        DOM.timeProgressBar.style.background = barColor ? barColor.trim() : '';
                    }

                    // Add time warning effects
                    DOM.time.classList.remove('warning', 'critical');
                    if (timeLeft <= 5) {
                        DOM.time.classList.add('critical');
                    } else if (timeLeft <= 15) {
                        DOM.time.classList.add('warning');
                    }
                }
            }

            function updateComboDisplay() {
                if (combo > maxCombo) {
                    maxCombo = combo;
                }
                if (combo > 1) {
                    const comboText = `x${combo} Combo!`;
                    DOM.comboCounter.textContent = comboText;
                    DOM.comboCounter.setAttribute('data-text', comboText);
                    DOM.comboCounter.classList.add('active');
                } else {
                    DOM.comboCounter.classList.remove('active');
                }
            }

            function resetCombo() {
                combo = 0;
                updateComboDisplay();
                // Don't reset streak here as it's handled separately
            }

            function createMoles() {
                if (!gameActive) {
                    clearTimeout(moleTimer);
                    return;
                }
                clearTimeout(moleTimer);

                if (currentMoles.length >= 3) {
                    moleTimer = setTimeout(createMoles, 200);
                    return;
                }

                const availableHoles = Array.from(document.querySelectorAll('.hole')).filter(hole => !hole.querySelector('.mole'));
                if (availableHoles.length === 0) {
                    moleTimer = setTimeout(createMoles, 300);
                    return;
                }

                const randomIndex = Math.floor(Math.random() * availableHoles.length);
                const hole = availableHoles[randomIndex];

                const rand = Math.random();
                let itemType;
                if (rand < gameConfig.specialMoleProbability) {
                    itemType = Math.random() < 0.5 ? 'bomb' : 'bonus';
                } else {
                    itemType = Math.random() < gameConfig.dangerProbability ? 'danger' : 'safe';
                }

                const itemsOfType = items.filter(item => item.type === itemType);
                const randomItem = itemsOfType[Math.floor(Math.random() * itemsOfType.length)];

                const mole = document.createElement('div');
                mole.className = 'mole';
                mole.dataset.id = hole.dataset.id;
                mole.dataset.type = randomItem.type;
                mole.dataset.name = randomItem.name;

                let helmetHTML = '';
                if (randomItem.type === 'safe' || randomItem.type === 'danger') {
                    helmetHTML = '<div class="helmet"></div>';
                }

                // Add power-up glow for bonus moles
                let powerUpGlow = '';
                if (randomItem.type === 'bonus') {
                    powerUpGlow = '<div class="power-up-glow bonus active"></div>';
                }

                mole.innerHTML = `
                    ${powerUpGlow}
                    <div class="item-indicator">
                        <span>${randomItem.symbol} ${randomItem.name}</span>
                    </div>
                    <div class="head-icon"></div>
                    ${helmetHTML}
                    <div class="paw left"><div class="claw"></div><div class="claw"></div><div class="claw"></div></div>
                    <div class="paw right"><div class="claw"></div><div class="claw"></div><div class="claw"></div></div>
                    <div class="ear left"></div>
                    <div class="ear right"></div>
                    <div class="mole-body">
                        <div class="mole-belly"></div>
                        <div class="eye left"><div class="pupil"></div></div>
                        <div class="eye right"><div class="pupil"></div></div>
                        <div class="nose"></div>
                    </div>
                `;
                hole.appendChild(mole);

                const headIcon = mole.querySelector('.head-icon');
                if (randomItem.type === 'bonus') {
                    headIcon.textContent = '⭐';
                } else if (randomItem.type === 'bomb') {
                    headIcon.textContent = '💣';
                } else {
                    headIcon.textContent = randomItem.symbol;
                }

                mole.classList.add('active');

                const speedFactor = 1 - (score / 500);
                const upTimeFactor = Math.max(0.5, speedFactor);
                const moleUpTime = (gameConfig.moleUpTime.min + Math.random() * (gameConfig.moleUpTime.max - gameConfig.moleUpTime.min)) * upTimeFactor;

                const moleTimeout = setTimeout(() => {
                    if (mole.classList.contains('active')) {
                        mole.classList.remove('active');
                        mole.classList.add('hiding');
                        mole.addEventListener('animationend', () => {
                            if (hole.contains(mole)) mole.remove();
                        }, { once: true });

                        const index = currentMoles.findIndex(m => m.mole === mole);
                        if (index !== -1) currentMoles.splice(index, 1);

                        if (randomItem.type === 'danger' && gameActive) {
                            updateScoreValue(gameConfig.scores.missDanger, mole.querySelector('.item-indicator'), `漏掉${randomItem.name}`);
                            resetCombo();
                        }
                    }
                }, moleUpTime);

                currentMoles.push({ id: hole.dataset.id, mole, hole, type: randomItem.type, item: randomItem, timer: moleTimeout });

                const nextMoleInterval = (gameConfig.moleSpeed.min + Math.random() * (gameConfig.moleSpeed.max - gameConfig.moleSpeed.min)) * Math.max(0.4, speedFactor);
                moleTimer = setTimeout(createMoles, nextMoleInterval);
            }

            // Particle effects functions
            function createParticles(x, y, type, count = 8) {
                // Limit the number of particles to improve performance
                count = Math.min(count, 6);
                for (let i = 0; i < count; i++) {
                    const particle = document.createElement('div');
                    particle.className = `particle ${type}`;

                    const size = Math.random() * 6 + 4;
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.left = `${x}px`;
                    particle.style.top = `${y}px`;

                    const angle = (Math.PI * 2 * i) / count;
                    const velocity = Math.random() * 50 + 30;
                    const vx = Math.cos(angle) * velocity;
                    const vy = Math.sin(angle) * velocity;

                    particle.style.setProperty('--vx', `${vx}px`);
                    particle.style.setProperty('--vy', `${vy}px`);

                    // Update particle animation to use custom properties
                    particle.style.animation = `particleExplosion 0.8s ease-out forwards`;
                    particle.style.transform = `translate(var(--vx, 0), var(--vy, 0))`;

                    DOM.gamePage.appendChild(particle);

                    setTimeout(() => particle.remove(), 800);
                }
            }

            function createRipple(x, y, type) {
                const ripple = document.createElement('div');
                ripple.className = `hit-ripple ${type}`;
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;

                DOM.gamePage.appendChild(ripple);
                setTimeout(() => ripple.remove(), 600);
            }

            function createScreenFlash(type) {
                const flash = document.createElement('div');
                flash.className = `screen-flash ${type}`;
                document.body.appendChild(flash);
                setTimeout(() => flash.remove(), 300);
            }

            function updateScoreValue(delta, element, feedbackText = '') {
                if (!gameActive || !DOM.scoreDisplay) return;

                score += delta;
                if (score < 0) score = 0;
                updateScore();

                if (delta > 0) playSound(audioElements.correct);
                else if (delta < 0) playSound(audioElements.wrong);

                if (element) {
                    const scoreFloat = document.createElement('div');
                    scoreFloat.textContent = `${delta > 0 ? '+' : ''}${delta} ${feedbackText}`.trim();
                    scoreFloat.className = `score-float ${delta >= 0 ? 'positive' : 'negative'}`;

                    const rect = element.getBoundingClientRect();
                    const gameRect = DOM.gamePage.getBoundingClientRect();

                    scoreFloat.style.left = `${rect.left - gameRect.left + rect.width / 2}px`;
                    scoreFloat.style.top = `${rect.top - gameRect.top}px`;

                    DOM.gamePage.appendChild(scoreFloat);
                    scoreFloat.addEventListener('animationend', () => scoreFloat.remove());
                }
            }

            function handleGameClick(e) {
                if (!gameActive) return;

                const target = e.target.closest('.mole');
                if (target) {
                    const moleElement = target;
                    const moleType = moleElement.dataset.type;
                    const moleName = moleElement.dataset.name;
                    const holeId = moleElement.dataset.id;
                    const moleIndex = currentMoles.findIndex(m => m.id === holeId);
                    if (moleIndex === -1 || moleElement.classList.contains('hit')) return;

                    moleElement.classList.add('hit');
                    clearTimeout(currentMoles[moleIndex].timer);

                    const indicator = moleElement.querySelector('.item-indicator');

                    // Get mole position for effects
                    const moleRect = moleElement.getBoundingClientRect();
                    const gameRect = DOM.gamePage.getBoundingClientRect();
                    const effectX = moleRect.left - gameRect.left + moleRect.width / 2;
                    const effectY = moleRect.top - gameRect.top + moleRect.height / 2;

                    if (moleType === 'danger') {
                        combo++;
                        streak++;
                        totalHits++;
                        perfectHits++;

                        const comboBonus = (combo > 1) ? (combo - 1) * gameConfig.comboBonus : 0;
                        updateScoreValue(gameConfig.scores.hitDanger + comboBonus, indicator, `击中${moleName}`);

                        // Visual effects
                        createParticles(effectX, effectY, 'success', 6);
                        createRipple(effectX, effectY, 'success');
                        showAudioWave();
                        updateStreakIndicator();

                        if (combo > 1) {
                            playSound(audioElements.combo);
                            createScreenFlash('combo');
                        }

                        // Check achievements
                        checkAchievements();

                        // Light vibration for correct hit
                        vibrate(50);
                    } else if (moleType === 'safe') {
                        updateScoreValue(gameConfig.scores.hitSafe, indicator, `错误点击${moleName}`);
                        resetCombo();
                        streak = 0;
                        perfectHits = 0;

                        // Visual effects
                        createParticles(effectX, effectY, 'error', 4);
                        createRipple(effectX, effectY, 'error');
                        showAudioWave();
                        updateStreakIndicator();

                        // Medium vibration for wrong hit
                        vibrate(100);
                    } else if (moleType === 'bomb') {
                        updateScoreValue(gameConfig.scores.hitBomb, indicator, `击中${moleName}`);
                        // 重置连击和完美击中次数
                        resetCombo();
                        streak = 0;
                        perfectHits = 0;
                        updateStreakIndicator();
                        playSound(audioElements.bomb);

                        // Visual effects
                        createParticles(effectX, effectY, 'error', 12);
                        createRipple(effectX, effectY, 'error');
                        createScreenFlash('bomb');

                        DOM.container.classList.add('shake');
                        setTimeout(() => DOM.container.classList.remove('shake'), 400);

                        // Strong vibration for bomb hit
                        vibrate([200, 100, 200]);
                    } else if (moleType === 'bonus') {
                        updateScoreValue(gameConfig.scores.hitBonus, indicator, `奖励！`);
                        timeLeft += gameConfig.bonusTime;
                        updateTime();
                        playSound(audioElements.combo);

                        // Visual effects
                        createParticles(effectX, effectY, 'bonus', 10);
                        createRipple(effectX, effectY, 'bonus');
                        createScreenFlash('success');

                        // Add bonus effect to time display
                        DOM.time.classList.add('bonus-effect');
                        DOM.time.addEventListener('animationend', () => {
                            DOM.time.classList.remove('bonus-effect');
                        }, { once: true });

                        // 更新连击指示器（奖励不会改变 streak，但确保 UI 同步）
                        updateStreakIndicator();
                        // Pleasant vibration for bonus
                        vibrate([50, 50, 50]);
                    }

                    updateComboDisplay();

                    moleElement.addEventListener('animationend', () => {
                        moleElement.remove();
                    }, { once: true });

                    currentMoles.splice(moleIndex, 1);

                } else if (e.target.closest('.hole')) {
                    updateScoreValue(gameConfig.scores.missEmpty, e.target.closest('.hole'), "空击");
                    resetCombo();
                }
            }

            function endGame(message) {
                gameActive = false;
                clearInterval(gameTimer);
                clearTimeout(moleTimer);

                currentMoles.forEach(moleInfo => {
                    clearTimeout(moleInfo.timer);
                    if (moleInfo.mole && moleInfo.mole.parentNode) moleInfo.mole.remove();
                });
                currentMoles = [];

                document.querySelectorAll('.score-float').forEach(el => el.remove());

                if (score > highScore) {
                    highScore = score;
                    localStorage.setItem('whackAMoleHighScore', highScore);
                    DOM.newHighScore.style.display = 'block';
                }

                if (DOM.finalScore) DOM.finalScore.textContent = score;
                if (DOM.endMessage) DOM.endMessage.textContent = message;

                let commentText = '';
                if (score >= 250) commentText = '🏆 你是航空安全之神！';
                else if (score >= 150) commentText = '🌟 安全专家，太棒了！';
                else if (score >= 100) commentText = '👍 干得不错，再接再厉！';
                else if (score >= 50) commentText = '💪 继续努力，安全从我做起！';
                else commentText = '😊 没关系，多练习几次会更好的！';

                if (DOM.gameEndComment) DOM.gameEndComment.textContent = commentText;

                if (DOM.gameEnd) DOM.gameEnd.style.display = 'flex';
                playSound(audioElements.gameEnd);
            }

            function returnHome() {
                DOM.gameEnd.style.display = 'none';
                DOM.gamePage.style.display = 'none';
                DOM.rulePage.style.display = 'flex';

                gameActive = false;
                clearInterval(gameTimer);
                clearTimeout(moleTimer);
                currentMoles = [];

                document.querySelectorAll('.mole, .score-float').forEach(el => el.remove());
                loadHighScore();
                setupStorySlides();
            }

            function toggleHelpModal() {
                if (DOM.helpModal) {
                    DOM.helpModal.style.display = DOM.helpModal.style.display === 'flex' ? 'none' : 'flex';
                }
            }

            function loadHighScore() {
                highScore = localStorage.getItem('whackAMoleHighScore') || 0;
                DOM.highScoreDisplay.textContent = highScore;

                // Load achievements
                const savedAchievements = localStorage.getItem('whackAMoleAchievements');
                if (savedAchievements) {
                    achievements = JSON.parse(savedAchievements);
                }
            }

            function displayImageForManualSave(dataUrl) {
                DOM.screenshotImage.src = dataUrl;
                DOM.downloadLink.href = dataUrl;
                DOM.screenshotModal.style.display = 'flex';
            }

            async function shareResultAsImage() {
                const shareButton = DOM.btnShare;
                const originalButtonHTML = shareButton.innerHTML;
                shareButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
                shareButton.disabled = true;

                // Populate the hidden share card with the current results
                DOM.shareScore.textContent = score;
                DOM.shareComment.textContent = DOM.gameEndComment.textContent;
                DOM.shareMaxCombo.textContent = maxCombo;

                try {
                    const canvas = await html2canvas(DOM.shareCard, {
                        useCORS: true,
                        backgroundColor: null
                    });

                    const imageFileName = `航空安全打鼹鼠-战绩.png`;

                    canvas.toBlob(async (blob) => {
                        if (!blob) {
                            console.error("Canvas to Blob conversion failed.");
                            displayImageForManualSave(canvas.toDataURL('image/png'));
                            return;
                        }

                        const file = new File([blob], imageFileName, { type: 'image/png' });
                        const shareData = {
                            files: [file],
                            title: '快来玩航空安全打鼹鼠！',
                            text: `我在这款游戏中获得了 ${score} 分，最高连击 ${maxCombo} 次！你也来挑战一下吧！`,
                        };

                        if (navigator.share) {
                            try {
                                await navigator.share(shareData);
                                return;
                            } catch (err) {
                                if (err.name === 'AbortError') {
                                    return;
                                }
                                // console.log('原生分享失败，尝试备用方案:', err);
                            }
                        }

                        displayImageForManualSave(canvas.toDataURL('image/png'));

                    }, 'image/png');

                } catch (error) {
                    console.error('Error generating canvas:', error);
                    alert('生成分享图片失败，请重试');
                } finally {
                    shareButton.innerHTML = originalButtonHTML;
                    shareButton.disabled = false;
                }
            }

            function debounce(func, delay) {
                let timeout;
                return function (...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            }

            const adjustGamePageHeight = debounce(() => {
                if (DOM.container && DOM.gamePage) {
                    const containerHeight = DOM.container.clientHeight;
                    DOM.gamePage.style.height = `${containerHeight - 40}px`;
                }
            }, 100);

            // --- Story Slideshow Logic ---
            let currentSlide = 0;
            let slides;
            let nextStoryBtn;

            function typeWriter(element, text, onComplete) {
                let i = 0;
                element.innerHTML = '';
                nextStoryBtn.classList.remove('visible');
                clearInterval(typeInterval);

                typeInterval = setInterval(() => {
                    if (i < text.length) {
                        element.innerHTML = text.substring(0, i + 1) + '<span class="typing-cursor">|</span>';
                        i++;
                    } else {
                        clearInterval(typeInterval);
                        element.innerHTML = text; // Remove cursor when done
                        if (onComplete) {
                            onComplete();
                        }
                    }
                }, 150); // Adjust typing speed here
            }

            function setupStorySlides() {
                slides = document.querySelectorAll('.story-slide');
                nextStoryBtn = document.getElementById('next-story-btn');
                const skipStoryBtn = document.getElementById('skip-story-btn');

                /* console.log('Setup story slides:', {
                    slides: slides.length,
                    nextStoryBtn: !!nextStoryBtn,
                    skipStoryBtn: !!skipStoryBtn
                }); */

                if (!slides.length || !nextStoryBtn) return;

                currentSlide = 0;
                slides.forEach((slide, index) => {
                    slide.classList.toggle('active', index === 0);
                });

                // Hide start button initially
                DOM.startMoleContainer.classList.remove('story-complete');

                const firstSlideP = slides[0].querySelector('p');
                typeWriter(firstSlideP, firstSlideP.dataset.text, () => {
                    if (currentSlide < slides.length - 1) {
                        nextStoryBtn.classList.add('visible');
                    }
                });

                nextStoryBtn.removeEventListener('click', showNextSlide);
                nextStoryBtn.addEventListener('click', showNextSlide);

                // Add skip button functionality
                if (skipStoryBtn) {
                    /* console.log('Adding skip button listener'); */
                    skipStoryBtn.removeEventListener('click', skipToEnd);
                    skipStoryBtn.addEventListener('click', skipToEnd);
                } else {
                    /* console.error('Skip button not found!'); */
                }
            }

            function showNextSlide() {
                if (currentSlide >= slides.length - 1) return;

                slides[currentSlide].classList.remove('active');
                currentSlide++;
                slides[currentSlide].classList.add('active');

                const newSlideP = slides[currentSlide].querySelector('p');
                typeWriter(newSlideP, newSlideP.dataset.text, () => {
                    if (currentSlide < slides.length - 1) {
                        nextStoryBtn.classList.add('visible');
                    } else {
                        // Story completed, show start button
                        showStartButton();
                    }
                });
            }

            function skipToEnd() {
                /* console.log('Skip to end called!'); */

                // Clear any ongoing typing animation
                clearInterval(typeInterval);

                // Hide all slides
                slides.forEach(slide => slide.classList.remove('active'));

                // Show last slide
                currentSlide = slides.length - 1;
                slides[currentSlide].classList.add('active');

                // Show the final text immediately
                const lastSlideP = slides[currentSlide].querySelector('p');
                lastSlideP.innerHTML = lastSlideP.dataset.text;

                // Hide next button and show start button
                nextStoryBtn.classList.remove('visible');
                showStartButton();
            }

            function showStartButton() {
                // Add a small delay for better UX
                setTimeout(() => {
                    DOM.startMoleContainer.classList.add('story-complete');
                }, 500);
            }

            // --- Event Listeners ---
            if (DOM.startMoleContainer) {
                DOM.startMoleContainer.addEventListener('click', () => {
                    if (DOM.startMoleContainer.classList.contains('smashed')) return;
                    DOM.startMoleContainer.classList.add('smashed');
                    setTimeout(startGame, 500);
                });
            }

            if (DOM.restartBtn) DOM.restartBtn.addEventListener('click', startGame);
            // homeBtn removed, so no event listener
            if (DOM.btnShare) DOM.btnShare.addEventListener('click', shareResultAsImage);

            if (DOM.gamePage) {
                DOM.gamePage.addEventListener('click', handleGameClick);
            }

            if (DOM.helpBtn) DOM.helpBtn.addEventListener('click', toggleHelpModal);
            if (DOM.helpClose) DOM.helpClose.addEventListener('click', toggleHelpModal);
            if (DOM.helpModal) {
                DOM.helpModal.addEventListener('click', (e) => {
                    if (e.target === DOM.helpModal) toggleHelpModal();
                });
            }
            if (DOM.screenshotClose) {
                DOM.screenshotClose.addEventListener('click', () => {
                    DOM.screenshotModal.style.display = 'none';
                });
            }

            window.addEventListener('load', function () {
                initGameBoard();
                initItemsInfo();
                adjustGamePageHeight();
                loadHighScore();
                setupStorySlides();
            });

            window.addEventListener('resize', adjustGamePageHeight);

        })();
    </script>
</body>

</html>