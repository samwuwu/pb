<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>Âç°ÈÄöÂÆâÂÖ®Âç´Â£´Â∞èÈ£û‰æ† - ÊâãÊú∫Áâà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 100%;
            max-height: 100%;
            border-radius: 0;
            overflow: hidden;
            background: #000;
            display: flex;
            flex-direction: column;
        }

        canvas {
            display: block;
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            text-align: center;
            z-index: 10;
            padding: 20px;
        }

        .screen.hidden {
            display: none;
        }

        #game-title {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            color: #fff;
            text-shadow: 0 0 10px #00f, 0 0 20px #00f, 0 0 30px #00f;
            margin-bottom: 2rem;
            text-align: center;
            animation: glow 2s infinite alternate;
            line-height: 1.2;
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 10px #00f, 0 0 20px #00f, 0 0 30px #00f;
            }
            to {
                text-shadow: 0 0 15px #00f, 0 0 25px #00f, 0 0 35px #00f, 0 0 45px #00f;
            }
        }

        .game-button {
            padding: 15px 30px;
            font-size: clamp(1rem, 4vw, 1.2rem);
            background: linear-gradient(to right, #00a8ff, #0097e6);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0, 168, 255, 0.7);
            margin: 10px;
            width: 90%;
            max-width: 300px;
            min-height: 50px;
            touch-action: manipulation;
        }

        .game-button:active {
            transform: scale(0.95);
            box-shadow: 0 0 25px rgba(0, 168, 255, 0.9);
        }

        .hud {
            position: absolute;
            top: env(safe-area-inset-top, 10px);
            left: env(safe-area-inset-left, 10px);
            right: env(safe-area-inset-right, 10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: clamp(12px, 3vw, 16px);
            font-weight: bold;
            z-index: 5;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }

        .health-bar {
            width: clamp(80px, 20vw, 120px);
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #fff;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4757, #ff6b7a);
            transition: width 0.3s;
            border-radius: 3px;
        }

        .joystick {
            position: absolute;
            bottom: env(safe-area-inset-bottom, 20px);
            left: env(safe-area-inset-left, 20px);
            width: clamp(100px, 25vw, 140px);
            height: clamp(100px, 25vw, 140px);
            z-index: 5;
        }

        .joystick-base {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.5);
            position: relative;
            backdrop-filter: blur(10px);
            touch-action: none;
        }

        .joystick-knob {
            width: 35%;
            height: 35%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.1s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }

        .controls {
            position: absolute;
            bottom: env(safe-area-inset-bottom, 20px);
            right: env(safe-area-inset-right, 20px);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 5;
        }

        .control-btn {
            width: clamp(60px, 15vw, 80px);
            height: clamp(60px, 15vw, 80px);
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: clamp(20px, 5vw, 28px);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
            touch-action: manipulation;
        }

        .control-btn:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.9);
        }

        .legend {
            background: rgba(0, 0, 0, 0.95);
            padding: 20px;
            border-radius: 15px;
            max-width: 90%;
            margin: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .legend h2 {
            color: #00a8ff;
            margin-bottom: 20px;
            text-align: center;
            font-size: clamp(1.2rem, 4vw, 1.5rem);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 15px 0;
            font-size: clamp(14px, 3.5vw, 18px);
        }

        .legend-emoji {
            font-size: clamp(20px, 5vw, 24px);
            margin-right: 15px;
            width: 30px;
            flex-shrink: 0;
        }

        .legend-timer {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: clamp(20px, 5vw, 24px);
            color: #00a8ff;
            font-weight: bold;
        }

        /* Ê®™Â±èÈÄÇÈÖç */
        @media screen and (orientation: landscape) {
            .hud {
                font-size: clamp(10px, 2.5vw, 14px);
                padding: 5px 10px;
            }
            
            .joystick {
                width: clamp(80px, 15vw, 120px);
                height: clamp(80px, 15vw, 120px);
                bottom: env(safe-area-inset-bottom, 15px);
                left: env(safe-area-inset-left, 15px);
            }
            
            .controls {
                bottom: env(safe-area-inset-bottom, 15px);
                right: env(safe-area-inset-right, 15px);
            }
            
            .control-btn {
                width: clamp(50px, 12vw, 70px);
                height: clamp(50px, 12vw, 70px);
                font-size: clamp(18px, 4vw, 24px);
            }
        }

        /* Â∞èÂ±èÂπï‰ºòÂåñ */
        @media screen and (max-width: 480px) {
            .game-button {
                padding: 12px 25px;
                min-height: 45px;
            }
            
            .legend {
                padding: 15px;
                max-height: 60vh;
            }
        }

        /* Ë∂ÖÂ∞èÂ±èÂπï‰ºòÂåñ */
        @media screen and (max-height: 600px) {
            #game-title {
                margin-bottom: 1rem;
            }
            
            .game-button {
                margin: 5px;
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <!-- ÂºÄÂßãÁïåÈù¢ -->
        <div id="startScreen" class="screen">
            <h1 id="game-title">ü¶∏‚Äç‚ôÇÔ∏è Âç°ÈÄöÂÆâÂÖ®Âç´Â£´Â∞èÈ£û‰æ† ü¶∏‚Äç‚ôÇÔ∏è</h1>
            <button class="game-button" onclick="showLegend()">üìñ Êü•ÁúãÊ∏∏ÊàèËØ¥Êòé</button>
            <button class="game-button" onclick="startGame(true)">üöÄ Áõ¥Êé•ÂºÄÂßãÊ∏∏Êàè</button>
        </div>

        <!-- Ê∏∏ÊàèËØ¥ÊòéÁïåÈù¢ -->
        <div id="legendScreen" class="screen hidden">
            <div class="legend">
                <h2>üéÆ Ê∏∏ÊàèËØ¥Êòé</h2>
                <div class="legend-item">
                    <span class="legend-emoji">ü¶∏‚Äç‚ôÇÔ∏è</span>
                    <span>‰Ω†ÊòØÂÆâÂÖ®Âç´Â£´Â∞èÈ£û‰æ†</span>
                </div>
                <div class="legend-item">
                    <span class="legend-emoji">üëæ</span>
                    <span id="danger-legend">Âç±Èô©Êïå‰∫∫ - ÈÅøÂºÄÊàñÂáªË¥•</span>
                </div>
                <div class="legend-item">
                    <span class="legend-emoji">üõ°Ô∏è</span>
                    <span id="safe-legend">ÂÆâÂÖ®Áâ©ÂìÅ - Êî∂ÈõÜËé∑ÂæóÂàÜÊï∞</span>
                </div>
                <div class="legend-item">
                    <span class="legend-emoji">‚≠ê</span>
                    <span id="bonus-legend">Â•ñÂä±ÈÅìÂÖ∑ - È¢ùÂ§ñÂ•ñÂä±</span>
                </div>
                <div class="legend-item">
                    <span class="legend-emoji">üéØ</span>
                    <span>‰ΩøÁî®ÊëáÊùÜÁßªÂä®ÔºåÁÇπÂáªÂ∞ÑÂáª</span>
                </div>
            </div>
            <div class="legend-timer" id="legend-timer">5</div>
            <button class="game-button" onclick="startGame()">ÂºÄÂßãÊ∏∏Êàè</button>
        </div>

        <!-- Ê∏∏ÊàèÁªìÊùüÁïåÈù¢ -->
        <div id="gameOverScreen" class="screen hidden">
            <h1>üéÆ Ê∏∏ÊàèÁªìÊùü</h1>
            <p>ÊúÄÁªàÂæóÂàÜ: <span id="final-score">0</span></p>
            <p>Ê∏∏ÊàèÊó∂Èó¥: <span id="final-time">0</span>Áßí</p>
            <button class="game-button" onclick="restartGame()">üîÑ ÈáçÊñ∞ÂºÄÂßã</button>
            <button class="game-button" onclick="backToMenu()">üè† ËøîÂõû‰∏ªËèúÂçï</button>
        </div>

        <!-- HUDÁïåÈù¢ -->
        <div class="hud" id="gameHUD" style="display: none;">
            <div>
                <span>ÂæóÂàÜ: </span>
                <span id="score">0</span>
            </div>
            <div>
                <span>Êó∂Èó¥: </span>
                <span id="time">60</span>s
            </div>
            <div>
                <span>ÁîüÂëΩ: </span>
                <div class="health-bar">
                    <div class="health-fill" id="health-bar"></div>
                </div>
            </div>
        </div>

        <!-- ËôöÊãüÊëáÊùÜ -->
        <div class="joystick" id="joystick" style="display: none;">
            <div class="joystick-base">
                <div class="joystick-knob" id="joystick-knob"></div>
            </div>
        </div>

        <!-- Â∞ÑÂáªÊåâÈíÆ -->
        <div class="controls" id="controls" style="display: none;">
            <div class="control-btn" id="shoot-btn">üî´</div>
        </div>
    </div>

    <!-- Èü≥È¢ëÂÖÉÁ¥† -->
    <audio id="bg-music" loop>
        <source src="data:audio/wav;base64," type="audio/wav">
    </audio>
    <audio id="shoot-sound">
        <source src="data:audio/wav;base64," type="audio/wav">
    </audio>
    <audio id="hit-sound">
        <source src="data:audio/wav;base64," type="audio/wav">
    </audio>
    <audio id="bonus-sound">
        <source src="data:audio/wav;base64," type="audio/wav">
    </audio>
    <audio id="game-over-sound">
        <source src="data:audio/wav;base64," type="audio/wav">
    </audio>

    <script>
        // ÁßªÂä®Á´ØÈÄÇÈÖçÈÖçÁΩÆ
        const mobileConfig = {
            isTouch: 'ontouchstart' in window,
            pixelRatio: window.devicePixelRatio || 1,
            maxFPS: 60,
            reducedMotion: window.matchMedia('(prefers-reduced-motion: reduce)').matches
        };

        // Ê∏∏ÊàèÈÖçÁΩÆ - ÈíàÂØπÁßªÂä®Á´Ø‰ºòÂåñ
        const config = {
            width: 800,
            height: 600,
            playerSpeed: mobileConfig.isTouch ? 4 : 5,
            bulletSpeed: 8,
            enemySpeed: mobileConfig.isTouch ? 1.5 : 2,
            bonusSpeed: 1.2,
            gameTime: 60,
            playerHealth: 100,
            enemySpawnRate: mobileConfig.isTouch ? 1200 : 1000,
            bonusSpawnRate: 3000,
            maxEnemies: mobileConfig.isTouch ? 6 : 8,
            maxBonuses: 3,
            bulletCooldown: mobileConfig.isTouch ? 200 : 150
        };

        // DOMÂÖÉÁ¥†
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('startScreen');
        const legendScreen = document.getElementById('legendScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const gameHUD = document.getElementById('gameHUD');
        const joystick = document.getElementById('joystick');
        const controls = document.getElementById('controls');
        
        // HUDÂÖÉÁ¥†
        const scoreDisplay = document.getElementById('score');
        const timeDisplay = document.getElementById('time');
        const healthBar = document.getElementById('health-bar');
        const finalScoreDisplay = document.getElementById('final-score');
        const finalTimeDisplay = document.getElementById('final-time');
        const legendTimerDisplay = document.getElementById('legend-timer');
        
        // ÊéßÂà∂ÂÖÉÁ¥†
        const joystickKnob = document.getElementById('joystick-knob');
        const shootBtn = document.getElementById('shoot-btn');
        
        // Èü≥È¢ëÂÖÉÁ¥†
        const bgMusic = document.getElementById('bg-music');
        const shootSound = document.getElementById('shoot-sound');
        const hitSound = document.getElementById('hit-sound');
        const bonusSound = document.getElementById('bonus-sound');
        const gameOverSound = document.getElementById('game-over-sound');
        
        // Âä®ÊÄÅËÆæÁΩÆÁîªÂ∏ÉÂ∞∫ÂØ∏
        function setupCanvas() {
            const container = document.querySelector('.game-container');
            const rect = container.getBoundingClientRect();
            
            // ËÆ°ÁÆóÊúÄ‰Ω≥ÁîªÂ∏ÉÂ∞∫ÂØ∏
            const aspectRatio = config.width / config.height;
            let canvasWidth, canvasHeight;
            
            if (rect.width / rect.height > aspectRatio) {
                canvasHeight = rect.height;
                canvasWidth = canvasHeight * aspectRatio;
            } else {
                canvasWidth = rect.width;
                canvasHeight = canvasWidth / aspectRatio;
            }
            
            // ËÆæÁΩÆÁîªÂ∏ÉÂ∞∫ÂØ∏
            canvas.width = config.width * mobileConfig.pixelRatio;
            canvas.height = config.height * mobileConfig.pixelRatio;
            canvas.style.width = canvasWidth + 'px';
            canvas.style.height = canvasHeight + 'px';
            
            // Áº©Êîæ‰∏ä‰∏ãÊñá‰ª•ÈÄÇÂ∫îÈ´òDPIÂ±èÂπï
            ctx.scale(mobileConfig.pixelRatio, mobileConfig.pixelRatio);
        }
        
        // Ê∏∏ÊàèÂØπË±°
        const player = {
            x: config.width / 2,
            y: config.height - 100,
            width: 50,
            height: 50,
            speed: config.playerSpeed,
            color: '#00ff00'
        };
        
        // ÊëáÊùÜÊï∞ÊçÆ
        const joystickData = {
            active: false,
            centerX: 0,
            centerY: 0,
            currentX: 0,
            currentY: 0,
            deadZone: 0.2,
            maxDistance: 50
        };
        
        // Ê∏∏ÊàèÁä∂ÊÄÅ
        const gameState = {
            score: 0,
            timeLeft: config.gameTime,
            health: config.playerHealth,
            isRunning: false,
            enemies: [],
            bullets: [],
            bonuses: [],
            lastEnemySpawn: 0,
            lastTimeUpdate: 0,
            lastBulletTime: 0,
            animationId: null,
            legendTimer: 5,
            touchControls: {
                left: false,
                right: false,
                up: false,
                down: false,
                shoot: false
            },
            textEffects: []
        };
        
        // Êïå‰∫∫Á±ªÂûã
        const enemyTypes = [
            { emoji: 'üëæ', health: 1, points: 10, speed: 1 },
            { emoji: 'ü§ñ', health: 2, points: 20, speed: 0.8 },
            { emoji: 'üëπ', health: 3, points: 30, speed: 0.6 },
            { emoji: 'üíÄ', health: 1, points: 15, speed: 1.5 }
        ];
        
        // Â•ñÂä±Á±ªÂûã
        const bonusTypes = [
            { emoji: 'üõ°Ô∏è', points: 50, effect: 'health' },
            { emoji: '‚≠ê', points: 100, effect: 'score' },
            { emoji: 'üíé', points: 200, effect: 'score' },
            { emoji: 'üîã', points: 30, effect: 'health' }
        ];
        
        // ÊñáÊú¨ÊïàÊûúÁ±ª
        class TextEffect {
            constructor(x, y, text, color = '#fff', size = 20) {
                this.x = x;
                this.y = y;
                this.text = text;
                this.color = color;
                this.size = size;
                this.life = 60;
                this.maxLife = 60;
                this.velocity = { x: 0, y: -2 };
            }
            
            update() {
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                this.life--;
                return this.life > 0;
            }
            
            draw() {
                const alpha = this.life / this.maxLife;
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.fillStyle = this.color;
                ctx.font = `${this.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(this.text, this.x, this.y);
                ctx.restore();
            }
        }
        
        // ÊòæÁ§∫Ê∏∏ÊàèËØ¥Êòé
        function showLegend() {
            startScreen.classList.add('hidden');
            legendScreen.classList.remove('hidden');
            
            let timer = 5;
            legendTimerDisplay.textContent = timer;
            
            const countdown = setInterval(() => {
                timer--;
                legendTimerDisplay.textContent = timer;
                if (timer <= 0) {
                    clearInterval(countdown);
                    legendTimerDisplay.style.display = 'none';
                }
            }, 1000);
        }
        
        // ÂºÄÂßãÊ∏∏Êàè
        function startGame(skipLegend = false) {
            // ÈöêËóèÊâÄÊúâÁïåÈù¢
            startScreen.classList.add('hidden');
            legendScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            
            // ÊòæÁ§∫Ê∏∏ÊàèÁïåÈù¢
            gameHUD.style.display = 'flex';
            joystick.style.display = 'block';
            controls.style.display = 'flex';
            
            // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
            gameState.score = 0;
            gameState.timeLeft = config.gameTime;
            gameState.health = config.playerHealth;
            gameState.isRunning = true;
            gameState.enemies = [];
            gameState.bullets = [];
            gameState.bonuses = [];
            gameState.lastEnemySpawn = 0;
            gameState.lastTimeUpdate = Date.now();
            gameState.lastBulletTime = 0;
            gameState.textEffects = [];
            
            // ÈáçÁΩÆÁé©ÂÆ∂‰ΩçÁΩÆ
            player.x = config.width / 2 - player.width / 2;
            player.y = config.height - 100;
            
            // Êõ¥Êñ∞HUD
            updateHUD();
            
            // Êí≠ÊîæËÉåÊôØÈü≥‰πê
            bgMusic.volume = 0.3;
            bgMusic.play().catch(() => {});
            
            // ÂºÄÂßãÊ∏∏ÊàèÂæ™ÁéØ
            gameLoop();
        }
        
        // Ê∏∏Êàè‰∏ªÂæ™ÁéØ
        function gameLoop() {
            if (!gameState.isRunning) return;
            
            const now = Date.now();
            
            // Êõ¥Êñ∞Ê∏∏ÊàèÈÄªËæë
            updatePlayer();
            updateBullets();
            updateEnemies(now);
            updateBonuses(now);
            checkCollisions();
            updateGameTime(now);
            updateTextEffects();
            
            // ÁªòÂà∂Ê∏∏Êàè
            draw();
            
            // ÁªßÁª≠Âæ™ÁéØ
            gameState.animationId = requestAnimationFrame(gameLoop);
        }
        
        // Êõ¥Êñ∞Áé©ÂÆ∂
        function updatePlayer() {
            // ÊëáÊùÜÊéßÂà∂
            if (joystickData.active) {
                const deltaX = joystickData.currentX - joystickData.centerX;
                const deltaY = joystickData.currentY - joystickData.centerY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                if (distance > joystickData.deadZone * joystickData.maxDistance) {
                    const normalizedX = deltaX / joystickData.maxDistance;
                    const normalizedY = deltaY / joystickData.maxDistance;
                    
                    player.x += normalizedX * player.speed;
                    player.y += normalizedY * player.speed;
                }
            }
            
            // ÈîÆÁõòÊéßÂà∂
            if (gameState.touchControls.left) {
                player.x -= player.speed;
            }
            if (gameState.touchControls.right) {
                player.x += player.speed;
            }
            if (gameState.touchControls.up) {
                player.y -= player.speed;
            }
            if (gameState.touchControls.down) {
                player.y += player.speed;
            }
            
            // ËæπÁïåÊ£ÄÊµã
            player.x = Math.max(0, Math.min(config.width - player.width, player.x));
            player.y = Math.max(0, Math.min(config.height - player.height, player.y));
        }
        
        // Êõ¥Êñ∞Â≠êÂºπ
        function updateBullets() {
            gameState.bullets = gameState.bullets.filter(bullet => {
                bullet.y -= bullet.speed;
                return bullet.y > -bullet.height;
            });
        }
        
        // Êõ¥Êñ∞Êïå‰∫∫
        function updateEnemies(now) {
            // ÁîüÊàêÊïå‰∫∫
            if (now - gameState.lastEnemySpawn > config.enemySpawnRate && gameState.enemies.length < config.maxEnemies) {
                const type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                const enemy = {
                    x: Math.random() * (config.width - 40),
                    y: -40,
                    width: 40,
                    height: 40,
                    speed: config.enemySpeed * type.speed,
                    type: type,
                    health: type.health,
                    angle: 0
                };
                gameState.enemies.push(enemy);
                gameState.lastEnemySpawn = now;
            }
            
            // Êõ¥Êñ∞Êïå‰∫∫‰ΩçÁΩÆ
            gameState.enemies = gameState.enemies.filter(enemy => {
                enemy.y += enemy.speed;
                enemy.angle += 0.1;
                return enemy.y < config.height + enemy.height;
            });
        }
        
        // Êõ¥Êñ∞Â•ñÂä±
        function updateBonuses(now) {
            // ÁîüÊàêÂ•ñÂä±
            if (now - gameState.lastBonusSpawn > config.bonusSpawnRate && gameState.bonuses.length < config.maxBonuses) {
                const type = bonusTypes[Math.floor(Math.random() * bonusTypes.length)];
                const bonus = {
                    x: Math.random() * (config.width - 30),
                    y: -30,
                    width: 30,
                    height: 30,
                    speed: config.bonusSpeed,
                    type: type,
                    pulse: 0
                };
                gameState.bonuses.push(bonus);
                gameState.lastBonusSpawn = now;
            }
            
            // Êõ¥Êñ∞Â•ñÂä±‰ΩçÁΩÆ
            gameState.bonuses = gameState.bonuses.filter(bonus => {
                bonus.y += bonus.speed;
                bonus.pulse += 0.2;
                return bonus.y < config.height + bonus.height;
            });
        }
        
        // Á¢∞ÊíûÊ£ÄÊµã
        function checkCollisions() {
            // Â≠êÂºπ‰∏éÊïå‰∫∫Á¢∞Êíû
            gameState.bullets.forEach((bullet, bulletIndex) => {
                gameState.enemies.forEach((enemy, enemyIndex) => {
                    if (bullet.x < enemy.x + enemy.width &&
                        bullet.x + bullet.width > enemy.x &&
                        bullet.y < enemy.y + enemy.height &&
                        bullet.y + bullet.height > enemy.y) {
                        
                        // ÁßªÈô§Â≠êÂºπ
                        gameState.bullets.splice(bulletIndex, 1);
                        
                        // ÂáèÂ∞ëÊïå‰∫∫ÁîüÂëΩÂÄº
                        enemy.health--;
                        
                        if (enemy.health <= 0) {
                            // ÁßªÈô§Êïå‰∫∫
                            gameState.enemies.splice(enemyIndex, 1);
                            
                            // Â¢ûÂä†ÂàÜÊï∞
                            gameState.score += enemy.type.points;
                            
                            // Ê∑ªÂä†ÊñáÊú¨ÊïàÊûú
                            gameState.textEffects.push(new TextEffect(
                                enemy.x + enemy.width/2, 
                                enemy.y, 
                                '+' + enemy.type.points, 
                                '#00ff00'
                            ));
                            
                            playSound(hitSound);
                        }
                    }
                });
            });
            
            // Áé©ÂÆ∂‰∏éÊïå‰∫∫Á¢∞Êíû
            gameState.enemies.forEach((enemy, enemyIndex) => {
                if (player.x < enemy.x + enemy.width &&
                    player.x + player.width > enemy.x &&
                    player.y < enemy.y + enemy.height &&
                    player.y + player.height > enemy.y) {
                    
                    // ÁßªÈô§Êïå‰∫∫
                    gameState.enemies.splice(enemyIndex, 1);
                    
                    // ÂáèÂ∞ëÁîüÂëΩÂÄº
                    gameState.health -= 20;
                    
                    // Ê∑ªÂä†ÊñáÊú¨ÊïàÊûú
                    gameState.textEffects.push(new TextEffect(
                        player.x + player.width/2, 
                        player.y, 
                        '-20', 
                        '#ff0000'
                    ));
                    
                    if (gameState.health <= 0) {
                        endGame();
                    }
                }
            });
            
            // Áé©ÂÆ∂‰∏éÂ•ñÂä±Á¢∞Êíû
            gameState.bonuses.forEach((bonus, bonusIndex) => {
                if (player.x < bonus.x + bonus.width &&
                    player.x + player.width > bonus.x &&
                    player.y < bonus.y + bonus.height &&
                    player.y + player.height > bonus.y) {
                    
                    // ÁßªÈô§Â•ñÂä±
                    gameState.bonuses.splice(bonusIndex, 1);
                    
                    // Â∫îÁî®Â•ñÂä±ÊïàÊûú
                    if (bonus.type.effect === 'health') {
                        gameState.health = Math.min(config.playerHealth, gameState.health + 20);
                        gameState.textEffects.push(new TextEffect(
                            player.x + player.width/2, 
                            player.y, 
                            '+20 HP', 
                            '#00ff00'
                        ));
                    } else {
                        gameState.score += bonus.type.points;
                        gameState.textEffects.push(new TextEffect(
                            player.x + player.width/2, 
                            player.y, 
                            '+' + bonus.type.points, 
                            '#ffff00'
                        ));
                    }
                    
                    playSound(bonusSound);
                }
            });
        }
        
        // Êõ¥Êñ∞Ê∏∏ÊàèÊó∂Èó¥
        function updateGameTime(now) {
            if (now - gameState.lastTimeUpdate >= 1000) {
                gameState.timeLeft--;
                gameState.lastTimeUpdate = now;
                
                if (gameState.timeLeft <= 0) {
                    endGame();
                }
            }
        }
        
        // Êõ¥Êñ∞ÊñáÊú¨ÊïàÊûú
        function updateTextEffects() {
            gameState.textEffects = gameState.textEffects.filter(effect => effect.update());
        }
        
        // Â∞ÑÂáª
        function shoot() {
            const now = Date.now();
            if (now - gameState.lastBulletTime > config.bulletCooldown) {
                const bullet = {
                    x: player.x + player.width / 2 - 2,
                    y: player.y,
                    width: 4,
                    height: 10,
                    speed: config.bulletSpeed
                };
                gameState.bullets.push(bullet);
                gameState.lastBulletTime = now;
                playSound(shootSound);
            }
        }
        
        // Êí≠ÊîæÈü≥Êïà
        function playSound(audio) {
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(() => {});
            }
        }
        
        // ÁªòÂà∂Ê∏∏Êàè
        function draw() {
            // Ê∏ÖÁ©∫ÁîªÂ∏É
            ctx.clearRect(0, 0, config.width, config.height);
            
            // ÁªòÂà∂ËÉåÊôØ
            drawBackground();
            
            // ÁªòÂà∂Ê∏∏ÊàèÂØπË±°
            drawPlayer();
            drawBullets();
            drawEnemies();
            drawBonuses();
            drawTextEffects();
        }
        
        // ÁªòÂà∂ËÉåÊôØ
        function drawBackground() {
            const gradient = ctx.createLinearGradient(0, 0, 0, config.height);
            gradient.addColorStop(0, '#1e3c72');
            gradient.addColorStop(1, '#2a5298');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, config.width, config.height);
            
            // ÁªòÂà∂ÊòüÊòü
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            for (let i = 0; i < 50; i++) {
                const x = (i * 137.5) % config.width;
                const y = (i * 73.3 + Date.now() * 0.01) % config.height;
                ctx.fillRect(x, y, 1, 1);
            }
        }
        
        // ÁªòÂà∂Áé©ÂÆ∂
        function drawPlayer() {
            ctx.save();
            ctx.translate(player.x + player.width/2, player.y + player.height/2);
            ctx.font = '40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('ü¶∏‚Äç‚ôÇÔ∏è', 0, 0);
            ctx.restore();
        }
        
        // ÁªòÂà∂Â≠êÂºπ
        function drawBullets() {
            ctx.fillStyle = '#ffff00';
            ctx.shadowColor = '#ffff00';
            ctx.shadowBlur = 10;
            
            gameState.bullets.forEach(bullet => {
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
            });
            
            ctx.shadowBlur = 0;
        }
        
        // ÁªòÂà∂Êïå‰∫∫
        function drawEnemies() {
            gameState.enemies.forEach(enemy => {
                ctx.save();
                ctx.translate(enemy.x + enemy.width/2, enemy.y + enemy.height/2);
                ctx.rotate(enemy.angle);
                ctx.font = '35px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(enemy.type.emoji, 0, 0);
                ctx.restore();
            });
        }
        
        // ÁªòÂà∂Â•ñÂä±
        function drawBonuses() {
            gameState.bonuses.forEach(bonus => {
                ctx.save();
                ctx.translate(bonus.x + bonus.width/2, bonus.y + bonus.height/2);
                const scale = 1 + Math.sin(bonus.pulse) * 0.2;
                ctx.scale(scale, scale);
                ctx.font = '25px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(bonus.type.emoji, 0, 0);
                ctx.restore();
            });
        }
        
        // ÁªòÂà∂ÊñáÊú¨ÊïàÊûú
        function drawTextEffects() {
            gameState.textEffects.forEach(effect => {
                effect.draw();
            });
        }
        
        // Êõ¥Êñ∞HUD
        function updateHUD() {
            scoreDisplay.textContent = gameState.score;
            timeDisplay.textContent = gameState.timeLeft;
            const healthPercent = (gameState.health / config.playerHealth) * 100;
            healthBar.style.width = healthPercent + '%';
        }
        
        // ÁªìÊùüÊ∏∏Êàè
        function endGame() {
            gameState.isRunning = false;
            
            if (gameState.animationId) {
                cancelAnimationFrame(gameState.animationId);
            }
            
            // ÂÅúÊ≠¢Èü≥‰πê
            bgMusic.pause();
            playSound(gameOverSound);
            
            // ÈöêËóèÊ∏∏ÊàèÁïåÈù¢
            gameHUD.style.display = 'none';
            joystick.style.display = 'none';
            controls.style.display = 'none';
            
            // ÊòæÁ§∫Ê∏∏ÊàèÁªìÊùüÁïåÈù¢
            finalScoreDisplay.textContent = gameState.score;
            finalTimeDisplay.textContent = config.gameTime - gameState.timeLeft;
            gameOverScreen.classList.remove('hidden');
        }
        
        // ÈáçÊñ∞ÂºÄÂßãÊ∏∏Êàè
        function restartGame() {
            startGame(true);
        }
        
        // ËøîÂõû‰∏ªËèúÂçï
        function backToMenu() {
            gameOverScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        }
        
        // ÊëáÊùÜ‰∫ã‰ª∂Â§ÑÁêÜ
        function setupJoystickControls() {
            const joystickBase = document.querySelector('.joystick-base');
            const joystickKnob = document.querySelector('.joystick-knob');
            
            function handleJoystickStart(e) {
                e.preventDefault();
                joystickData.active = true;
                
                const rect = joystickBase.getBoundingClientRect();
                joystickData.centerX = rect.width / 2;
                joystickData.centerY = rect.height / 2;
                joystickData.maxDistance = rect.width / 2 - 20;
            }
            
            function handleJoystickMove(e) {
                if (!joystickData.active) return;
                e.preventDefault();
                
                const rect = joystickBase.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                let x = clientX - rect.left;
                let y = clientY - rect.top;
                
                const distance = Math.sqrt((x - joystickData.centerX) ** 2 + (y - joystickData.centerY) ** 2);
                
                if (distance > joystickData.maxDistance) {
                    const angle = Math.atan2(y - joystickData.centerY, x - joystickData.centerX);
                    x = joystickData.centerX + Math.cos(angle) * joystickData.maxDistance;
                    y = joystickData.centerY + Math.sin(angle) * joystickData.maxDistance;
                }
                
                joystickData.currentX = x;
                joystickData.currentY = y;
                
                const knobSize = joystickKnob.offsetWidth / 2;
                joystickKnob.style.left = (x - knobSize) + 'px';
                joystickKnob.style.top = (y - knobSize) + 'px';
                joystickKnob.style.transform = 'none';
            }
            
            function handleJoystickEnd(e) {
                e.preventDefault();
                joystickData.active = false;
                joystickData.currentX = joystickData.centerX;
                joystickData.currentY = joystickData.centerY;
                
                joystickKnob.style.left = '50%';
                joystickKnob.style.top = '50%';
                joystickKnob.style.transform = 'translate(-50%, -50%)';
            }
            
            // Ëß¶Êë∏‰∫ã‰ª∂
            joystickBase.addEventListener('touchstart', handleJoystickStart, { passive: false });
            document.addEventListener('touchmove', handleJoystickMove, { passive: false });
            document.addEventListener('touchend', handleJoystickEnd, { passive: false });
            
            // Èº†Ê†á‰∫ã‰ª∂ÔºàÁî®‰∫éÊ°åÈù¢ÊµãËØïÔºâ
            joystickBase.addEventListener('mousedown', handleJoystickStart);
            document.addEventListener('mousemove', handleJoystickMove);
            document.addEventListener('mouseup', handleJoystickEnd);
        }
        
        // Â∞ÑÂáªÊåâÈíÆ‰∫ã‰ª∂
        function setupShootButton() {
            function handleShoot(e) {
                e.preventDefault();
                if (gameState.isRunning) {
                    shoot();
                }
            }
            
            shootBtn.addEventListener('touchstart', handleShoot, { passive: false });
            shootBtn.addEventListener('mousedown', handleShoot);
            
            // Èò≤Ê≠¢ÈïøÊåâÈáçÂ§çÂ∞ÑÂáª
            let shootInterval;
            
            function startContinuousShoot(e) {
                e.preventDefault();
                if (gameState.isRunning) {
                    shoot();
                    shootInterval = setInterval(() => {
                        if (gameState.isRunning) {
                            shoot();
                        }
                    }, config.bulletCooldown);
                }
            }
            
            function stopContinuousShoot(e) {
                e.preventDefault();
                if (shootInterval) {
                    clearInterval(shootInterval);
                    shootInterval = null;
                }
            }
            
            // ÈïøÊåâËøûÁª≠Â∞ÑÂáª
            shootBtn.addEventListener('touchstart', startContinuousShoot, { passive: false });
            shootBtn.addEventListener('touchend', stopContinuousShoot, { passive: false });
            shootBtn.addEventListener('mousedown', startContinuousShoot);
            shootBtn.addEventListener('mouseup', stopContinuousShoot);
        }
        
        // ÈîÆÁõòÊéßÂà∂ÔºàÁî®‰∫éÊ°åÈù¢ÊµãËØïÔºâ
        function setupKeyboardControls() {
            document.addEventListener('keydown', (e) => {
                if (!gameState.isRunning) return;
                
                switch(e.code) {
                    case 'ArrowLeft':
                    case 'KeyA':
                        gameState.touchControls.left = true;
                        break;
                    case 'ArrowRight':
                    case 'KeyD':
                        gameState.touchControls.right = true;
                        break;
                    case 'ArrowUp':
                    case 'KeyW':
                        gameState.touchControls.up = true;
                        break;
                    case 'ArrowDown':
                    case 'KeyS':
                        gameState.touchControls.down = true;
                        break;
                    case 'Space':
                        e.preventDefault();
                        shoot();
                        break;
                }
            });
            
            document.addEventListener('keyup', (e) => {
                switch(e.code) {
                    case 'ArrowLeft':
                    case 'KeyA':
                        gameState.touchControls.left = false;
                        break;
                    case 'ArrowRight':
                    case 'KeyD':
                        gameState.touchControls.right = false;
                        break;
                    case 'ArrowUp':
                    case 'KeyW':
                        gameState.touchControls.up = false;
                        break;
                    case 'ArrowDown':
                    case 'KeyS':
                        gameState.touchControls.down = false;
                        break;
                }
            });
        }
        
        // Â±èÂπïÊñπÂêëÂèòÂåñÂ§ÑÁêÜ
        function setupOrientationChange() {
            function handleOrientationChange() {
                setTimeout(() => {
                    setupCanvas();
                    // ÈáçÊñ∞ËÆ°ÁÆóÊëáÊùÜ‰ΩçÁΩÆ
                    if (joystickData.active) {
                        const rect = document.querySelector('.joystick-base').getBoundingClientRect();
                        joystickData.centerX = rect.width / 2;
                        joystickData.centerY = rect.height / 2;
                        joystickData.maxDistance = rect.width / 2 - 20;
                    }
                }, 100);
            }
            
            window.addEventListener('orientationchange', handleOrientationChange);
            window.addEventListener('resize', handleOrientationChange);
        }
        
        // Èò≤Ê≠¢ÈªòËÆ§Ë°å‰∏∫Âíå‰ºòÂåñËß¶Êë∏‰ΩìÈ™å
        function preventDefaults() {
            // Èò≤Ê≠¢Âè≥ÈîÆËèúÂçï
            document.addEventListener('contextmenu', e => e.preventDefault());
            
            // Èò≤Ê≠¢ÊñáÊú¨ÈÄâÊã©
            document.addEventListener('selectstart', e => e.preventDefault());
            
            // Èò≤Ê≠¢ÊãñÊãΩ
            document.addEventListener('dragstart', e => e.preventDefault());
            
            // Èò≤Ê≠¢ÂèåÂáªÁº©Êîæ
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Èò≤Ê≠¢ÊªöÂä®
            document.addEventListener('touchmove', function(e) {
                if (e.target.closest('.legend')) {
                    return; // ÂÖÅËÆ∏ËØ¥ÊòéÁïåÈù¢ÊªöÂä®
                }
                e.preventDefault();
            }, { passive: false });
        }
        
        // ÊÄßËÉΩÁõëÊéßÂíå‰ºòÂåñ
        function setupPerformanceOptimization() {
            // Ê£ÄÊµãËÆæÂ§áÊÄßËÉΩ
            const isLowEndDevice = navigator.hardwareConcurrency <= 2 || 
                                   /Android.*Chrome\/[.0-9]*/.test(navigator.userAgent);
            
            if (isLowEndDevice) {
                // Èôç‰ΩéÊ∏∏ÊàèÂ§çÊùÇÂ∫¶
                config.maxEnemies = Math.max(3, config.maxEnemies - 2);
                config.enemySpawnRate += 200;
                config.maxBonuses = Math.max(1, config.maxBonuses - 1);
            }
            
            // Â∏ßÁéáÁõëÊéß
            let frameCount = 0;
            let lastTime = performance.now();
            
            function monitorFPS() {
                frameCount++;
                const currentTime = performance.now();
                
                if (currentTime - lastTime >= 1000) {
                    const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                    
                    // Â¶ÇÊûúÂ∏ßÁéáËøá‰ΩéÔºåËøõ‰∏ÄÊ≠•‰ºòÂåñ
                    if (fps < 30 && gameState.isRunning) {
                        config.maxEnemies = Math.max(2, config.maxEnemies - 1);
                        config.enemySpawnRate += 100;
                    }
                    
                    frameCount = 0;
                    lastTime = currentTime;
                }
                
                if (gameState.isRunning) {
                    requestAnimationFrame(monitorFPS);
                }
            }
            
            // ÂºÄÂßãÁõëÊéß
            monitorFPS();
        }
        
        // ÂàùÂßãÂåñÊ∏∏Êàè
        function initGame() {
            setupCanvas();
            
            // ‰ΩøÁî®Ëß¶Êë∏Â±èÂπïÁõ¥Êé•ÊéßÂà∂Êõø‰ª£ÊëáÊùÜ
            setupDirectTouchControl();
            setupImprovedShootButton();
            
            setupKeyboardControls();
            setupOrientationChange();
            preventDefaults();
            setupPerformanceOptimization();
            setupGameButtons();
            
            gameState.lastBonusSpawn = Date.now();
            
            console.log('üéÆ Âç°ÈÄöÂÆâÂÖ®Âç´Â£´Â∞èÈ£û‰æ† - Ëß¶Êë∏Áõ¥ÊéßÁâàÊú¨Â∑≤Âä†ËΩΩÂÆåÊàê!');
        }
        
        // ËÆæÁΩÆÊ∏∏ÊàèÊåâÈíÆÁöÑËß¶Êë∏‰∫ã‰ª∂
        function setupGameButtons() {
            // Ëé∑ÂèñÊâÄÊúâÊ∏∏ÊàèÊåâÈíÆ
            const gameButtons = document.querySelectorAll('.game-button');
            
            gameButtons.forEach(button => {
                // ‰∏∫ÊØè‰∏™ÊåâÈíÆÊ∑ªÂä†Ëß¶Êë∏‰∫ã‰ª∂ÁõëÂê¨Âô®
                button.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    // Ëß¶ÂèëÁÇπÂáª‰∫ã‰ª∂
                    this.click();
                }, { passive: false });
                
                // Ê∑ªÂä†Ëß¶Êë∏ÂèçÈ¶àÊïàÊûú
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                button.addEventListener('touchend', function() {
                    this.style.transform = 'scale(1)';
                });
            });
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', initGame);
        
        // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÂ§ÑÁêÜÔºàËäÇÁúÅÁîµÊ±†Ôºâ
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && gameState.isRunning) {
                // È°µÈù¢ÈöêËóèÊó∂ÊöÇÂÅúÊ∏∏Êàè
                bgMusic.pause();
            } else if (!document.hidden && gameState.isRunning) {
                // È°µÈù¢ÊòæÁ§∫Êó∂ÊÅ¢Â§çÊ∏∏Êàè
                bgMusic.play().catch(() => {});
            }
        });
    </script>
</body>
</html>