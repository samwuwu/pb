<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>å¡é€šå®‰å…¨å«å£«å°é£ä¾  - æ‰‹æœºç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 100%;
            max-height: 100%;
            border-radius: 0;
            overflow: hidden;
            background: #000;
            display: flex;
            flex-direction: column;
        }

        canvas {
            display: block;
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            text-align: center;
            z-index: 10;
            padding: 20px;
        }

        .screen.hidden {
            display: none;
        }

        #game-title {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            color: #fff;
            text-shadow: 0 0 10px #00f, 0 0 20px #00f, 0 0 30px #00f;
            margin-bottom: 2rem;
            text-align: center;
            animation: glow 2s infinite alternate;
            line-height: 1.2;
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 10px #00f, 0 0 20px #00f, 0 0 30px #00f;
            }
            to {
                text-shadow: 0 0 15px #00f, 0 0 25px #00f, 0 0 35px #00f, 0 0 45px #00f;
            }
        }

        .game-button {
            padding: 15px 30px;
            font-size: clamp(1rem, 4vw, 1.2rem);
            background: linear-gradient(to right, #00a8ff, #0097e6);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0, 168, 255, 0.7);
            margin: 10px;
            width: 90%;
            max-width: 300px;
            min-height: 50px;
            touch-action: manipulation;
        }

        .game-button:active {
            transform: scale(0.95);
            box-shadow: 0 0 25px rgba(0, 168, 255, 0.9);
        }

        .hud {
            position: absolute;
            top: env(safe-area-inset-top, 10px);
            left: env(safe-area-inset-left, 10px);
            right: env(safe-area-inset-right, 10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: clamp(12px, 3vw, 16px);
            font-weight: bold;
            z-index: 5;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }

        .health-bar {
            width: clamp(80px, 20vw, 120px);
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #fff;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4757, #ff6b7a);
            transition: width 0.3s;
            border-radius: 3px;
        }

        .joystick {
            position: absolute;
            bottom: env(safe-area-inset-bottom, 20px);
            left: env(safe-area-inset-left, 20px);
            width: clamp(100px, 25vw, 140px);
            height: clamp(100px, 25vw, 140px);
            z-index: 5;
        }

        .joystick-base {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.5);
            position: relative;
            backdrop-filter: blur(10px);
            touch-action: none;
        }

        .joystick-knob {
            width: 35%;
            height: 35%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.1s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }

        .controls {
            position: absolute;
            bottom: env(safe-area-inset-bottom, 20px);
            right: env(safe-area-inset-right, 20px);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 5;
        }

        .control-btn {
            width: clamp(60px, 15vw, 80px);
            height: clamp(60px, 15vw, 80px);
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: clamp(20px, 5vw, 28px);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
            touch-action: manipulation;
        }

        .control-btn:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.9);
        }

        .legend {
            background: rgba(0, 0, 0, 0.95);
            padding: 20px;
            border-radius: 15px;
            max-width: 90%;
            margin: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .legend h2 {
            color: #00a8ff;
            margin-bottom: 20px;
            text-align: center;
            font-size: clamp(1.2rem, 4vw, 1.5rem);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 15px 0;
            font-size: clamp(14px, 3.5vw, 18px);
        }

        .legend-emoji {
            font-size: clamp(20px, 5vw, 24px);
            margin-right: 15px;
            width: 30px;
            flex-shrink: 0;
        }

        .legend-timer {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: clamp(20px, 5vw, 24px);
            color: #00a8ff;
            font-weight: bold;
        }

        /* æ¨ªå±é€‚é… */
        @media screen and (orientation: landscape) {
            .hud {
                font-size: clamp(10px, 2.5vw, 14px);
                padding: 5px 10px;
            }
            
            .joystick {
                width: clamp(80px, 15vw, 120px);
                height: clamp(80px, 15vw, 120px);
                bottom: env(safe-area-inset-bottom, 15px);
                left: env(safe-area-inset-left, 15px);
            }
            
            .controls {
                bottom: env(safe-area-inset-bottom, 15px);
                right: env(safe-area-inset-right, 15px);
            }
            
            .control-btn {
                width: clamp(50px, 12vw, 70px);
                height: clamp(50px, 12vw, 70px);
                font-size: clamp(18px, 4vw, 24px);
            }
        }

        /* å°å±å¹•ä¼˜åŒ– */
        @media screen and (max-width: 480px) {
            .game-button {
                padding: 12px 25px;
                min-height: 45px;
            }
            
            .legend {
                padding: 15px;
                max-height: 60vh;
            }
        }

        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media screen and (max-height: 600px) {
            #game-title {
                margin-bottom: 1rem;
            }
            
            .game-button {
                margin: 5px;
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <!-- å¼€å§‹ç•Œé¢ -->
        <div id="startScreen" class="screen">
            <h1 id="game-title">ğŸ¦¸â€â™‚ï¸ å¡é€šå®‰å…¨å«å£«å°é£ä¾  ğŸ¦¸â€â™‚ï¸</h1>
            <button class="game-button" onclick="showLegend()">ğŸ“– æŸ¥çœ‹æ¸¸æˆè¯´æ˜</button>
            <button class="game-button" onclick="startGame(true)">ğŸš€ ç›´æ¥å¼€å§‹æ¸¸æˆ</button>
        </div>

        <!-- æ¸¸æˆè¯´æ˜ç•Œé¢ -->
        <div id="legendScreen" class="screen hidden">
            <div class="legend">
                <h2>ğŸ® æ¸¸æˆè¯´æ˜</h2>
                <div class="legend-item">
                    <span class="legend-emoji">ğŸ¦¸â€â™‚ï¸</span>
                    <span>ä½ æ˜¯å®‰å…¨å«å£«å°é£ä¾ </span>
                </div>
                <div class="legend-item">
                    <span class="legend-emoji">ğŸ‘¾</span>
                    <span id="danger-legend">å±é™©æ•Œäºº - é¿å¼€æˆ–å‡»è´¥</span>
                </div>
                <div class="legend-item">
                    <span class="legend-emoji">ğŸ›¡ï¸</span>
                    <span id="safe-legend">å®‰å…¨ç‰©å“ - æ”¶é›†è·å¾—åˆ†æ•°</span>
                </div>
                <div class="legend-item">
                    <span class="legend-emoji">â­</span>
                    <span id="bonus-legend">å¥–åŠ±é“å…· - é¢å¤–å¥–åŠ±</span>
                </div>
                <div class="legend-item">
                    <span class="legend-emoji">ğŸ¯</span>
                    <span>ä½¿ç”¨æ‘‡æ†ç§»åŠ¨ï¼Œç‚¹å‡»å°„å‡»</span>
                </div>
            </div>
            <div class="legend-timer" id="legend-timer">5</div>
            <button class="game-button" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
        </div>

        <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
        <div id="gameOverScreen" class="screen hidden">
            <h1>ğŸ® æ¸¸æˆç»“æŸ</h1>
            <p>æœ€ç»ˆå¾—åˆ†: <span id="final-score">0</span></p>
            <p>æ¸¸æˆæ—¶é—´: <span id="final-time">0</span>ç§’</p>
            <button class="game-button" onclick="restartGame()">ğŸ”„ é‡æ–°å¼€å§‹</button>
            <button class="game-button" onclick="backToMenu()">ğŸ  è¿”å›ä¸»èœå•</button>
        </div>

        <!-- HUDç•Œé¢ -->
        <div class="hud" id="gameHUD" style="display: none;">
            <div>
                <span>å¾—åˆ†: </span>
                <span id="score">0</span>
            </div>
            <div>
                <span>æ—¶é—´: </span>
                <span id="time">60</span>s
            </div>
            <div>
                <span>ç”Ÿå‘½: </span>
                <div class="health-bar">
                    <div class="health-fill" id="health-bar"></div>
                </div>
            </div>
        </div>

        <!-- è™šæ‹Ÿæ‘‡æ† -->
        <div class="joystick" id="joystick" style="display: none;">
            <div class="joystick-base">
                <div class="joystick-knob" id="joystick-knob"></div>
            </div>
        </div>

        <!-- å°„å‡»æŒ‰é’® -->
        <div class="controls" id="controls" style="display: none;">
            <div class="control-btn" id="shoot-btn">ğŸ”«</div>
        </div>
    </div>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="bg-music" loop>
        <source src="data:audio/wav;base64," type="audio/wav">
    </audio>
    <audio id="shoot-sound">
        <source src="data:audio/wav;base64," type="audio/wav">
    </audio>
    <audio id="hit-sound">
        <source src="data:audio/wav;base64," type="audio/wav">
    </audio>
    <audio id="bonus-sound">
        <source src="data:audio/wav;base64," type="audio/wav">
    </audio>
    <audio id="game-over-sound">
        <source src="data:audio/wav;base64," type="audio/wav">
    </audio>

    <script>
        // ç§»åŠ¨ç«¯é€‚é…é…ç½®
        const mobileConfig = {
            isTouch: 'ontouchstart' in window,
            pixelRatio: window.devicePixelRatio || 1,
            maxFPS: 60,
            reducedMotion: window.matchMedia('(prefers-reduced-motion: reduce)').matches
        };

        // æ¸¸æˆé…ç½® - é’ˆå¯¹ç§»åŠ¨ç«¯ä¼˜åŒ–
        const config = {
            width: 800,
            height: 600,
            playerSpeed: mobileConfig.isTouch ? 4 : 5,
            bulletSpeed: 8,
            enemySpeed: mobileConfig.isTouch ? 1.5 : 2,
            bonusSpeed: 1.2,
            gameTime: 60,
            playerHealth: 100,
            enemySpawnRate: mobileConfig.isTouch ? 1200 : 1000,
            bonusSpawnRate: 3000,
            maxEnemies: mobileConfig.isTouch ? 6 : 8,
            maxBonuses: 3,
            bulletCooldown: mobileConfig.isTouch ? 200 : 150
        };

        // DOMå…ƒç´ 
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('startScreen');
        const legendScreen = document.getElementById('legendScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const gameHUD = document.getElementById('gameHUD');
        const joystick = document.getElementById('joystick');
        const controls = document.getElementById('controls');
        
        // HUDå…ƒç´ 
        const scoreDisplay = document.getElementById('score');
        const timeDisplay = document.getElementById('time');
        const healthBar = document.getElementById('health-bar');
        const finalScoreDisplay = document.getElementById('final-score');
        const finalTimeDisplay = document.getElementById('final-time');
        const legendTimerDisplay = document.getElementById('legend-timer');
        
        // æ§åˆ¶å…ƒç´ 
        const joystickKnob = document.getElementById('joystick-knob');
        const shootBtn = document.getElementById('shoot-btn');
        
        // éŸ³é¢‘å…ƒç´ 
        const bgMusic = document.getElementById('bg-music');
        const shootSound = document.getElementById('shoot-sound');
        const hitSound = document.getElementById('hit-sound');
        const bonusSound = document.getElementById('bonus-sound');
        const gameOverSound = document.getElementById('game-over-sound');
        
        // åŠ¨æ€è®¾ç½®ç”»å¸ƒå°ºå¯¸
        function setupCanvas() {
            const container = document.querySelector('.game-container');
            const rect = container.getBoundingClientRect();
            
            // è®¡ç®—æœ€ä½³ç”»å¸ƒå°ºå¯¸
            const aspectRatio = config.width / config.height;
            let canvasWidth, canvasHeight;
            
            if (rect.width / rect.height > aspectRatio) {
                canvasHeight = rect.height;
                canvasWidth = canvasHeight * aspectRatio;
            } else {
                canvasWidth = rect.width;
                canvasHeight = canvasWidth / aspectRatio;
            }
            
            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
            canvas.width = config.width * mobileConfig.pixelRatio;
            canvas.height = config.height * mobileConfig.pixelRatio;
            canvas.style.width = canvasWidth + 'px';
            canvas.style.height = canvasHeight + 'px';
            
            // ç¼©æ”¾ä¸Šä¸‹æ–‡ä»¥é€‚åº”é«˜DPIå±å¹•
            ctx.scale(mobileConfig.pixelRatio, mobileConfig.pixelRatio);
        }
        
        // æ¸¸æˆå¯¹è±¡
        const player = {
            x: config.width / 2,
            y: config.height - 100,
            width: 50,
            height: 50,
            speed: config.playerSpeed,
            color: '#00ff00'
        };
        
        // æ‘‡æ†æ•°æ®
        const joystickData = {
            active: false,
            centerX: 0,
            centerY: 0,
            currentX: 0,
            currentY: 0,
            deadZone: 0.2,
            maxDistance: 50
        };
        
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            score: 0,
            timeLeft: config.gameTime,
            health: config.playerHealth,
            isRunning: false,
            enemies: [],
            bullets: [],
            bonuses: [],
            lastEnemySpawn: 0,
            lastTimeUpdate: 0,
            lastBulletTime: 0,
            animationId: null,
            legendTimer: 5,
            touchControls: {
                left: false,
                right: false,
                up: false,
                down: false,
                shoot: false
            },
            textEffects: []
        };
        
        // æ•Œäººç±»å‹
        const enemyTypes = [
            { emoji: 'ğŸ‘¾', health: 1, points: 10, speed: 1 },
            { emoji: 'ğŸ¤–', health: 2, points: 20, speed: 0.8 },
            { emoji: 'ğŸ‘¹', health: 3, points: 30, speed: 0.6 },
            { emoji: 'ğŸ’€', health: 1, points: 15, speed: 1.5 }
        ];
        
        // å¥–åŠ±ç±»å‹
        const bonusTypes = [
            { emoji: 'ğŸ›¡ï¸', points: 50, effect: 'health' },
            { emoji: 'â­', points: 100, effect: 'score' },
            { emoji: 'ğŸ’', points: 200, effect: 'score' },
            { emoji: 'ğŸ”‹', points: 30, effect: 'health' }
        ];
        
        // æ–‡æœ¬æ•ˆæœç±»
        class TextEffect {
            constructor(x, y, text, color = '#fff', size = 20) {
                this.x = x;
                this.y = y;
                this.text = text;
                this.color = color;
                this.size = size;
                this.life = 60;
                this.maxLife = 60;
                this.velocity = { x: 0, y: -2 };
            }
            
            update() {
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                this.life--;
                return this.life > 0;
            }
            
            draw() {
                const alpha = this.life / this.maxLife;
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.fillStyle = this.color;
                ctx.font = `${this.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(this.text, this.x, this.y);
                ctx.restore();
            }
        }
        
        // æ˜¾ç¤ºæ¸¸æˆè¯´æ˜
        function showLegend() {
            startScreen.classList.add('hidden');
            legendScreen.classList.remove('hidden');
            
            let timer = 5;
            legendTimerDisplay.textContent = timer;
            
            const countdown = setInterval(() => {
                timer--;
                legendTimerDisplay.textContent = timer;
                if (timer <= 0) {
                    clearInterval(countdown);
                    legendTimerDisplay.style.display = 'none';
                }
            }, 1000);
        }
        
        // å¼€å§‹æ¸¸æˆ
        function startGame(skipLegend = false) {
            // éšè—æ‰€æœ‰ç•Œé¢
            startScreen.classList.add('hidden');
            legendScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            
            // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
            gameHUD.style.display = 'flex';
            joystick.style.display = 'block';
            controls.style.display = 'flex';
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.score = 0;
            gameState.timeLeft = config.gameTime;
            gameState.health = config.playerHealth;
            gameState.isRunning = true;
            gameState.enemies = [];
            gameState.bullets = [];
            gameState.bonuses = [];
            gameState.lastEnemySpawn = 0;
            gameState.lastTimeUpdate = Date.now();
            gameState.lastBulletTime = 0;
            gameState.textEffects = [];
            
            // é‡ç½®ç©å®¶ä½ç½®
            player.x = config.width / 2 - player.width / 2;
            player.y = config.height - 100;
            
            // æ›´æ–°HUD
            updateHUD();
            
            // æ’­æ”¾èƒŒæ™¯éŸ³ä¹
            bgMusic.volume = 0.3;
            bgMusic.play().catch(() => {});
            
            // å¼€å§‹æ¸¸æˆå¾ªç¯
            gameLoop();
        }
        
        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            if (!gameState.isRunning) return;
            
            const now = Date.now();
            
            // æ›´æ–°æ¸¸æˆé€»è¾‘
            updatePlayer();
            updateBullets();
            updateEnemies(now);
            updateBonuses(now);
            checkCollisions();
            updateGameTime(now);
            updateTextEffects();
            
            // ç»˜åˆ¶æ¸¸æˆ
            draw();
            
            // ç»§ç»­å¾ªç¯
            gameState.animationId = requestAnimationFrame(gameLoop);
        }
        
        // æ›´æ–°ç©å®¶
        function updatePlayer() {
            // æ‘‡æ†æ§åˆ¶
            if (joystickData.active) {
                const deltaX = joystickData.currentX - joystickData.centerX;
                const deltaY = joystickData.currentY - joystickData.centerY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                if (distance > joystickData.deadZone * joystickData.maxDistance) {
                    const normalizedX = deltaX / joystickData.maxDistance;
                    const normalizedY = deltaY / joystickData.maxDistance;
                    
                    player.x += normalizedX * player.speed;
                    player.y += normalizedY * player.speed;
                }
            }
            
            // é”®ç›˜æ§åˆ¶
            if (gameState.touchControls.left) {
                player.x -= player.speed;
            }
            if (gameState.touchControls.right) {
                player.x += player.speed;
            }
            if (gameState.touchControls.up) {
                player.y -= player.speed;
            }
            if (gameState.touchControls.down) {
                player.y += player.speed;
            }
            
            // è¾¹ç•Œæ£€æµ‹
            player.x = Math.max(0, Math.min(config.width - player.width, player.x));
            player.y = Math.max(0, Math.min(config.height - player.height, player.y));
        }
        
        // æ›´æ–°å­å¼¹
        function updateBullets() {
            gameState.bullets = gameState.bullets.filter(bullet => {
                bullet.y -= bullet.speed;
                return bullet.y > -bullet.height;
            });
        }
        
        // æ›´æ–°æ•Œäºº
        function updateEnemies(now) {
            // ç”Ÿæˆæ•Œäºº
            if (now - gameState.lastEnemySpawn > config.enemySpawnRate && gameState.enemies.length < config.maxEnemies) {
                const type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                const enemy = {
                    x: Math.random() * (config.width - 40),
                    y: -40,
                    width: 40,
                    height: 40,
                    speed: config.enemySpeed * type.speed,
                    type: type,
                    health: type.health,
                    angle: 0
                };
                gameState.enemies.push(enemy);
                gameState.lastEnemySpawn = now;
            }
            
            // æ›´æ–°æ•Œäººä½ç½®
            gameState.enemies = gameState.enemies.filter(enemy => {
                enemy.y += enemy.speed;
                enemy.angle += 0.1;
                return enemy.y < config.height + enemy.height;
            });
        }
        
        // æ›´æ–°å¥–åŠ±
        function updateBonuses(now) {
            // ç”Ÿæˆå¥–åŠ±
            if (now - gameState.lastBonusSpawn > config.bonusSpawnRate && gameState.bonuses.length < config.maxBonuses) {
                const type = bonusTypes[Math.floor(Math.random() * bonusTypes.length)];
                const bonus = {
                    x: Math.random() * (config.width - 30),
                    y: -30,
                    width: 30,
                    height: 30,
                    speed: config.bonusSpeed,
                    type: type,
                    pulse: 0
                };
                gameState.bonuses.push(bonus);
                gameState.lastBonusSpawn = now;
            }
            
            // æ›´æ–°å¥–åŠ±ä½ç½®
            gameState.bonuses = gameState.bonuses.filter(bonus => {
                bonus.y += bonus.speed;
                bonus.pulse += 0.2;
                return bonus.y < config.height + bonus.height;
            });
        }
        
        // ç¢°æ’æ£€æµ‹
        function checkCollisions() {
            // å­å¼¹ä¸æ•Œäººç¢°æ’
            gameState.bullets.forEach((bullet, bulletIndex) => {
                gameState.enemies.forEach((enemy, enemyIndex) => {
                    if (bullet.x < enemy.x + enemy.width &&
                        bullet.x + bullet.width > enemy.x &&
                        bullet.y < enemy.y + enemy.height &&
                        bullet.y + bullet.height > enemy.y) {
                        
                        // ç§»é™¤å­å¼¹
                        gameState.bullets.splice(bulletIndex, 1);
                        
                        // å‡å°‘æ•Œäººç”Ÿå‘½å€¼
                        enemy.health--;
                        
                        if (enemy.health <= 0) {
                            // ç§»é™¤æ•Œäºº
                            gameState.enemies.splice(enemyIndex, 1);
                            
                            // å¢åŠ åˆ†æ•°
                            gameState.score += enemy.type.points;
                            
                            // æ·»åŠ æ–‡æœ¬æ•ˆæœ
                            gameState.textEffects.push(new TextEffect(
                                enemy.x + enemy.width/2, 
                                enemy.y, 
                                '+' + enemy.type.points, 
                                '#00ff00'
                            ));
                            
                            playSound(hitSound);
                        }
                    }
                });
            });
            
            // ç©å®¶ä¸æ•Œäººç¢°æ’
            gameState.enemies.forEach((enemy, enemyIndex) => {
                if (player.x < enemy.x + enemy.width &&
                    player.x + player.width > enemy.x &&
                    player.y < enemy.y + enemy.height &&
                    player.y + player.height > enemy.y) {
                    
                    // ç§»é™¤æ•Œäºº
                    gameState.enemies.splice(enemyIndex, 1);
                    
                    // å‡å°‘ç”Ÿå‘½å€¼
                    gameState.health -= 20;
                    
                    // æ·»åŠ æ–‡æœ¬æ•ˆæœ
                    gameState.textEffects.push(new TextEffect(
                        player.x + player.width/2, 
                        player.y, 
                        '-20', 
                        '#ff0000'
                    ));
                    
                    if (gameState.health <= 0) {
                        endGame();
                    }
                }
            });
            
            // ç©å®¶ä¸å¥–åŠ±ç¢°æ’
            gameState.bonuses.forEach((bonus, bonusIndex) => {
                if (player.x < bonus.x + bonus.width &&
                    player.x + player.width > bonus.x &&
                    player.y < bonus.y + bonus.height &&
                    player.y + player.height > bonus.y) {
                    
                    // ç§»é™¤å¥–åŠ±
                    gameState.bonuses.splice(bonusIndex, 1);
                    
                    // åº”ç”¨å¥–åŠ±æ•ˆæœ
                    if (bonus.type.effect === 'health') {
                        gameState.health = Math.min(config.playerHealth, gameState.health + 20);
                        gameState.textEffects.push(new TextEffect(
                            player.x + player.width/2, 
                            player.y, 
                            '+20 HP', 
                            '#00ff00'
                        ));
                    } else {
                        gameState.score += bonus.type.points;
                        gameState.textEffects.push(new TextEffect(
                            player.x + player.width/2, 
                            player.y, 
                            '+' + bonus.type.points, 
                            '#ffff00'
                        ));
                    }
                    
                    playSound(bonusSound);
                }
            });
        }
        
        // æ›´æ–°æ¸¸æˆæ—¶é—´
        function updateGameTime(now) {
            if (now - gameState.lastTimeUpdate >= 1000) {
                gameState.timeLeft--;
                gameState.lastTimeUpdate = now;
                
                if (gameState.timeLeft <= 0) {
                    endGame();
                }
            }
        }
        
        // æ›´æ–°æ–‡æœ¬æ•ˆæœ
        function updateTextEffects() {
            gameState.textEffects = gameState.textEffects.filter(effect => effect.update());
        }
        
        // å°„å‡»
        function shoot() {
            const now = Date.now();
            if (now - gameState.lastBulletTime > config.bulletCooldown) {
                const bullet = {
                    x: player.x + player.width / 2 - 2,
                    y: player.y,
                    width: 4,
                    height: 10,
                    speed: config.bulletSpeed
                };
                gameState.bullets.push(bullet);
                gameState.lastBulletTime = now;
                playSound(shootSound);
            }
        }
        
        // æ’­æ”¾éŸ³æ•ˆ
        function playSound(audio) {
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(() => {});
            }
        }
        
        // ç»˜åˆ¶æ¸¸æˆ
        function draw() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, config.width, config.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            drawBackground();
            
            // ç»˜åˆ¶æ¸¸æˆå¯¹è±¡
            drawPlayer();
            drawBullets();
            drawEnemies();
            drawBonuses();
            drawTextEffects();
        }
        
        // ç»˜åˆ¶èƒŒæ™¯
        function drawBackground() {
            const gradient = ctx.createLinearGradient(0, 0, 0, config.height);
            gradient.addColorStop(0, '#1e3c72');
            gradient.addColorStop(1, '#2a5298');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, config.width, config.height);
            
            // ç»˜åˆ¶æ˜Ÿæ˜Ÿ
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            for (let i = 0; i < 50; i++) {
                const x = (i * 137.5) % config.width;
                const y = (i * 73.3 + Date.now() * 0.01) % config.height;
                ctx.fillRect(x, y, 1, 1);
            }
        }
        
        // ç»˜åˆ¶ç©å®¶
        function drawPlayer() {
            ctx.save();
            ctx.translate(player.x + player.width/2, player.y + player.height/2);
            ctx.font = '40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('ğŸ¦¸â€â™‚ï¸', 0, 0);
            ctx.restore();
        }
        
        // ç»˜åˆ¶å­å¼¹
        function drawBullets() {
            ctx.fillStyle = '#ffff00';
            ctx.shadowColor = '#ffff00';
            ctx.shadowBlur = 10;
            
            gameState.bullets.forEach(bullet => {
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
            });
            
            ctx.shadowBlur = 0;
        }
        
        // ç»˜åˆ¶æ•Œäºº
        function drawEnemies() {
            gameState.enemies.forEach(enemy => {
                ctx.save();
                ctx.translate(enemy.x + enemy.width/2, enemy.y + enemy.height/2);
                ctx.rotate(enemy.angle);
                ctx.font = '35px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(enemy.type.emoji, 0, 0);
                ctx.restore();
            });
        }
        
        // ç»˜åˆ¶å¥–åŠ±
        function drawBonuses() {
            gameState.bonuses.forEach(bonus => {
                ctx.save();
                ctx.translate(bonus.x + bonus.width/2, bonus.y + bonus.height/2);
                const scale = 1 + Math.sin(bonus.pulse) * 0.2;
                ctx.scale(scale, scale);
                ctx.font = '25px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(bonus.type.emoji, 0, 0);
                ctx.restore();
            });
        }
        
        // ç»˜åˆ¶æ–‡æœ¬æ•ˆæœ
        function drawTextEffects() {
            gameState.textEffects.forEach(effect => {
                effect.draw();
            });
        }
        
        // æ›´æ–°HUD
        function updateHUD() {
            scoreDisplay.textContent = gameState.score;
            timeDisplay.textContent = gameState.timeLeft;
            const healthPercent = (gameState.health / config.playerHealth) * 100;
            healthBar.style.width = healthPercent + '%';
        }
        
        // ç»“æŸæ¸¸æˆ
        function endGame() {
            gameState.isRunning = false;
            
            if (gameState.animationId) {
                cancelAnimationFrame(gameState.animationId);
            }
            
            // åœæ­¢éŸ³ä¹
            bgMusic.pause();
            playSound(gameOverSound);
            
            // éšè—æ¸¸æˆç•Œé¢
            gameHUD.style.display = 'none';
            joystick.style.display = 'none';
            controls.style.display = 'none';
            
            // æ˜¾ç¤ºæ¸¸æˆç»“æŸç•Œé¢
            finalScoreDisplay.textContent = gameState.score;
            finalTimeDisplay.textContent = config.gameTime - gameState.timeLeft;
            gameOverScreen.classList.remove('hidden');
        }
        
        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            startGame(true);
        }
        
        // è¿”å›ä¸»èœå•
        function backToMenu() {
            gameOverScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        }
        
        // æ‘‡æ†äº‹ä»¶å¤„ç†
        function setupJoystickControls() {
            const joystickBase = document.querySelector('.joystick-base');
            const joystickKnob = document.querySelector('.joystick-knob');
            
            function handleJoystickStart(e) {
                e.preventDefault();
                joystickData.active = true;
                
                const rect = joystickBase.getBoundingClientRect();
                joystickData.centerX = rect.width / 2;
                joystickData.centerY = rect.height / 2;
                joystickData.maxDistance = rect.width / 2 - 20;
            }
            
            function handleJoystickMove(e) {
                if (!joystickData.active) return;
                e.preventDefault();
                
                const rect = joystickBase.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                let x = clientX - rect.left;
                let y = clientY - rect.top;
                
                const distance = Math.sqrt((x - joystickData.centerX) ** 2 + (y - joystickData.centerY) ** 2);
                
                if (distance > joystickData.maxDistance) {
                    const angle = Math.atan2(y - joystickData.centerY, x - joystickData.centerX);
                    x = joystickData.centerX + Math.cos(angle) * joystickData.maxDistance;
                    y = joystickData.centerY + Math.sin(angle) * joystickData.maxDistance;
                }
                
                joystickData.currentX = x;
                joystickData.currentY = y;
                
                const knobSize = joystickKnob.offsetWidth / 2;
                joystickKnob.style.left = (x - knobSize) + 'px';
                joystickKnob.style.top = (y - knobSize) + 'px';
                joystickKnob.style.transform = 'none';
            }
            
            function handleJoystickEnd(e) {
                e.preventDefault();
                joystickData.active = false;
                joystickData.currentX = joystickData.centerX;
                joystickData.currentY = joystickData.centerY;
                
                joystickKnob.style.left = '50%';
                joystickKnob.style.top = '50%';
                joystickKnob.style.transform = 'translate(-50%, -50%)';
            }
            
            // è§¦æ‘¸äº‹ä»¶
            joystickBase.addEventListener('touchstart', handleJoystickStart, { passive: false });
            document.addEventListener('touchmove', handleJoystickMove, { passive: false });
            document.addEventListener('touchend', handleJoystickEnd, { passive: false });
            
            // é¼ æ ‡äº‹ä»¶ï¼ˆç”¨äºæ¡Œé¢æµ‹è¯•ï¼‰
            joystickBase.addEventListener('mousedown', handleJoystickStart);
            document.addEventListener('mousemove', handleJoystickMove);
            document.addEventListener('mouseup', handleJoystickEnd);
        }
        
        // å°„å‡»æŒ‰é’®äº‹ä»¶
        function setupShootButton() {
            function handleShoot(e) {
                e.preventDefault();
                if (gameState.isRunning) {
                    shoot();
                }
            }
            
            shootBtn.addEventListener('touchstart', handleShoot, { passive: false });
            shootBtn.addEventListener('mousedown', handleShoot);
            
            // é˜²æ­¢é•¿æŒ‰é‡å¤å°„å‡»
            let shootInterval;
            
            function startContinuousShoot(e) {
                e.preventDefault();
                if (gameState.isRunning) {
                    shoot();
                    shootInterval = setInterval(() => {
                        if (gameState.isRunning) {
                            shoot();
                        }
                    }, config.bulletCooldown);
                }
            }
            
            function stopContinuousShoot(e) {
                e.preventDefault();
                if (shootInterval) {
                    clearInterval(shootInterval);
                    shootInterval = null;
                }
            }
            
            // é•¿æŒ‰è¿ç»­å°„å‡»
            shootBtn.addEventListener('touchstart', startContinuousShoot, { passive: false });
            shootBtn.addEventListener('touchend', stopContinuousShoot, { passive: false });
            shootBtn.addEventListener('mousedown', startContinuousShoot);
            shootBtn.addEventListener('mouseup', stopContinuousShoot);
        }
        
        // é”®ç›˜æ§åˆ¶ï¼ˆç”¨äºæ¡Œé¢æµ‹è¯•ï¼‰
        function setupKeyboardControls() {
            document.addEventListener('keydown', (e) => {
                if (!gameState.isRunning) return;
                
                switch(e.code) {
                    case 'ArrowLeft':
                    case 'KeyA':
                        gameState.touchControls.left = true;
                        break;
                    case 'ArrowRight':
                    case 'KeyD':
                        gameState.touchControls.right = true;
                        break;
                    case 'ArrowUp':
                    case 'KeyW':
                        gameState.touchControls.up = true;
                        break;
                    case 'ArrowDown':
                    case 'KeyS':
                        gameState.touchControls.down = true;
                        break;
                    case 'Space':
                        e.preventDefault();
                        shoot();
                        break;
                }
            });
            
            document.addEventListener('keyup', (e) => {
                switch(e.code) {
                    case 'ArrowLeft':
                    case 'KeyA':
                        gameState.touchControls.left = false;
                        break;
                    case 'ArrowRight':
                    case 'KeyD':
                        gameState.touchControls.right = false;
                        break;
                    case 'ArrowUp':
                    case 'KeyW':
                        gameState.touchControls.up = false;
                        break;
                    case 'ArrowDown':
                    case 'KeyS':
                        gameState.touchControls.down = false;
                        break;
                }
            });
        }
        
        // å±å¹•æ–¹å‘å˜åŒ–å¤„ç†
        function setupOrientationChange() {
            function handleOrientationChange() {
                setTimeout(() => {
                    setupCanvas();
                    // é‡æ–°è®¡ç®—æ‘‡æ†ä½ç½®
                    if (joystickData.active) {
                        const rect = document.querySelector('.joystick-base').getBoundingClientRect();
                        joystickData.centerX = rect.width / 2;
                        joystickData.centerY = rect.height / 2;
                        joystickData.maxDistance = rect.width / 2 - 20;
                    }
                }, 100);
            }
            
            window.addEventListener('orientationchange', handleOrientationChange);
            window.addEventListener('resize', handleOrientationChange);
        }
        
        // é˜²æ­¢é»˜è®¤è¡Œä¸ºå’Œä¼˜åŒ–è§¦æ‘¸ä½“éªŒ
        function preventDefaults() {
            // é˜²æ­¢å³é”®èœå•
            document.addEventListener('contextmenu', e => e.preventDefault());
            
            // é˜²æ­¢æ–‡æœ¬é€‰æ‹©
            document.addEventListener('selectstart', e => e.preventDefault());
            
            // é˜²æ­¢æ‹–æ‹½
            document.addEventListener('dragstart', e => e.preventDefault());
            
            // é˜²æ­¢åŒå‡»ç¼©æ”¾
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // é˜²æ­¢æ»šåŠ¨
            document.addEventListener('touchmove', function(e) {
                if (e.target.closest('.legend')) {
                    return; // å…è®¸è¯´æ˜ç•Œé¢æ»šåŠ¨
                }
                e.preventDefault();
            }, { passive: false });
        }
        
        // æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–
        function setupPerformanceOptimization() {
            // æ£€æµ‹è®¾å¤‡æ€§èƒ½
            const isLowEndDevice = navigator.hardwareConcurrency <= 2 || 
                                   /Android.*Chrome\/[.0-9]*/.test(navigator.userAgent);
            
            if (isLowEndDevice) {
                // é™ä½æ¸¸æˆå¤æ‚åº¦
                config.maxEnemies = Math.max(3, config.maxEnemies - 2);
                config.enemySpawnRate += 200;
                config.maxBonuses = Math.max(1, config.maxBonuses - 1);
            }
            
            // å¸§ç‡ç›‘æ§
            let frameCount = 0;
            let lastTime = performance.now();
            
            function monitorFPS() {
                frameCount++;
                const currentTime = performance.now();
                
                if (currentTime - lastTime >= 1000) {
                    const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                    
                    // å¦‚æœå¸§ç‡è¿‡ä½ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–
                    if (fps < 30 && gameState.isRunning) {
                        config.maxEnemies = Math.max(2, config.maxEnemies - 1);
                        config.enemySpawnRate += 100;
                    }
                    
                    frameCount = 0;
                    lastTime = currentTime;
                }
                
                if (gameState.isRunning) {
                    requestAnimationFrame(monitorFPS);
                }
            }
            
            // å¼€å§‹ç›‘æ§
            monitorFPS();
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            setupCanvas();
            
            // ä½¿ç”¨è§¦æ‘¸å±å¹•ç›´æ¥æ§åˆ¶æ›¿ä»£æ‘‡æ†
            setupDirectTouchControl();
            setupImprovedShootButton();
            
            setupKeyboardControls();
            setupOrientationChange();
            preventDefaults();
            setupPerformanceOptimization();
            setupGameButtons();
            
            gameState.lastBonusSpawn = Date.now();
            
            console.log('ğŸ® å¡é€šå®‰å…¨å«å£«å°é£ä¾  - è§¦æ‘¸ç›´æ§ç‰ˆæœ¬å·²åŠ è½½å®Œæˆ!');
        }
        
        // è®¾ç½®æ¸¸æˆæŒ‰é’®çš„è§¦æ‘¸äº‹ä»¶
        function setupGameButtons() {
            // è·å–æ‰€æœ‰æ¸¸æˆæŒ‰é’®
            const gameButtons = document.querySelectorAll('.game-button');
            
            gameButtons.forEach(button => {
                // ä¸ºæ¯ä¸ªæŒ‰é’®æ·»åŠ è§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨
                button.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    // è§¦å‘ç‚¹å‡»äº‹ä»¶
                    this.click();
                }, { passive: false });
                
                // æ·»åŠ è§¦æ‘¸åé¦ˆæ•ˆæœ
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                button.addEventListener('touchend', function() {
                    this.style.transform = 'scale(1)';
                });
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initGame);
        
        // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†ï¼ˆèŠ‚çœç”µæ± ï¼‰
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && gameState.isRunning) {
                // é¡µé¢éšè—æ—¶æš‚åœæ¸¸æˆ
                bgMusic.pause();
            } else if (!document.hidden && gameState.isRunning) {
                // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤æ¸¸æˆ
                bgMusic.play().catch(() => {});
            }
        });
    </script>
</body>
</html>