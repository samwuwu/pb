<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HTML 实时运行工具</title>
    <style>
      /*
        页面样式定义

        我们选用清新的配色以及轻微的阴影和圆角，让整体界面显得美观舒适。
        同时加入过渡动画和交互反馈，让用户在操作时获得自然流畅的体验。
      */
      :root {
        --primary: #5b86e5; /* 主色：淡蓝渐变 */
        --secondary: #36d1dc; /* 辅助色：浅绿渐变 */
        --bg: #f0f4f8; /* 背景色：浅灰蓝 */
        --text: #333; /* 文本默认颜色 */
        --code-bg: #f7f9fc; /* 代码输入框背景 */
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.6;
      }

      header {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        padding: 40px 20px;
        text-align: center;
        color: #fff;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
      }

      header h1 {
        margin: 0 0 10px;
        font-size: 2em;
        font-weight: bold;
        letter-spacing: 1px;
      }

      header p {
        margin: 0;
        font-size: 1em;
        opacity: 0.9;
      }

      .container {
        max-width: 1000px;
        margin: -30px auto 40px;
        padding: 30px;
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
        animation: slideIn 0.6s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
      }

      textarea {
        width: 100%;
        min-height: 200px;
        padding: 10px;
        border: 1px solid #dde5ed;
        border-radius: 6px;
        background: var(--code-bg);
        font-family: Consolas, "Courier New", monospace;
        font-size: 14px;
        resize: vertical;
        outline: none;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(91, 134, 229, 0.2);
      }

      .btn-group {
        margin-top: 15px;
        display: flex;
        gap: 10px;
      }

      button {
        flex: 1;
        padding: 10px 20px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: background 0.3s;
      }

      button:hover {
        background: linear-gradient(135deg, var(--secondary), var(--primary));
      }

      button:active {
        transform: scale(0.98);
      }

      /* 按钮的点击涟漪效果 */
      button::after {
        content: "";
        position: absolute;
        left: 50%;
        top: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.4);
        transform: translate(-50%, -50%);
        border-radius: 50%;
        opacity: 0;
        transition: width 0.5s ease-out, height 0.5s ease-out, opacity 0.5s;
      }

      button:active::after {
        width: 200px;
        height: 200px;
        opacity: 1;
      }

      .iframe-container {
        margin-top: 25px;
        border: 1px solid #e0e6ed;
        border-radius: 6px;
        overflow: hidden;
        height: 400px;
        transition: height 0.3s;
      }

      /* 当预览内容加载后，渐显动画 */
      .iframe-container iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: #ffffff;
        opacity: 0;
        animation: fadeInIframe 0.5s forwards;
      }

      @keyframes fadeInIframe {
        to {
          opacity: 1;
        }
      }

      .share-section {
        margin-top: 20px;
        display: none;
        padding: 15px;
        background: #fafbff;
        border: 1px dashed #c5d0e6;
        border-radius: 6px;
      }

      .share-section p {
        margin: 0 0 10px;
        font-weight: bold;
      }

      .share-link {
        word-break: break-all;
        color: var(--primary);
        text-decoration: none;
      }

      .share-link:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>HTML 实时运行工具</h1>
      <p>在左侧输入 HTML 代码，点击运行即可实时预览，同时生成分享链接！</p>
    </header>
    <div class="container">
      <label for="code">输入 HTML 代码：</label>
      <textarea
        id="code"
        placeholder="例如：&lt;h1&gt;你好，世界！&lt;/h1&gt;\n&lt;p&gt;在这里编写你的 HTML 代码&lt;/p&gt;"
      ><!-- 示例代码，可以删除或修改 -->
<h1>欢迎使用 HTML 实时运行工具</h1>
<p>在左侧输入你的 HTML 代码，点击运行即可在下方实时预览效果。</p>
</textarea>
      <div class="btn-group">
        <button id="runBtn">运行代码</button>
        <button id="shareBtn">生成分享链接</button>
        <button id="downloadBtn">下载结果页面</button>
      </div>
      <div class="share-section" id="shareContainer">
        <p>分享链接：</p>
        <a href="#" target="_blank" id="shareLink" class="share-link"></a>
      </div>
      <div class="iframe-container">
        <iframe id="preview" sandbox="allow-same-origin allow-scripts"></iframe>
      </div>
    </div>
    <script>
      (function () {
        // 获取 DOM 元素
        const runBtn = document.getElementById("runBtn");
        const shareBtn = document.getElementById("shareBtn");
        const codeInput = document.getElementById("code");
        const preview = document.getElementById("preview");
        const shareContainer = document.getElementById("shareContainer");
        const shareLink = document.getElementById("shareLink");

        /**
         * 运行 HTML 代码并在 iframe 中展示
         */
        function runCode() {
          let code = codeInput.value;
          // 如果用户的 HTML 中没有声明字符集，自动添加 UTF‑8 声明，避免中文乱码
          // 如果用户没有包含 <html> 标签，则自动添加基础的 HTML 文档结构
          if (!/<html[\s>]/i.test(code)) {
            // 包装成完整的 HTML，加入 UTF-8 charset
            code = `<!DOCTYPE html>\n<html lang="zh-CN"><head><meta charset="UTF-8"></head><body>${code}</body></html>`;
          } else {
            // 如果用户提供了完整文档但没有 charset，则在开头加入 meta 声明
            if (!/<meta\s+charset/i.test(code) && !/<meta\s+http-equiv="?content-type"?/i.test(code)) {
              code = `<meta charset="UTF-8">\n${code}`;
            }
          }
          // 使用 Blob 创建临时 URL，提高安全性，避免直接设置 srcdoc 带来的 CSP 限制
          const blob = new Blob([code], { type: "text/html;charset=utf-8" });
          const url = URL.createObjectURL(blob);

          // 在当前页面更新预览（方便在原页面查看），并记录当前运行页面的 URL
          preview.src = url;
          preview.onload = function () {
            // 加载完成后释放对象 URL，避免内存泄漏
            URL.revokeObjectURL(url);
          };

          // 在新标签页打开运行结果（用户交互时）
          // 如果 global 标志 _skipNewWindow 为 true，则仅在页面内更新预览，不打开新标签页。
          if (!window._skipNewWindow) {
            try {
              const newWindow = window.open(url, "_blank");
              // 兼容部分浏览器弹窗拦截
              if (!newWindow) {
                alert(
                  "浏览器阻止了新页面的打开，请检查浏览器的弹窗设置或允许弹窗后重新运行。"
                );
              }
            } catch (e) {
              console.error(e);
            }
          }

          // 记录当前运行页面的代码，方便生成分享链接（分享运行后的独立页面）
          window._latestRunCode = code;
        }

        /**
         * 生成分享链接
         * 将用户输入的 HTML 代码使用 Base64 编码并附加到当前页面的查询参数中
         */
        function generateShareLink() {
          // 优先使用最近运行的代码，如果没有运行过则使用当前输入框中的代码
          const code = window._latestRunCode || codeInput.value;
          try {
            // 先补全文档结构，确保字符集声明
            let htmlCode = code;
            if (!/<html[\s>]/i.test(htmlCode)) {
              htmlCode = `<!DOCTYPE html>\n<html lang="zh-CN"><head><meta charset="UTF-8"></head><body>${htmlCode}</body></html>`;
            } else if (!/<meta\s+charset/i.test(htmlCode) && !/<meta\s+http-equiv="?content-type"?/i.test(htmlCode)) {
              htmlCode = `<meta charset="UTF-8">\n${htmlCode}`;
            }
            // Base64 编码，用于构建 run.html 的查询参数
            const encoded = btoa(unescape(encodeURIComponent(htmlCode)));
            // 生成指向运行页面的链接，run.html 会根据 code 参数解码并展示 HTML
            const shareUrl = `run.html?code=${encoded}`;
            shareLink.href = shareUrl;
            shareLink.textContent = shareUrl;
            shareContainer.style.display = "block";
          } catch (e) {
            alert("生成分享链接失败，请检查代码内容是否过大或包含无效字符。");
          }
        }

        /**
         * 页面加载时，如检测到 URL 中携带 code 参数，则解析并自动填充并运行
         */
        function loadSharedCode() {
          const params = new URLSearchParams(window.location.search);
          if (params.has("code")) {
            try {
              const decoded = decodeURIComponent(
                escape(atob(params.get("code")))
              );
              codeInput.value = decoded;
              runCode();
              // 显示生成的分享链接，方便用户再次分享
              const currentUrl = window.location.href;
              shareLink.href = currentUrl;
              shareLink.textContent = currentUrl;
              shareContainer.style.display = "block";
            } catch (e) {
              console.error("解析分享链接失败：", e);
            }
          }
        }

        // 事件绑定
        runBtn.addEventListener("click", function () {
          runCode();
        });
        shareBtn.addEventListener("click", function () {
          generateShareLink();
        });
        const downloadBtn = document.getElementById("downloadBtn");
        downloadBtn.addEventListener("click", function () {
          downloadHtml();
        });

        /**
         * 生成一个包含用户代码的 HTML 文件并触发下载。
         * 这样用户可以将该文件发送给他人，别人直接打开即可查看运行结果。
         */
        function downloadHtml() {
          const code = window._latestRunCode || codeInput.value;
          if (!code) {
            alert("请先输入并运行代码，再下载页面。");
            return;
          }
          // 构建完整的 HTML 文档
          let html = code;
          if (!/<html[\s>]/i.test(html)) {
            html = `<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"></head><body>${html}</body></html>`;
          } else if (!/<meta\s+charset/i.test(html) && !/<meta\s+http-equiv="?content-type"?/i.test(html)) {
            html = `<meta charset="UTF-8">\n${html}`;
          }
          // 创建 Blob 并下载
          const blob = new Blob([html], { type: "text/html;charset=utf-8" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "my-html-code.html";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }

        // 初始化，从分享链接加载代码
        loadSharedCode();
        // 初始运行示例代码
        // 为了避免页面加载时自动打开新标签，设置跳过标志
        window._skipNewWindow = true;
        runCode();
        window._skipNewWindow = false;
      })();
    </script>
  </body>
</html>