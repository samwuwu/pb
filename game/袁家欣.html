<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æœºåœºå®‰æ£€å¤§æŒ‘æˆ˜</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        #gameContainer {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        .page {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.5s ease;
        }
        #startPage {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            z-index: 10;
            padding: 20px;
        }
        /* éš¾åº¦é€‰æ‹©å¼¹çª— */
        #difficultyModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .difficulty-modal-content {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 35px;
            height: 35px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background: rgba(255, 107, 107, 0.8);
            transform: scale(1.1);
        }
        
        #gamePage {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 5;
            display: none;
            padding: 5px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            position: relative;
            overflow: hidden;
        }
        #gameCanvas {
            display: block;
            margin: 2px auto;
            background: linear-gradient(45deg, #e6f7ff, #f0f8ff);
            border: 3px solid #fff;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            cursor: crosshair;
            touch-action: none;
            max-width: 98vw;
            max-height: 85vh;
            position: relative;
            z-index: 10;
        }
        .airplane-icon {
            width: min(120px, 25vw);
            height: min(120px, 25vw);
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: float 3s ease-in-out infinite;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2), inset 0 2px 10px rgba(255, 255, 255, 0.5);
            position: relative;
        }
        
        .airplane-icon::before {
            content: 'âœˆ';
            font-size: min(60px, 12vw);
            color: #667eea;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-15px) scale(1.05); }
        }
        .airplane-icon:hover {
            transform: scale(1.1);
            animation: none;
        }
        .start-title {
            color: white;
            font-size: clamp(1.8rem, 8vw, 3rem);
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
            font-weight: 700;
            text-align: center;
            background: linear-gradient(45deg, #fff, #e0e0e0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .start-button {
            padding: 15px 30px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            color: #667eea;
            border: none;
            border-radius: 30px;
            font-size: clamp(1rem, 4vw, 1.3rem);
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), inset 0 2px 10px rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            min-height: 50px;
            min-width: 140px;
            position: relative;
            overflow: hidden;
        }
        .start-button:hover, .start-button:active {
            background: linear-gradient(145deg, #667eea, #5a6fd8);
            color: white;
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
        }
        
        .start-button::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.6s;
            opacity: 0;
        }
        
        .start-button:hover::before {
            opacity: 1;
            animation: shimmer 0.6s ease-out;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        #gameInfo {
            text-align: center;
            margin: 2px auto 5px auto;
            max-width: min(98vw, 800px);
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 15;
        }
        
        #gameInfo p {
            margin: 0;
            font-size: clamp(0.85rem, 3.5vw, 1rem);
            font-weight: 600;
        }
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            display: none;
            z-index: 100;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 90vw;
        }
        /* éš¾åº¦é€‰æ‹©é¡µé¢æ ·å¼ */
        .difficulty-title {
            color: white;
            font-size: clamp(1.5rem, 5vw, 2rem);
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
            font-weight: 700;
            text-align: center;
        }
        
        .difficulty-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .difficulty-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            min-height: 180px;
        }
        
        .difficulty-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }
        
        .difficulty-card.selected {
            border-color: #667eea;
            background: linear-gradient(145deg, rgba(102, 126, 234, 0.1), rgba(255, 255, 255, 0.9));
        }
        
        .difficulty-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .difficulty-name {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        
        .difficulty-desc {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.3;
            margin-bottom: 10px;
        }
        
        .difficulty-stats {
            font-size: 0.75rem;
            color: #888;
        }
        
        .difficulty-confirm {
            padding: 12px 25px;
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: clamp(0.9rem, 3.5vw, 1.1rem);
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            min-height: 45px;
            min-width: 140px;
            opacity: 0.5;
            pointer-events: none;
        }
        
        .difficulty-confirm.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .difficulty-confirm.active:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
        }
        
        /* å€’è®¡æ—¶æ ·å¼ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }
        
        .countdown-content {
            text-align: center;
            color: white;
        }
        
        .countdown-number {
            font-size: clamp(5rem, 20vw, 8rem);
            font-weight: 900;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            animation: countdownPulse 1s ease-in-out;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .countdown-text {
            font-size: clamp(1.2rem, 5vw, 1.8rem);
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .countdown-difficulty {
            font-size: clamp(1rem, 4vw, 1.4rem);
            opacity: 0.7;
            font-style: italic;
        }
        
        @keyframes countdownPulse {
            0% {
                transform: scale(1.2);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @media (max-width: 768px) {
            .difficulty-modal-content {
                margin: 10px;
                padding: 20px;
            }
            
            .difficulty-cards {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
            
            .difficulty-card {
                padding: 15px 10px;
                min-height: 150px;
            }
        }
        #ammoDisplay {
            position: absolute;
            top: max(10px, env(safe-area-inset-top));
            right: 10px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(240, 240, 240, 0.9));
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: clamp(14px, 3vw, 16px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 20;
        }
        .simple-instructions {
            color: rgba(255, 255, 255, 0.95);
            text-align: center;
            max-width: min(90vw, 500px);
            margin: 20px auto;
            line-height: 1.8;
            font-size: clamp(0.9rem, 3.5vw, 1.1rem);
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .back-button {
            position: absolute;
            top: max(10px, env(safe-area-inset-top));
            left: 10px;
            padding: 12px 20px;
            background: linear-gradient(145deg, #ff6b6b, #ee5a6f);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            z-index: 30;
            font-weight: 600;
            font-size: clamp(12px, 3vw, 14px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            min-height: 40px;
        }
        
        .back-button:hover, .back-button:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(145deg, #ff5252, #e53e3e);
        }
        .danger-tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border: 2px solid #ff4757;
            border-radius: 8px;
            font-size: clamp(10px, 2.5vw, 12px);
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            max-width: 200px;
            word-wrap: break-word;
        }
        
        /* ç§»åŠ¨ç«¯ä¸“ç”¨æ ·å¼ */
        @media (max-width: 768px) {
            #gameCanvas {
                width: 98vw;
                height: auto;
                max-height: 70vh;
            }
            
            .start-title {
                margin-bottom: 15px;
            }
            
            .simple-instructions {
                margin: 15px auto;
                padding: 15px;
                font-size: 0.9rem;
            }
            
            #gameInfo {
                padding: 5px 10px;
                margin: 2px auto;
            }
        }
        
        @media (max-width: 480px) {
            .start-title {
                font-size: 1.8rem;
            }
            
            .start-button {
                padding: 12px 25px;
                font-size: 1rem;
            }
            
            #gameCanvas {
                max-height: 65vh;
            }
        }
        
        /* å³ä¸‹è§’æ‚¬æµ®æŒ‰é’®ç»„ */
        .floating-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 50;
        }
        
        .floating-button {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .floating-button:hover, .floating-button:active {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        
        .audio-control-btn {
            background: linear-gradient(145deg, #667eea, #764ba2);
        }
        
        .audio-control-btn.muted {
            background: linear-gradient(145deg, #ff6b6b, #ee5a6f);
        }
        
        .reload-control-btn {
            background: linear-gradient(145deg, #4ecdc4, #44a08d);
        }
        
        /* æ·»åŠ ä¸€äº›è£…é¥°æ€§æ ·å¼ */
        .floating-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        
        /* æ¸¸æˆé¡µé¢ç½‘æ ¼èƒŒæ™¯ */
        #gamePage::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            z-index: 1;
        }
        
        @keyframes gridMove {
            0% {
                transform: translate(0, 0);
            }
            100% {
                transform: translate(50px, 50px);
            }
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: float-particle 10s linear infinite;
        }
        
        @keyframes float-particle {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* ä¼˜åŒ–æŒ‰é’®æ ·å¼ */
        button, select {
            font-family: inherit;
        }
        
        #reloadBtn, #restartBtn {
            padding: 10px 20px;
            background: linear-gradient(145deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            font-size: clamp(12px, 3vw, 14px);
            min-height: 40px;
        }
        
        #reloadBtn:hover, #reloadBtn:active,
        #restartBtn:hover, #restartBtn:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            background: linear-gradient(145deg, #3cb7b0, #339999);
        }
        
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: white;
            font-size: clamp(12px, 3vw, 14px);
            outline: none;
            cursor: pointer;
        }
        
        select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- å¼€å§‹é¡µé¢ -->
        <div id="startPage" class="page">
            <div class="floating-particles" id="particles"></div>
            <h1 class="start-title">æœºåœºå®‰æ£€å¤§æŒ‘æˆ˜</h1>
            <div class="airplane-icon" id="airplaneIcon"></div>
            <div class="simple-instructions">
                <p>ğŸ›¡ï¸ å‡»æ‰“ç¦æ­¢è¿‡å®‰æ£€çš„ç‰©å“ï¼Œæ”¾è¡Œåˆè§„ç‰©å“</p>
                <p>ğŸ¯ å‡»ä¸­å±é™©ç‰©å“è·å¾—åˆ†æ•°+2å‘å­å¼¹</p>
                <p>â° æ¯å…³é™æ—¶45ç§’ï¼Œæ—¶é—´åˆ°è‡ªåŠ¨é€šå…³</p>
                <p>ğŸ“± æ”¯æŒè§¦å±æ“ä½œï¼Œä½“éªŒæ›´æµç•…</p>
            </div>
            <button class="start-button" id="startButton">å¼€å§‹æ¸¸æˆ</button>
        </div>
        
        <!-- éš¾åº¦é€‰æ‹©å¼¹çª— -->
        <div id="difficultyModal">
            <div class="difficulty-modal-content">
                <button class="modal-close" id="modalClose">âœ•</button>
                <h2 class="difficulty-title">é€‰æ‹©éš¾åº¦</h2>
                <div class="difficulty-cards">
                    <div class="difficulty-card" data-difficulty="easy">
                        <div class="difficulty-icon">ğŸ˜Š</div>
                        <div class="difficulty-name">ç®€å•</div>
                        <div class="difficulty-desc">é€‚åˆæ–°æ‰‹ï¼Œç‰©å“ç§»åŠ¨è¾ƒæ…¢ï¼Œå¼¹è¯å……è¶³</div>
                        <div class="difficulty-stats">ç”Ÿå‘½: 5 | å¼¹è¯: 15 | é€Ÿåº¦: 0.8x</div>
                    </div>
                    <div class="difficulty-card" data-difficulty="normal">
                        <div class="difficulty-icon">ğŸ˜</div>
                        <div class="difficulty-name">æ™®é€š</div>
                        <div class="difficulty-desc">æ ‡å‡†éš¾åº¦ï¼Œéœ€è¦å‡†ç¡®å°„å‡»</div>
                        <div class="difficulty-stats">ç”Ÿå‘½: 3 | å¼¹è¯: 10 | é€Ÿåº¦: 1.0x</div>
                    </div>
                    <div class="difficulty-card" data-difficulty="hard">
                        <div class="difficulty-icon">ğŸ˜¤</div>
                        <div class="difficulty-name">å›°éš¾</div>
                        <div class="difficulty-desc">é«˜éš¾åº¦æŒ‘æˆ˜ï¼Œå¼¹è¯æœ‰é™</div>
                        <div class="difficulty-stats">ç”Ÿå‘½: 2 | å¼¹è¯: 8 | é€Ÿåº¦: 1.3x</div>
                    </div>
                    <div class="difficulty-card" data-difficulty="expert">
                        <div class="difficulty-icon">ğŸ˜±</div>
                        <div class="difficulty-name">ä¸“å®¶</div>
                        <div class="difficulty-desc">æé™æŒ‘æˆ˜ï¼Œå¼¹è¯ç¨€å°‘</div>
                        <div class="difficulty-stats">ç”Ÿå‘½: 1 | å¼¹è¯: 6 | é€Ÿåº¦: 1.6x</div>
                    </div>
                </div>
                <button class="difficulty-confirm" id="difficultyConfirm">ç¡®è®¤é€‰æ‹©</button>
            </div>
        </div>
        
        <!-- å€’è®¡æ—¶é®ç½© -->
        <div id="countdownOverlay" class="countdown-overlay">
            <div class="countdown-content">
                <div class="countdown-number" id="countdownNumber">3</div>
                <div class="countdown-text">æ¸¸æˆå³å°†å¼€å§‹</div>
                <div class="countdown-difficulty" id="countdownDifficulty">éš¾åº¦: æ™®é€š</div>
            </div>
        </div>

        <!-- æ¸¸æˆé¡µé¢ -->
        <div id="gamePage" class="page">
            <div class="floating-particles" id="gamePageParticles"></div>
            <button class="back-button" id="backButton">è¿”å›é¦–é¡µ</button>
            <div id="gameInfo">
                <p>ç”Ÿå‘½: <span id="lives">3</span> | åˆ†æ•°: <span id="score">0</span> | å…³å¡: <span id="level">1</span> | å¼¹è¯: <span id="ammo">10</span> | æ—¶é—´: <span id="timeLeft">45</span>s | éš¾åº¦: <span id="currentDifficulty">æ™®é€š</span></p>
            </div>
            <div id="ammoDisplay">å¼¹è¯: <span id="ammoCount">10</span></div>
            <canvas id="gameCanvas" width="900" height="700"></canvas>
            
            <!-- å³ä¸‹è§’æ‚¬æµ®æ§åˆ¶ -->
            <div class="floating-controls" id="floatingControls">
                <button class="floating-button audio-control-btn" id="audioControlBtn">ğŸ”Š</button>
            </div>
            
            <div id="gameOver" class="game-over">
                <h2>ğŸ® æ¸¸æˆç»“æŸ</h2>
                <p>æœ€ç»ˆåˆ†æ•°: <span id="finalScore">0</span></p>
                <button id="restartBtn">ğŸ”„ é‡æ–°å¼€å§‹</button>
            </div>
            <div id="tooltip" class="danger-tooltip" style="display: none;"></div>
        </div>
    </div>
    
    <!-- éŸ³æ•ˆç³»ç»Ÿ -->
    <div id="audioSystem" style="display: none;">
        <!-- ä½¿ç”¨Web Audio APIç”ŸæˆéŸ³æ•ˆ -->
    </div>

    <script>
        // é¡µé¢åˆ‡æ¢æ§åˆ¶
        const startPage = document.getElementById('startPage');
        const difficultyModal = document.getElementById('difficultyModal');
        const gamePage = document.getElementById('gamePage');
        const countdownOverlay = document.getElementById('countdownOverlay');
        const airplaneIcon = document.getElementById('airplaneIcon');
        const startButton = document.getElementById('startButton');
        const backButton = document.getElementById('backButton');
        const difficultyConfirm = document.getElementById('difficultyConfirm');
        const modalClose = document.getElementById('modalClose');
        let selectedDifficulty = 'normal';
        
        // éŸ³æ•ˆç³»ç»Ÿ
        class AudioSystem {
            constructor() {
                this.context = null;
                this.enabled = true;
                this.sounds = {};
                this.initAudioContext();
            }
            
            initAudioContext() {
                try {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('éŸ³é¢‘ä¸æ”¯æŒ');
                    this.enabled = false;
                }
            }
            
            createBeep(frequency, duration, type = 'sine') {
                if (!this.enabled || !this.context) return;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.3, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + duration);
                
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + duration);
            }
            
            playShoot() {
                this.createBeep(800, 0.1, 'square');
            }
            
            playHit() {
                this.createBeep(300, 0.2, 'sawtooth');
            }
            
            playReload() {
                setTimeout(() => this.createBeep(400, 0.1), 0);
                setTimeout(() => this.createBeep(500, 0.1), 100);
                setTimeout(() => this.createBeep(600, 0.1), 200);
            }
            
            playGameOver() {
                for(let i = 0; i < 5; i++) {
                    setTimeout(() => this.createBeep(200 - i * 30, 0.3), i * 100);
                }
            }
            
            playSuccess() {
                setTimeout(() => this.createBeep(523, 0.1), 0);   // C
                setTimeout(() => this.createBeep(659, 0.1), 100); // E
                setTimeout(() => this.createBeep(784, 0.2), 200); // G
            }
            
            toggle() {
                this.enabled = !this.enabled;
                return this.enabled;
            }
        }
        
        const audioSystem = new AudioSystem();
        
        // åˆ›å»ºæµ®åŠ¨ç²’å­æ•ˆæœ
        function createFloatingParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 10 + 's';
                particle.style.animationDuration = (Math.random() * 5 + 5) + 's';
                particlesContainer.appendChild(particle);
            }
        }
        
        // åˆ›å»ºæ¸¸æˆé¡µé¢èƒŒæ™¯ç²’å­æ•ˆæœ
        function createGamePageParticles() {
            const gamePageParticlesContainer = document.getElementById('gamePageParticles');
            if (!gamePageParticlesContainer) return;
            
            // æ¸…é™¤ç°æœ‰ç²’å­
            gamePageParticlesContainer.innerHTML = '';
            
            for (let i = 0; i < 25; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 10 + 's';
                particle.style.animationDuration = (Math.random() * 6 + 8) + 's';
                
                // æ¸¸æˆé¡µé¢ä½¿ç”¨ä¸åŒçš„é¢œè‰²
                const colors = ['rgba(255, 255, 255, 0.4)', 'rgba(135, 206, 235, 0.5)', 'rgba(72, 219, 251, 0.3)', 'rgba(16, 185, 129, 0.4)'];
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                // ä¸åŒå¤§å°çš„ç²’å­
                const size = Math.random() * 3 + 2;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                
                gamePageParticlesContainer.appendChild(particle);
            }
        }
        
        // åˆå§‹åŒ–æµ®åŠ¨ç²’å­
        createFloatingParticles();
        
        // éŸ³æ•ˆæ§åˆ¶
        const audioControlBtn = document.getElementById('audioControlBtn');
        if (audioControlBtn) {
            audioControlBtn.addEventListener('click', function() {
                const enabled = audioSystem.toggle();
                this.textContent = enabled ? 'ğŸ”Š' : 'ğŸ”‡';
                this.classList.toggle('muted', !enabled);
                audioSystem.createBeep(enabled ? 800 : 400, 0.1);
            });
        }
        
        // éš¾åº¦é€‰æ‹©åŠŸèƒ½
        const difficultyCards = document.querySelectorAll('.difficulty-card');
        difficultyCards.forEach(card => {
            card.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰å·²é€‰ä¸­çš„çŠ¶æ€
                difficultyCards.forEach(c => c.classList.remove('selected'));
                // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
                this.classList.add('selected');
                selectedDifficulty = this.dataset.difficulty;
                
                // æ¿€æ´»ç¡®è®¤æŒ‰é’®
                difficultyConfirm.classList.add('active');
                
                // æ’­æ”¾é€‰æ‹©éŸ³æ•ˆ
                audioSystem.createBeep(600, 0.1);
            });
        });
        
        // é»˜è®¤é€‰ä¸­æ™®é€šéš¾åº¦
        document.querySelector('[data-difficulty="normal"]').classList.add('selected');
        difficultyConfirm.classList.add('active');
        
        // å¼¹çª—æ§åˆ¶
        function showDifficultyModal() {
            difficultyModal.style.display = 'flex';
            audioSystem.createBeep(800, 0.2);
        }
        
        function hideDifficultyModal() {
            difficultyModal.style.display = 'none';
        }
        
        modalClose.addEventListener('click', hideDifficultyModal);
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
        difficultyModal.addEventListener('click', function(e) {
            if (e.target === this) {
                hideDifficultyModal();
            }
        });
        
        // å€’è®¡æ—¶åŠŸèƒ½
        function startCountdown(difficulty) {
            const difficultyNames = {
                'easy': 'ç®€å•',
                'normal': 'æ™®é€š', 
                'hard': 'å›°éš¾',
                'expert': 'ä¸“å®¶'
            };
            
            document.getElementById('countdownDifficulty').textContent = `éš¾åº¦: ${difficultyNames[difficulty]}`;
            countdownOverlay.style.display = 'flex';
            
            let count = 3;
            const countdownNumber = document.getElementById('countdownNumber');
            
            // ç«‹å³æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ•°å­—
            countdownNumber.textContent = count;
            countdownNumber.style.animation = 'countdownPulse 1s ease-in-out';
            audioSystem.createBeep(600 + count * 100, 0.3);
            
            const countdown = setInterval(() => {
                count--;
                
                if (count > 0) {
                    // æ˜¾ç¤ºå‰©ä½™æ•°å­—
                    countdownNumber.textContent = count;
                    countdownNumber.style.animation = 'none';
                    // è§¦å‘é‡æ–°æ’­æ”¾åŠ¨ç”»
                    setTimeout(() => {
                        countdownNumber.style.animation = 'countdownPulse 1s ease-in-out';
                    }, 10);
                    
                    // æ’­æ”¾å€’è®¡æ—¶éŸ³æ•ˆ
                    audioSystem.createBeep(600 + count * 100, 0.3);
                } else {
                    // å€’è®¡æ—¶ç»“æŸ
                    clearInterval(countdown);
                    countdownNumber.textContent = 'å¼€å§‹!';
                    countdownNumber.style.animation = 'none';
                    setTimeout(() => {
                        countdownNumber.style.animation = 'countdownPulse 1s ease-in-out';
                    }, 10);
                    
                    // æ’­æ”¾å¼€å§‹éŸ³æ•ˆ
                    audioSystem.playSuccess();
                    
                    // å»¶è¿Ÿ500msåè¿›å…¥æ¸¸æˆ
                    setTimeout(() => {
                        countdownOverlay.style.display = 'none';
                        
                        // ç¡®ä¿éšè—é¦–é¡µ
                        startPage.style.display = 'none';
                        
                        // æ˜¾ç¤ºæ¸¸æˆé¡µé¢
                        gamePage.style.display = 'flex';
                        
                        
                        // åˆ›å»ºæ¸¸æˆé¡µé¢èƒŒæ™¯ç²’å­
                        createGamePageParticles();
                        
                        // ç¡®ä¿é¡µé¢å®Œå…¨æ˜¾ç¤ºåå†åˆå§‹åŒ–æ¸¸æˆ
                        setTimeout(() => {
                            initGame();
                        }, 100);
                    }, 500);
                }
            }, 1000);
        }
        
        airplaneIcon.addEventListener('click', function() {
            this.style.animation = 'none';
            this.style.transform = 'scale(1.5)';
            showDifficultyModal();
        });
        
        startButton.addEventListener('click', function() {
            showDifficultyModal();
        });
        
        difficultyConfirm.addEventListener('click', function() {
            if (!this.classList.contains('active')) return;
            
            hideDifficultyModal();
            
            // ç«‹å³éšè—é¦–é¡µï¼Œé˜²æ­¢é¡µé¢åˆ‡æ¢é—®é¢˜
            startPage.style.display = 'none';
            
            startCountdown(selectedDifficulty);
        });
        
        backButton.addEventListener('click', function() {
            audioSystem.createBeep(400, 0.2);
            gamePage.style.display = 'none';
            startPage.style.display = 'flex';
            startPage.style.transform = 'translateY(0)';
            airplaneIcon.style.animation = 'float 3s ease-in-out infinite';
            airplaneIcon.style.transform = 'scale(1)';
            
            // å…³é—­å¯èƒ½æ‰“å¼€çš„å¼¹çª—
            hideDifficultyModal();
            countdownOverlay.style.display = 'none';
        });

        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
        function isMobileDevice() {
            return /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (window.innerWidth <= 768);
        }
        
        // åŠ¨æ€è°ƒæ•´ç”»å¸ƒå¤§å°
        function resizeCanvas() {
            const canvas = document.getElementById('gameCanvas');
            if (!canvas) return;
            
            let canvasWidth, canvasHeight;
            
            if (isMobileDevice()) {
                // ç§»åŠ¨ç«¯é€‚é… - æœ€å¤§åŒ–æ¸¸æˆåŒºåŸŸ
                canvasWidth = Math.min(window.innerWidth * 0.98, 900);
                canvasHeight = Math.min(window.innerHeight * 0.8, 700);
            } else {
                // æ¡Œé¢ç«¯ - æ›´å¤§çš„æ¸¸æˆåŒºåŸŸ
                canvasWidth = 900;
                canvasHeight = 700;
            }
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            canvas.style.width = canvasWidth + 'px';
            canvas.style.height = canvasHeight + 'px';
        }
        
        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('orientationchange', () => {
            setTimeout(resizeCanvas, 100);
        });
        
        // ==================== æ¸¸æˆæ ¸å¿ƒä»£ç  ====================
        function initGame() {
            // è°ƒæ•´ç”»å¸ƒå¤§å°
            resizeCanvas();
            // ç‰©å“æ•°æ®åº“ - æ‰©å……ç‰ˆ
            const items = {
                // === ç¦æ­¢æºå¸¦ç‰©å“ (éœ€è¦å‡»æ‰“) ===
                
                // æ­¦å™¨ç±»
                knife: {
                    name: "åˆ€å…·",
                    desc: "ç¦æ­¢æºå¸¦ï¼šä»»ä½•é•¿åº¦çš„åˆ€å…·éƒ½ç¦æ­¢éšèº«æºå¸¦ç™»æœº",
                    color: "#dc143c",
                    type: "danger",
                    reward: 10,
                    speed: 2.5,
                    health: 1
                },
                gun: {
                    name: "æªæ”¯",
                    desc: "ç¦æ­¢æºå¸¦ï¼šä»»ä½•ç±»å‹çš„æªæ”¯éƒ½ç¦æ­¢æºå¸¦",
                    color: "#8b0000",
                    type: "danger",
                    reward: 15,
                    speed: 2.8,
                    health: 2
                },
                sword: {
                    name: "å‰‘",
                    desc: "ç¦æ­¢æºå¸¦ï¼šé•¿åˆ€å‰‘ç±»æ­¦å™¨ä¸¥ç¦æºå¸¦",
                    color: "#cd5c5c",
                    type: "danger",
                    reward: 12,
                    speed: 2.6,
                    health: 1
                },
                nunchaku: {
                    name: "åŒèŠ‚æ£",
                    desc: "ç¦æ­¢æºå¸¦ï¼šæ­¦æœ¯å™¨æ¢°ç¦æ­¢éšèº«æºå¸¦",
                    color: "#8b4513",
                    type: "danger",
                    reward: 8,
                    speed: 2.2,
                    health: 1
                },
                
                // çˆ†ç‚¸ç‰©/åŒ–å­¦å“
                explosive: {
                    name: "çˆ†ç‚¸ç‰©",
                    desc: "ç¦æ­¢æºå¸¦ï¼šä»»ä½•ç±»å‹çš„çˆ†ç‚¸ç‰©éƒ½ç¦æ­¢æºå¸¦",
                    color: "#000000",
                    type: "danger",
                    reward: 20,
                    speed: 3.0,
                    health: 3
                },
                fireworks: {
                    name: "çƒŸèŠ±çˆ†ç«¹",
                    desc: "ç¦æ­¢æºå¸¦ï¼šæ˜“ç‡ƒæ˜“çˆ†ç‰©å“ä¸¥ç¦æºå¸¦",
                    color: "#ff69b4",
                    type: "danger",
                    reward: 12,
                    speed: 2.4,
                    health: 1
                },
                gasoline: {
                    name: "æ±½æ²¹",
                    desc: "ç¦æ­¢æºå¸¦ï¼šæ˜“ç‡ƒæ¶²ä½“ä¸¥ç¦æºå¸¦",
                    color: "#ffa500",
                    type: "danger",
                    reward: 15,
                    speed: 2.7,
                    health: 2
                },
                acid: {
                    name: "å¼ºé…¸",
                    desc: "ç¦æ­¢æºå¸¦ï¼šè…èš€æ€§ç‰©å“ä¸¥ç¦æºå¸¦",
                    color: "#9acd32",
                    type: "danger",
                    reward: 18,
                    speed: 2.1,
                    health: 2
                },
                
                // æ¶²ä½“é™åˆ¶ç±»
                bigLiquid: {
                    name: "è¶…é‡æ¶²ä½“",
                    desc: "ç¦æ­¢æºå¸¦ï¼šå•ä»¶å®¹å™¨è¶…è¿‡100mlçš„æ¶²ä½“",
                    color: "#4169e1",
                    type: "danger",
                    reward: 8,
                    speed: 2.2,
                    health: 1
                },
                alcohol: {
                    name: "é«˜åº¦é…’ç²¾",
                    desc: "ç¦æ­¢æºå¸¦ï¼šé…’ç²¾åº¦æ•°è¶…è¿‡70%çš„é…’ç±»",
                    color: "#b22222",
                    type: "danger",
                    reward: 10,
                    speed: 2.0,
                    health: 1
                },
                
                // å·¥å…·ç±»
                hammer: {
                    name: "é”¤å­",
                    desc: "ç¦æ­¢æºå¸¦ï¼šé‡å‹å·¥å…·ç±»ç‰©å“",
                    color: "#696969",
                    type: "danger",
                    reward: 6,
                    speed: 1.9,
                    health: 1
                },
                axe: {
                    name: "æ–§å¤´",
                    desc: "ç¦æ­¢æºå¸¦ï¼šç ä¼å·¥å…·ä¸¥ç¦æºå¸¦",
                    color: "#8b4513",
                    type: "danger",
                    reward: 14,
                    speed: 2.3,
                    health: 2
                },
                screwdriver: {
                    name: "é•¿èºä¸åˆ€",
                    desc: "ç¦æ­¢æºå¸¦ï¼šé•¿åº¦è¶…è¿‡6cmçš„å·¥å…·",
                    color: "#ff6347",
                    type: "danger",
                    reward: 5,
                    speed: 1.8,
                    health: 1
                },
                
                // ç”µæ± /ç”µå­ç±»
                bigBattery: {
                    name: "è¶…æ ‡å……ç”µå®",
                    desc: "ç¦æ­¢æºå¸¦ï¼šé¢å®šèƒ½é‡è¶…è¿‡160Whçš„å……ç”µå®",
                    color: "#ff8c00",
                    type: "danger",
                    reward: 7,
                    speed: 2.0,
                    health: 1
                },
                lithiumBattery: {
                    name: "å¤§å®¹é‡é”‚ç”µæ± ",
                    desc: "ç¦æ­¢æºå¸¦ï¼šå®¹é‡è¿‡å¤§çš„é”‚ç”µæ± ",
                    color: "#32cd32",
                    type: "danger",
                    reward: 9,
                    speed: 2.1,
                    health: 1
                },
                
                // æ‰“ç«æœº/ç«ç§ç±»
                lighter: {
                    name: "æ‰“ç«æœº",
                    desc: "ç¦æ­¢æºå¸¦ï¼šä»»ä½•ç±»å‹çš„æ‰“ç«æœº",
                    color: "#ff4500",
                    type: "danger",
                    reward: 6,
                    speed: 2.3,
                    health: 1
                },
                matches: {
                    name: "ç«æŸ´",
                    desc: "ç¦æ­¢æºå¸¦ï¼šç‚¹ç«å™¨å…·ä¸¥ç¦æºå¸¦",
                    color: "#daa520",
                    type: "danger",
                    reward: 5,
                    speed: 1.7,
                    health: 1
                },
                
                // ç‰¹æ®Šé™åˆ¶ç‰©å“
                spray: {
                    name: "å–·é›¾å‰‚",
                    desc: "ç¦æ­¢æºå¸¦ï¼šå‹ç¼©æ°”ä½“å®¹å™¨",
                    color: "#87ceeb",
                    type: "danger",
                    reward: 7,
                    speed: 1.9,
                    health: 1
                },
                magnet: {
                    name: "å¼ºç£é“",
                    desc: "ç¦æ­¢æºå¸¦ï¼šå¼ºç£æ€§ç‰©å“",
                    color: "#dc143c",
                    type: "danger",
                    reward: 8,
                    speed: 2.0,
                    health: 1
                },
                
                // === å…è®¸æºå¸¦ç‰©å“ (ä¸åº”å‡»æ‰“) ===
                
                // ç”µå­è®¾å¤‡
                phone: {
                    name: "æ‰‹æœº",
                    desc: "å…è®¸æºå¸¦ï¼šæ‰‹æœºç­‰ç”µå­è®¾å¤‡éœ€å•ç‹¬è¿‡æ£€",
                    color: "#4682b4",
                    type: "safe",
                    reward: 5,
                    speed: 1.3,
                    health: 1
                },
                laptop: {
                    name: "ç¬”è®°æœ¬ç”µè„‘",
                    desc: "å…è®¸æºå¸¦ï¼šéœ€å•ç‹¬è¿‡æ£€",
                    color: "#2f4f4f",
                    type: "safe",
                    reward: 8,
                    speed: 1.5,
                    health: 1
                },
                camera: {
                    name: "ç›¸æœº",
                    desc: "å…è®¸æºå¸¦ï¼šæ‘„å½±å™¨æå¯éšèº«æºå¸¦",
                    color: "#000000",
                    type: "safe",
                    reward: 6,
                    speed: 1.4,
                    health: 1
                },
                headphones: {
                    name: "è€³æœº",
                    desc: "å…è®¸æºå¸¦ï¼šéŸ³é¢‘è®¾å¤‡å¯éšèº«æºå¸¦",
                    color: "#483d8b",
                    type: "safe",
                    reward: 4,
                    speed: 1.2,
                    health: 1
                },
                
                // ä¸ªäººç”¨å“
                wallet: {
                    name: "é’±åŒ…",
                    desc: "å…è®¸æºå¸¦ï¼šé’±åŒ…å¯ä»¥éšèº«æºå¸¦",
                    color: "#6a5acd",
                    type: "safe",
                    reward: 3,
                    speed: 1.1,
                    health: 1
                },
                glasses: {
                    name: "çœ¼é•œ",
                    desc: "å…è®¸æºå¸¦ï¼šä¸ªäººç”¨å“å¯éšèº«æºå¸¦",
                    color: "#add8e6",
                    type: "safe",
                    reward: 3,
                    speed: 1.0,
                    health: 1
                },
                watch: {
                    name: "æ‰‹è¡¨",
                    desc: "å…è®¸æºå¸¦ï¼šä¸ªäººé¥°å“å¯éšèº«æºå¸¦",
                    color: "#ffd700",
                    type: "safe",
                    reward: 4,
                    speed: 1.1,
                    health: 1
                },
                keys: {
                    name: "é’¥åŒ™",
                    desc: "å…è®¸æºå¸¦ï¼šæ—¥å¸¸ç”¨å“å¯éšèº«æºå¸¦",
                    color: "#c0c0c0",
                    type: "safe",
                    reward: 3,
                    speed: 1.0,
                    health: 1
                },
                
                // æ–‡å…·/ä¹¦ç±
                book: {
                    name: "ä¹¦ç±",
                    desc: "å…è®¸æºå¸¦ï¼šçº¸è´¨ä¹¦ç±å¯ä»¥éšèº«æºå¸¦",
                    color: "#2e8b57",
                    type: "safe",
                    reward: 5,
                    speed: 1.2,
                    health: 1
                },
                pen: {
                    name: "ç¬”",
                    desc: "å…è®¸æºå¸¦ï¼šæ–‡å…·ç”¨å“å¯éšèº«æºå¸¦",
                    color: "#4169e1",
                    type: "safe",
                    reward: 2,
                    speed: 0.9,
                    health: 1
                },
                notebook: {
                    name: "ç¬”è®°æœ¬",
                    desc: "å…è®¸æºå¸¦ï¼šæ–‡å…·ç”¨å“å¯éšèº«æºå¸¦",
                    color: "#dda0dd",
                    type: "safe",
                    reward: 3,
                    speed: 1.1,
                    health: 1
                },
                
                // è¡£ç‰©ç±»
                clothes: {
                    name: "è¡£ç‰©",
                    desc: "å…è®¸æºå¸¦ï¼šä¸ªäººè¡£ç‰©å¯éšèº«æºå¸¦",
                    color: "#ff69b4",
                    type: "safe",
                    reward: 4,
                    speed: 1.2,
                    health: 1
                },
                shoes: {
                    name: "é‹å­",
                    desc: "å…è®¸æºå¸¦ï¼šéœ€è„±é‹æ£€æŸ¥",
                    color: "#8b4513",
                    type: "safe",
                    reward: 4,
                    speed: 1.3,
                    health: 1
                },
                
                // é£Ÿå“ç±»
                snacks: {
                    name: "é›¶é£Ÿ",
                    desc: "å…è®¸æºå¸¦ï¼šå›ºä½“é£Ÿç‰©å¯éšèº«æºå¸¦",
                    color: "#ffa500",
                    type: "safe",
                    reward: 3,
                    speed: 1.0,
                    health: 1
                },
                medicine: {
                    name: "å¸¸è§„è¯å“",
                    desc: "å…è®¸æºå¸¦ï¼šä¸ªäººå¸¸ç”¨è¯ç‰©",
                    color: "#ffffff",
                    type: "safe",
                    reward: 5,
                    speed: 1.1,
                    health: 1
                },
                
                // ç‰¹æ®Šåˆè§„ç‰©å“
                toyGun: {
                    name: "ç©å…·æª",
                    desc: "å…è®¸æºå¸¦ï¼šæ˜æ˜¾çš„ç©å…·å¯ä»¥æºå¸¦",
                    color: "#ff6347",
                    type: "safe",
                    reward: 8,
                    speed: 1.7,
                    health: 1
                },
                umbrella: {
                    name: "é›¨ä¼",
                    desc: "å…è®¸æºå¸¦ï¼šæ—¥å¸¸ç”¨å“å¯éšèº«æºå¸¦",
                    color: "#000080",
                    type: "safe",
                    reward: 4,
                    speed: 1.3,
                    health: 1
                },
                smallLiquid: {
                    name: "å°ç“¶æ¶²ä½“",
                    desc: "å…è®¸æºå¸¦ï¼š100mlä»¥ä¸‹æ¶²ä½“è£…åœ¨é€æ˜è¢‹ä¸­",
                    color: "#87cefa",
                    type: "safe",
                    reward: 6,
                    speed: 1.4,
                    health: 1
                }
            };

            // æ¸¸æˆçŠ¶æ€
            const gameState = {
                running: true,
                lives: 3,
                score: 0,
                level: 1,
                gameOver: false,
                items: [],
                bullets: [],
                explosions: [],
                particles: [],
                backgroundParticles: [],
                lastItemTime: 0,
                itemInterval: 1500,
                difficulty: "normal",
                combo: 0,
                lastComboTime: 0,
                comboTimeout: 2000,
                speedMultiplier: 1,
                itemSizeMultiplier: 1,
                maxAmmo: 10,
                currentAmmo: 10,
                reloadTime: 2000,
                isReloading: false,
                reloadStartTime: 0,
                levelStartTime: 0,
                levelTimeLimit: 45000,
                remainingTime: 45000
            };

            // è·å–Canvaså…ƒç´ 
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            // const reloadBtn = document.getElementById('reloadBtn'); // å·²åˆ é™¤
            const tooltip = document.getElementById('tooltip');
            const gameOverDiv = document.getElementById('gameOver');
            const restartBtn = document.getElementById('restartBtn');
            const difficultySelect = document.getElementById('difficulty');
            const ammoDisplay = document.getElementById('ammoCount');
            
            // æ‚¬æµ®æ§åˆ¶æŒ‰é’®
            const floatingControls = document.getElementById('floatingControls');
            
            // æ‚¬æµ®æ§åˆ¶å§‹ç»ˆæ˜¾ç¤º
            floatingControls.style.display = 'flex';
            
            // å®‰æ£€æª
            const gun = {
                x: canvas.width / 2,
                y: canvas.height - 30,
                width: 40,
                height: 60,
                color: '#333',
                barrelLength: 30,
                angle: 0,
                targetX: canvas.width / 2,
                targetY: canvas.height - 60
            };
            
            // æ›´æ–°æªçš„ä½ç½®ä»¥é€‚åº”ç”»å¸ƒå¤§å°
            function updateGunPosition() {
                gun.x = canvas.width / 2;
                gun.y = canvas.height - 30;
                gun.targetX = canvas.width / 2;
                gun.targetY = canvas.height - 60;
            }
            
            updateGunPosition();

            // é”®ç›˜æ§åˆ¶
            let keys = {};
            document.addEventListener('keydown', keyDownHandler);
            document.addEventListener('keyup', keyUpHandler);
            document.addEventListener('keypress', keyPressHandler);

            function keyDownHandler(e) {
                keys[e.key] = true;
            }

            function keyUpHandler(e) {
                keys[e.key] = false;
            }

            function keyPressHandler(e) {
                if (e.key === 'r' || e.key === 'R') {
                    startReload();
                }
            }

            // é¼ æ ‡å’Œè§¦å±æ§åˆ¶
            function updateGunTarget(clientX, clientY) {
                if (gameState.gameOver) return;
                const rect = canvas.getBoundingClientRect();
                gun.targetX = (clientX - rect.left) * (canvas.width / rect.width);
                gun.targetY = (clientY - rect.top) * (canvas.height / rect.height);
                
                // è®¡ç®—æªçš„è§’åº¦
                gun.angle = Math.atan2(gun.targetY - gun.y, gun.targetX - gun.x);
            }
            
            function handleShoot() {
                if (gameState.gameOver || gameState.isReloading) return;
                if (gameState.currentAmmo > 0) {
                    shoot();
                } else {
                    showTip("å¼¹è¯è€—å°½ï¼æŒ‰Ré”®è£…å¼¹", "red");
                }
            }
            
            // é¼ æ ‡äº‹ä»¶
            canvas.addEventListener('mousemove', function(e) {
                updateGunTarget(e.clientX, e.clientY);
            });
            
            canvas.addEventListener('click', handleShoot);
            
            // è§¦å±äº‹ä»¶
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                if (e.touches.length > 0) {
                    updateGunTarget(e.touches[0].clientX, e.touches[0].clientY);
                }
            });
            
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                if (e.touches.length > 0) {
                    updateGunTarget(e.touches[0].clientX, e.touches[0].clientY);
                }
            });
            
            canvas.addEventListener('touchend', function(e) {
                e.preventDefault();
                handleShoot();
            });
            

            // å¼€å§‹è£…å¼¹
            function startReload() {
                if (gameState.isReloading || gameState.currentAmmo >= gameState.maxAmmo) return;
                
                audioSystem.playReload();
                gameState.isReloading = true;
                gameState.reloadStartTime = Date.now();
                showTip("è£…å¼¹ä¸­...", "blue");
                
                setTimeout(() => {
                    gameState.currentAmmo = gameState.maxAmmo;
                    gameState.isReloading = false;
                    updateAmmoDisplay();
                    showTip("è£…å¼¹å®Œæˆï¼", "green");
                    audioSystem.createBeep(600, 0.1);
                }, gameState.reloadTime);
            }

            // å°„å‡»
            function shoot() {
                if (gameState.currentAmmo <= 0) return;
                
                audioSystem.playShoot();
                gameState.currentAmmo--;
                updateAmmoDisplay();
                
                // åˆ›å»ºå­å¼¹
                gameState.bullets.push({
                    x: gun.x + Math.cos(gun.angle) * gun.barrelLength,
                    y: gun.y + Math.sin(gun.angle) * gun.barrelLength,
                    speed: 15,
                    angle: gun.angle,
                    radius: 3,
                    color: '#ff0'
                });
            }

            // æ›´æ–°å¼¹è¯æ˜¾ç¤º
            function updateAmmoDisplay() {
                ammoDisplay.textContent = gameState.currentAmmo;
                document.getElementById('ammo').textContent = gameState.currentAmmo;
            }

            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            function updateTimeDisplay() {
                const timeLeft = Math.max(0, Math.ceil(gameState.remainingTime / 1000));
                document.getElementById('timeLeft').textContent = timeLeft;
                
                // æ—¶é—´ä¸è¶³10ç§’æ—¶å˜çº¢è­¦å‘Š
                const timeElement = document.getElementById('timeLeft');
                if (timeLeft <= 10) {
                    timeElement.style.color = '#ff4757';
                    timeElement.style.fontWeight = 'bold';
                } else {
                    timeElement.style.color = '';
                    timeElement.style.fontWeight = '';
                }
            }

            // æ ¹æ®éš¾åº¦è®¾ç½®æ¸¸æˆå‚æ•°
            function setDifficulty() {
                gameState.difficulty = selectedDifficulty;
                
                const difficultyNames = {
                    'easy': 'ç®€å•',
                    'normal': 'æ™®é€š', 
                    'hard': 'å›°éš¾',
                    'expert': 'ä¸“å®¶'
                };
                
                document.getElementById('currentDifficulty').textContent = difficultyNames[gameState.difficulty];
                
                switch(gameState.difficulty) {
                    case 'easy':
                        gameState.lives = 5;
                        gameState.speedMultiplier = 0.8;
                        gameState.itemSizeMultiplier = 1.2;
                        gameState.maxAmmo = 15;
                        break;
                    case 'normal':
                        gameState.lives = 3;
                        gameState.speedMultiplier = 1;
                        gameState.itemSizeMultiplier = 1;
                        gameState.maxAmmo = 10;
                        break;
                    case 'hard':
                        gameState.lives = 2;
                        gameState.speedMultiplier = 1.3;
                        gameState.itemSizeMultiplier = 0.8;
                        gameState.maxAmmo = 8;
                        break;
                    case 'expert':
                        gameState.lives = 1;
                        gameState.speedMultiplier = 1.6;
                        gameState.itemSizeMultiplier = 0.7;
                        gameState.maxAmmo = 6;
                        break;
                }
                
                gameState.currentAmmo = gameState.maxAmmo;
                gameState.levelStartTime = Date.now();
                gameState.remainingTime = gameState.levelTimeLimit;
                document.getElementById('lives').textContent = gameState.lives;
                updateAmmoDisplay();
                updateTimeDisplay();
            }

            // ç”Ÿæˆéšæœºç‰©å“
            function generateItem(timestamp) {
                if (!gameState.running || gameState.gameOver) return;
                
                if (timestamp - gameState.lastItemTime > gameState.itemInterval) {
                    const itemKeys = Object.keys(items);
                    let randomItemKey;
                    
                    // éšç€å…³å¡æé«˜ï¼Œå±é™©ç‰©å“å‡ºç°çš„æ¦‚ç‡å¢åŠ 
                    const dangerChance = Math.min(0.7, 0.3 + gameState.level * 0.05);
                    
                    if (Math.random() < dangerChance) {
                        // ç”Ÿæˆå±é™©ç‰©å“
                        const dangerItems = itemKeys.filter(key => items[key].type === 'danger');
                        randomItemKey = dangerItems[Math.floor(Math.random() * dangerItems.length)];
                    } else {
                        // ç”Ÿæˆå®‰å…¨ç‰©å“
                        const safeItems = itemKeys.filter(key => items[key].type === 'safe');
                        randomItemKey = safeItems[Math.floor(Math.random() * safeItems.length)];
                    }
                    
                    const item = items[randomItemKey];
                    const size = Math.max(30, 40 * gameState.itemSizeMultiplier);
                    
                    gameState.items.push({
                        x: Math.random() * (canvas.width - size),
                        y: -size,
                        width: size,
                        height: size,
                        type: item.type,
                        itemType: randomItemKey,
                        color: item.color,
                        speed: (item.speed + Math.random() * 0.5) * gameState.speedMultiplier,
                        name: item.name,
                        rotation: 0,
                        rotationSpeed: Math.random() * 4 - 2,
                        health: item.health,
                        maxHealth: item.health
                    });
                    
                    gameState.lastItemTime = timestamp;
                    
                    // éšç€å…³å¡æé«˜ï¼Œç”Ÿæˆé€Ÿåº¦åŠ å¿«
                    gameState.itemInterval = Math.max(300, 1500 - gameState.level * 100);
                }
            }

            // æ£€æµ‹å­å¼¹å’Œç‰©å“çš„ç¢°æ’
            function checkBulletCollisions() {
                for (let i = gameState.bullets.length - 1; i >= 0; i--) {
                    const bullet = gameState.bullets[i];
                    
                    // æ›´æ–°å­å¼¹ä½ç½®
                    bullet.x += Math.cos(bullet.angle) * bullet.speed;
                    bullet.y += Math.sin(bullet.angle) * bullet.speed;
                    
                    // æ£€æŸ¥å­å¼¹æ˜¯å¦è¶…å‡ºå±å¹•
                    if (bullet.x < 0 || bullet.x > canvas.width || bullet.y < 0 || bullet.y > canvas.height) {
                        gameState.bullets.splice(i, 1);
                        continue;
                    }
                    
                    // æ£€æŸ¥å­å¼¹æ˜¯å¦å‡»ä¸­ç‰©å“
                    for (let j = gameState.items.length - 1; j >= 0; j--) {
                        const item = gameState.items[j];
                        
                        // ç®€å•çš„åœ†å½¢ç¢°æ’æ£€æµ‹
                        const dx = bullet.x - (item.x + item.width/2);
                        const dy = bullet.y - (item.y + item.height/2);
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < bullet.radius + item.width/2) {
                            // å‡»ä¸­ç‰©å“
                            item.health--;
                            audioSystem.createBeep(400, 0.05, 'square'); // è½»å¾®çš„å‡»ä¸­éŸ³æ•ˆ
                            
                            // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
                            if (item.health <= 0) {
                                createExplosion(item.x + item.width/2, item.y + item.height/2, item.color);
                                
                                const itemDef = items[item.itemType];
                                if (itemDef.type === 'danger') {
                                    // å‡»ä¸­å±é™©ç‰©å“ - ç»¿è‰²åº†ç¥ç²’å­
                                    createParticles(item.x + item.width/2, item.y + item.height/2, 15, {
                                        colors: ['#2ed573', '#7bed9f', '#70a1ff', '#5352ed'],
                                        minSpeed: 2,
                                        maxSpeed: 6,
                                        minSize: 2,
                                        maxSize: 5,
                                        minLife: 40,
                                        maxLife: 80,
                                        gravity: 0.1
                                    });
                                    
                                    // å‡»ä¸­å±é™©ç‰©å“åŠ åˆ†å’Œè¡¥å……å¼¹è¯
                                    gameState.score += itemDef.reward;
                                    gameState.currentAmmo = Math.min(gameState.maxAmmo, gameState.currentAmmo + 2);
                                    updateAmmoDisplay();
                                    
                                    // è¿å‡»ç³»ç»Ÿ
                                    const now = Date.now();
                                    if (now - gameState.lastComboTime < gameState.comboTimeout) {
                                        gameState.combo++;
                                        const comboBonus = Math.min(10, Math.floor(gameState.combo / 3));
                                        gameState.score += comboBonus;
                                        showTip(`å‡»ä¸­å±é™©å“: +${itemDef.reward}åˆ† +2å¼¹è¯ (è¿å‡»x${gameState.combo} +${comboBonus})`, 'green');
                                        
                                        // è¿å‡»ç‰¹æ•ˆ
                                        createParticles(item.x + item.width/2, item.y + item.height/2, 5, {
                                            colors: ['#feca57', '#ff9ff3', '#54a0ff'],
                                            minSpeed: 1,
                                            maxSpeed: 3,
                                            minSize: 3,
                                            maxSize: 6,
                                            minLife: 60,
                                            maxLife: 100
                                        });
                                    } else {
                                        gameState.combo = 1;
                                        showTip(`å‡»ä¸­å±é™©å“: +${itemDef.reward}åˆ† +2å¼¹è¯`, 'green');
                                    }
                                    gameState.lastComboTime = now;
                                    audioSystem.playSuccess();
                                } else {
                                    // å‡»ä¸­å®‰å…¨ç‰©å“ - çº¢è‰²è­¦å‘Šç²’å­
                                    createParticles(item.x + item.width/2, item.y + item.height/2, 10, {
                                        colors: ['#ff6b6b', '#ff4757', '#ff3838', '#e55039'],
                                        minSpeed: 1,
                                        maxSpeed: 4,
                                        minSize: 2,
                                        maxSize: 4,
                                        minLife: 30,
                                        maxLife: 60,
                                        gravity: 0.2
                                    });
                                    
                                    // å‡»ä¸­å®‰å…¨ç‰©å“æ‰£åˆ†å’Œç”Ÿå‘½å€¼
                                    gameState.score = Math.max(0, gameState.score - itemDef.reward);
                                    gameState.lives--;
                                    gameState.combo = 0; // ä¸­æ–­è¿å‡»
                                    showTip(`è¯¯å‡»å®‰å…¨ç‰©å“: -${itemDef.reward}åˆ† -1ç”Ÿå‘½`, 'red');
                                    audioSystem.createBeep(200, 0.3, 'sawtooth');
                                    
                                    document.getElementById('lives').textContent = gameState.lives;
                                    
                                    if (gameState.lives <= 0) {
                                        endGame();
                                        return;
                                    }
                                }
                                
                                // ç§»åŠ¨ç«¯æŒ¯åŠ¨åé¦ˆ
                                if (navigator.vibrate && isMobileDevice()) {
                                    navigator.vibrate(itemDef.type === 'danger' ? [50] : [100, 50, 100]);
                                }
                                
                                document.getElementById('score').textContent = gameState.score;
                                
                                // ç§»é™¤è¢«å‡»ä¸­çš„ç‰©å“
                                gameState.items.splice(j, 1);
                            }
                            
                            // ç§»é™¤å­å¼¹
                            gameState.bullets.splice(i, 1);
                            break;
                        }
                    }
                }
            }

            // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
            function createExplosion(x, y, color) {
                const particleCount = 25;
                
                // ä¸»çˆ†ç‚¸ç²’å­
                for (let i = 0; i < particleCount; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 5 + 2;
                    const size = Math.random() * 4 + 2;
                    
                    gameState.explosions.push({
                        x: x,
                        y: y,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        radius: size,
                        initialRadius: size,
                        color: color,
                        secondaryColor: i % 3 === 0 ? '#ffffff' : (i % 3 === 1 ? '#ffff00' : color),
                        life: 40 + Math.random() * 30,
                        maxLife: 40 + Math.random() * 30,
                        type: 'explosion',
                        gravity: 0.1,
                        friction: 0.98
                    });
                }
                
                // å†²å‡»æ³¢æ•ˆæœ
                gameState.explosions.push({
                    x: x,
                    y: y,
                    vx: 0,
                    vy: 0,
                    radius: 5,
                    initialRadius: 5,
                    color: color,
                    secondaryColor: '#ffffff',
                    life: 30,
                    maxLife: 30,
                    type: 'shockwave',
                    gravity: 0,
                    friction: 1
                });
                
                // ç«èŠ±æ•ˆæœ
                for (let i = 0; i < 8; i++) {
                    const angle = (Math.PI * 2 / 8) * i + Math.random() * 0.5;
                    const speed = Math.random() * 3 + 4;
                    
                    gameState.explosions.push({
                        x: x,
                        y: y,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        radius: Math.random() * 2 + 1,
                        initialRadius: Math.random() * 2 + 1,
                        color: '#ffffff',
                        secondaryColor: '#ffff00',
                        life: 20 + Math.random() * 15,
                        maxLife: 20 + Math.random() * 15,
                        type: 'spark',
                        gravity: 0.05,
                        friction: 0.95
                    });
                }
            }
            
            // åˆ›å»ºç²’å­ç‰¹æ•ˆ
            function createParticles(x, y, count, config = {}) {
                const {
                    colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57'],
                    minSpeed = 1,
                    maxSpeed = 4,
                    minSize = 1,
                    maxSize = 3,
                    minLife = 30,
                    maxLife = 60,
                    gravity = 0,
                    fade = true
                } = config;
                
                for (let i = 0; i < count; i++) {
                    gameState.particles.push({
                        x: x + (Math.random() - 0.5) * 20,
                        y: y + (Math.random() - 0.5) * 20,
                        vx: (Math.random() - 0.5) * (maxSpeed - minSpeed) + minSpeed,
                        vy: (Math.random() - 0.5) * (maxSpeed - minSpeed) + minSpeed,
                        size: Math.random() * (maxSize - minSize) + minSize,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        life: Math.random() * (maxLife - minLife) + minLife,
                        maxLife: Math.random() * (maxLife - minLife) + minLife,
                        gravity: gravity,
                        fade: fade
                    });
                }
            }
            
            // åˆå§‹åŒ–èƒŒæ™¯ç²’å­
            function initBackgroundParticles() {
                for (let i = 0; i < 15; i++) {
                    gameState.backgroundParticles.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        size: Math.random() * 2 + 1,
                        speed: Math.random() * 0.5 + 0.2,
                        opacity: Math.random() * 0.3 + 0.1,
                        color: ['#87ceeb', '#b0e0e6', '#f0f8ff'][Math.floor(Math.random() * 3)]
                    });
                }
            }
            
            // æ›´æ–°èƒŒæ™¯ç²’å­
            function updateBackgroundParticles() {
                for (const particle of gameState.backgroundParticles) {
                    particle.y += particle.speed;
                    
                    // é‡ç½®åˆ°é¡¶éƒ¨
                    if (particle.y > canvas.height + 10) {
                        particle.y = -10;
                        particle.x = Math.random() * canvas.width;
                    }
                }
            }
            
            // æ›´æ–°ç‰¹æ•ˆç²’å­
            function updateParticles() {
                for (let i = gameState.particles.length - 1; i >= 0; i--) {
                    const particle = gameState.particles[i];
                    
                    // æ›´æ–°ä½ç½®
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    particle.vy += particle.gravity;
                    
                    // å‡å°‘ç”Ÿå‘½å€¼
                    particle.life--;
                    
                    // ç§»é™¤æ­»äº¡çš„ç²’å­
                    if (particle.life <= 0) {
                        gameState.particles.splice(i, 1);
                    }
                }
            }
            
            // ç»˜åˆ¶èƒŒæ™¯ç²’å­
            function drawBackgroundParticles() {
                for (const particle of gameState.backgroundParticles) {
                    ctx.save();
                    ctx.globalAlpha = particle.opacity;
                    ctx.fillStyle = particle.color;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
            }
            
            // ç»˜åˆ¶ç‰¹æ•ˆç²’å­
            function drawParticles() {
                for (const particle of gameState.particles) {
                    ctx.save();
                    
                    if (particle.fade) {
                        ctx.globalAlpha = particle.life / particle.maxLife;
                    }
                    
                    // åˆ›å»ºç²’å­æ¸å˜
                    const particleGradient = ctx.createRadialGradient(
                        particle.x, particle.y, 0,
                        particle.x, particle.y, particle.size
                    );
                    particleGradient.addColorStop(0, particle.color);
                    particleGradient.addColorStop(1, 'transparent');
                    
                    ctx.fillStyle = particleGradient;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.restore();
                }
            }

            // æ›´æ–°çˆ†ç‚¸æ•ˆæœ
            function updateExplosions() {
                for (let i = gameState.explosions.length - 1; i >= 0; i--) {
                    const explosion = gameState.explosions[i];
                    
                    // æ›´æ–°ä½ç½®
                    explosion.x += explosion.vx;
                    explosion.y += explosion.vy;
                    
                    // åº”ç”¨é‡åŠ›å’Œæ‘©æ“¦åŠ›
                    explosion.vy += explosion.gravity;
                    explosion.vx *= explosion.friction;
                    explosion.vy *= explosion.friction;
                    
                    // æ›´æ–°å¤§å°ï¼ˆæ ¹æ®ç±»å‹ï¼‰
                    if (explosion.type === 'shockwave') {
                        const progress = (explosion.maxLife - explosion.life) / explosion.maxLife;
                        explosion.radius = explosion.initialRadius + progress * 30;
                    } else if (explosion.type === 'spark') {
                        const progress = explosion.life / explosion.maxLife;
                        explosion.radius = explosion.initialRadius * progress;
                    }
                    
                    // å‡å°‘ç”Ÿå‘½å€¼
                    explosion.life--;
                    
                    // ç§»é™¤æ­»äº¡çš„çˆ†ç‚¸ç²’å­
                    if (explosion.life <= 0) {
                        gameState.explosions.splice(i, 1);
                    }
                }
            }

            // æ£€æŸ¥ç‰©å“æ˜¯å¦è½åˆ°åº•éƒ¨
            function checkItemBottom() {
                for (let i = gameState.items.length - 1; i >= 0; i--) {
                    const item = gameState.items[i];
                    
                    // ç‰©å“è½åˆ°åº•éƒ¨
                    if (item.y > canvas.height) {
                        const itemDef = items[item.itemType];
                        if (itemDef.type === 'danger') {
                            // å±é™©ç‰©å“é€šè¿‡å®‰æ£€æ‰£åˆ†å’Œç”Ÿå‘½å€¼
                            gameState.score = Math.max(0, gameState.score - itemDef.reward * 2);
                            gameState.lives--;
                            gameState.combo = 0; // ä¸­æ–­è¿å‡»
                            showTip(`å±é™©ç‰©å“é€šè¿‡: -${itemDef.reward * 2}åˆ† -1ç”Ÿå‘½`, 'red');
                            audioSystem.createBeep(200, 0.5, 'sawtooth');
                            
                            document.getElementById('lives').textContent = gameState.lives;
                            document.getElementById('score').textContent = gameState.score;
                            
                            if (gameState.lives <= 0) {
                                endGame();
                                return;
                            }
                        } else {
                            // å®‰å…¨ç‰©å“é€šè¿‡åŠ åˆ†
                            gameState.score += itemDef.reward;
                            showTip(`æ”¾è¡Œå®‰å…¨ç‰©å“: +${itemDef.reward}åˆ†`, 'green');
                            document.getElementById('score').textContent = gameState.score;
                        }
                        
                        gameState.items.splice(i, 1);
                    }
                }
            }

            // ç»˜åˆ¶æ—‹è½¬çš„ç‰©å“
            function drawRotatedItem(item) {
                ctx.save();
                ctx.translate(item.x + item.width/2, item.y + item.height/2);
                ctx.rotate(item.rotation * Math.PI/180);
                
                // ç»˜åˆ¶é˜´å½±
                ctx.save();
                ctx.translate(3, 3);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillRect(-item.width/2, -item.height/2, item.width, item.height);
                ctx.restore();
                
                // æ ¹æ®ç‰©å“ç±»å‹åˆ›å»ºä¸åŒçš„æ¸å˜æ•ˆæœ
                let itemGradient;
                if (item.type === 'danger') {
                    // å±é™©ç‰©å“ï¼šè­¦å‘Šè‰²æ¸å˜
                    itemGradient = ctx.createLinearGradient(-item.width/2, -item.height/2, item.width/2, item.height/2);
                    itemGradient.addColorStop(0, item.color);
                    itemGradient.addColorStop(0.5, '#ff4757');
                    itemGradient.addColorStop(1, '#2f1b14');
                    
                    // æ·»åŠ å±é™©ç‰©å“çš„è¾¹æ¡†å‘å…‰æ•ˆæœ
                    const dangerGlow = ctx.createRadialGradient(0, 0, 0, 0, 0, item.width/2 + 5);
                    dangerGlow.addColorStop(0, 'rgba(255, 71, 87, 0.3)');
                    dangerGlow.addColorStop(0.7, 'rgba(255, 71, 87, 0.1)');
                    dangerGlow.addColorStop(1, 'rgba(255, 71, 87, 0)');
                    ctx.fillStyle = dangerGlow;
                    ctx.beginPath();
                    ctx.arc(0, 0, item.width/2 + 5, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    // å®‰å…¨ç‰©å“ï¼šæŸ”å’Œè‰²æ¸å˜
                    itemGradient = ctx.createLinearGradient(-item.width/2, -item.height/2, item.width/2, item.height/2);
                    itemGradient.addColorStop(0, '#ffffff');
                    itemGradient.addColorStop(0.5, item.color);
                    itemGradient.addColorStop(1, '#2c3e50');
                    
                    // æ·»åŠ å®‰å…¨ç‰©å“çš„è¾¹æ¡†å‘å…‰æ•ˆæœ
                    const safeGlow = ctx.createRadialGradient(0, 0, 0, 0, 0, item.width/2 + 3);
                    safeGlow.addColorStop(0, 'rgba(46, 213, 115, 0.2)');
                    safeGlow.addColorStop(0.7, 'rgba(46, 213, 115, 0.05)');
                    safeGlow.addColorStop(1, 'rgba(46, 213, 115, 0)');
                    ctx.fillStyle = safeGlow;
                    ctx.beginPath();
                    ctx.arc(0, 0, item.width/2 + 3, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // ç»˜åˆ¶ç‰©å“ä¸»ä½“
                ctx.fillStyle = itemGradient;
                ctx.fillRect(-item.width/2, -item.height/2, item.width, item.height);
                
                // æ·»åŠ è¾¹æ¡†
                ctx.strokeStyle = item.type === 'danger' ? '#ff4757' : '#2ed573';
                ctx.lineWidth = 2;
                ctx.strokeRect(-item.width/2, -item.height/2, item.width, item.height);
                
                // æ·»åŠ é«˜å…‰æ•ˆæœ
                const highlightGradient = ctx.createLinearGradient(-item.width/2, -item.height/2, -item.width/2 + item.width * 0.6, -item.height/2 + item.height * 0.6);
                highlightGradient.addColorStop(0, 'rgba(255, 255, 255, 0.4)');
                highlightGradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.2)');
                highlightGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                ctx.fillStyle = highlightGradient;
                ctx.fillRect(-item.width/2, -item.height/2, item.width * 0.6, item.height * 0.6);
                
                // æ·»åŠ çº¹ç†æ•ˆæœï¼ˆå¯¹äºå±é™©ç‰©å“ï¼‰
                if (item.type === 'danger') {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                    for(let i = 0; i < 3; i++) {
                        ctx.fillRect(-item.width/2 + i * item.width/4, -item.height/2, 1, item.height);
                        ctx.fillRect(-item.width/2, -item.height/2 + i * item.height/4, item.width, 1);
                    }
                }
                
                // ç»˜åˆ¶è¡€æ¡ï¼ˆå¦‚æœæ˜¯å±é™©ç‰©å“ï¼‰
                if (item.maxHealth > 1) {
                    const healthBarWidth = item.width * 0.8;
                    const healthBarHeight = 6;
                    const healthPercentage = item.health / item.maxHealth;
                    
                    // è¡€æ¡èƒŒæ™¯
                    ctx.fillStyle = 'rgba(44, 62, 80, 0.8)';
                    ctx.fillRect(-healthBarWidth/2, -item.height/2 - 12, healthBarWidth, healthBarHeight);
                    
                    // è¡€æ¡è¾¹æ¡†
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(-healthBarWidth/2, -item.height/2 - 12, healthBarWidth, healthBarHeight);
                    
                    // è¡€æ¡å¡«å……
                    const healthGradient = ctx.createLinearGradient(-healthBarWidth/2, 0, healthBarWidth/2, 0);
                    if (healthPercentage > 0.6) {
                        healthGradient.addColorStop(0, '#2ed573');
                        healthGradient.addColorStop(1, '#7bed9f');
                    } else if (healthPercentage > 0.3) {
                        healthGradient.addColorStop(0, '#ff7675');
                        healthGradient.addColorStop(1, '#fdcb6e');
                    } else {
                        healthGradient.addColorStop(0, '#d63031');
                        healthGradient.addColorStop(1, '#e17055');
                    }
                    
                    ctx.fillStyle = healthGradient;
                    ctx.fillRect(-healthBarWidth/2, -item.height/2 - 12, healthBarWidth * healthPercentage, healthBarHeight);
                }
                
                // ç»˜åˆ¶ç‰©å“åç§°èƒŒæ™¯
                const fontSize = Math.max(10, 12 * gameState.itemSizeMultiplier);
                ctx.font = 'bold ' + fontSize + 'px Arial, sans-serif';
                ctx.textAlign = 'center';
                const textMetrics = ctx.measureText(item.name);
                const textWidth = textMetrics.width;
                
                // æ–‡å­—èƒŒæ™¯
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(-textWidth/2 - 4, -fontSize/2 - 2, textWidth + 8, fontSize + 4);
                
                // æ–‡å­—è¾¹æ¡†
                ctx.strokeStyle = item.type === 'danger' ? '#ff4757' : '#2ed573';
                ctx.lineWidth = 1;
                ctx.strokeRect(-textWidth/2 - 4, -fontSize/2 - 2, textWidth + 8, fontSize + 4);
                
                // ç»˜åˆ¶ç‰©å“åç§°
                ctx.fillStyle = '#ffffff';
                ctx.fillText(item.name, 0, fontSize/2 - 2);
                
                // æ·»åŠ æ–‡å­—é˜´å½±
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillText(item.name, 1, fontSize/2 - 1);
                
                ctx.restore();
            }

            // ç»˜åˆ¶å®‰æ£€æª - æœªæ¥ç§‘æŠ€é£æ ¼
            function drawGun() {
                ctx.save();
                ctx.translate(gun.x, gun.y);
                ctx.rotate(gun.angle);
                
                // ç»˜åˆ¶åº•åº§é˜´å½±
                ctx.save();
                ctx.translate(3, 3);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                ctx.beginPath();
                ctx.ellipse(0, gun.height/2, gun.width/2 + 5, 15, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
                
                // ç»˜åˆ¶åº•åº§ - åœ†å½¢åº•ç›˜
                const baseGradient = ctx.createRadialGradient(0, gun.height/2, 0, 0, gun.height/2, gun.width/2 + 5);
                baseGradient.addColorStop(0, '#1a365d');
                baseGradient.addColorStop(0.6, '#2d3748');
                baseGradient.addColorStop(1, '#4a5568');
                ctx.fillStyle = baseGradient;
                ctx.beginPath();
                ctx.ellipse(0, gun.height/2, gun.width/2 + 5, 15, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // åº•åº§è£…é¥°ç¯
                ctx.strokeStyle = '#63b3ed';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.ellipse(0, gun.height/2, gun.width/2 + 2, 12, 0, 0, Math.PI * 2);
                ctx.stroke();
                
                // ç»˜åˆ¶ä¸»ç‚®èº« - å…­è¾¹å½¢è®¾è®¡
                const sides = 6;
                const radius = gun.width / 2;
                
                // ç‚®èº«é˜´å½±
                ctx.save();
                ctx.translate(2, 2);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.beginPath();
                for (let i = 0; i < sides; i++) {
                    const angle = (i * Math.PI * 2) / sides;
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fill();
                ctx.restore();
                
                // ä¸»ç‚®èº«æ¸å˜
                const gunBodyGradient = ctx.createLinearGradient(-radius, -radius, radius, radius);
                gunBodyGradient.addColorStop(0, '#2b6cb0');
                gunBodyGradient.addColorStop(0.3, '#1a365d');
                gunBodyGradient.addColorStop(0.7, '#2d3748');
                gunBodyGradient.addColorStop(1, '#4a5568');
                ctx.fillStyle = gunBodyGradient;
                
                ctx.beginPath();
                for (let i = 0; i < sides; i++) {
                    const angle = (i * Math.PI * 2) / sides;
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fill();
                
                // ç‚®èº«è¾¹æ¡†
                ctx.strokeStyle = '#4299e1';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // ç§‘æŠ€çº¹ç†çº¿æ¡
                ctx.strokeStyle = '#63b3ed';
                ctx.lineWidth = 1;
                for (let i = 0; i < sides; i++) {
                    const angle = (i * Math.PI * 2) / sides;
                    const x1 = Math.cos(angle) * (radius * 0.7);
                    const y1 = Math.sin(angle) * (radius * 0.7);
                    const x2 = Math.cos(angle) * (radius * 0.9);
                    const y2 = Math.sin(angle) * (radius * 0.9);
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                }
                
                // ç»˜åˆ¶èƒ½é‡æ ¸å¿ƒ
                const coreGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, radius * 0.6);
                coreGradient.addColorStop(0, '#48dbfb');
                coreGradient.addColorStop(0.5, '#0abde3');
                coreGradient.addColorStop(1, '#006ba6');
                ctx.fillStyle = coreGradient;
                ctx.beginPath();
                ctx.arc(0, 0, radius * 0.6, 0, Math.PI * 2);
                ctx.fill();
                
                // æ ¸å¿ƒè„‰åŠ¨æ•ˆæœ
                const pulsePhase = (Date.now() * 0.005) % (Math.PI * 2);
                const pulseIntensity = (Math.sin(pulsePhase) + 1) * 0.3 + 0.4;
                const pulseGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, radius * 0.4);
                pulseGradient.addColorStop(0, `rgba(72, 219, 251, ${pulseIntensity})`);
                pulseGradient.addColorStop(1, 'transparent');
                ctx.fillStyle = pulseGradient;
                ctx.beginPath();
                ctx.arc(0, 0, radius * 0.4, 0, Math.PI * 2);
                ctx.fill();
                
                // ç»˜åˆ¶ç‚®ç®¡ - ä¸‰æ®µå¼è®¾è®¡
                const barrelSections = [
                    { start: gun.width/2 - 5, length: gun.barrelLength * 0.4, width: 8 },
                    { start: gun.width/2 - 5 + gun.barrelLength * 0.4, length: gun.barrelLength * 0.3, width: 10 },
                    { start: gun.width/2 - 5 + gun.barrelLength * 0.7, length: gun.barrelLength * 0.3, width: 6 }
                ];
                
                barrelSections.forEach((section, index) => {
                    // ç‚®ç®¡é˜´å½±
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                    ctx.fillRect(section.start + 1, -section.width/2 + 1, section.length, section.width);
                    
                    // ç‚®ç®¡ä¸»ä½“
                    const sectionGradient = ctx.createLinearGradient(0, -section.width/2, 0, section.width/2);
                    sectionGradient.addColorStop(0, index === 1 ? '#4299e1' : '#2d3748');
                    sectionGradient.addColorStop(0.5, index === 1 ? '#2b6cb0' : '#1a202c');
                    sectionGradient.addColorStop(1, index === 1 ? '#1a365d' : '#4a5568');
                    ctx.fillStyle = sectionGradient;
                    ctx.fillRect(section.start, -section.width/2, section.length, section.width);
                    
                    // ç‚®ç®¡é«˜å…‰
                    ctx.fillStyle = index === 1 ? '#63b3ed' : '#718096';
                    ctx.fillRect(section.start, -section.width/2, section.length, 2);
                    
                    // è¿æ¥å¤„è£…é¥°
                    if (index < barrelSections.length - 1) {
                        ctx.fillStyle = '#4299e1';
                        ctx.fillRect(section.start + section.length - 2, -section.width/2 - 2, 4, section.width + 4);
                    }
                });
                
                // ç‚®å£å‘å…‰æ•ˆæœ
                const muzzleX = gun.width/2 + gun.barrelLength - 5;
                const muzzleGlow = ctx.createRadialGradient(muzzleX, 0, 0, muzzleX, 0, 15);
                muzzleGlow.addColorStop(0, 'rgba(72, 219, 251, 0.8)');
                muzzleGlow.addColorStop(0.5, 'rgba(16, 185, 129, 0.4)');
                muzzleGlow.addColorStop(1, 'rgba(16, 185, 129, 0)');
                ctx.fillStyle = muzzleGlow;
                ctx.beginPath();
                ctx.arc(muzzleX, 0, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // ç‚®å£å†…éƒ¨
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(muzzleX, 0, 3, 0, Math.PI * 2);
                ctx.fill();
                
                // ç„å‡†æ¿€å…‰ç‚¹ï¼ˆå¦‚æœæ­£åœ¨ç„å‡†ï¼‰
                if (Math.abs(gun.targetX - gun.x) > 5 || Math.abs(gun.targetY - gun.y) > 5) {
                    const laserDistance = Math.min(200, Math.sqrt(Math.pow(gun.targetX - gun.x, 2) + Math.pow(gun.targetY - gun.y, 2)));
                    const laserX = muzzleX + laserDistance;
                    
                    // æ¿€å…‰æŸ
                    ctx.strokeStyle = 'rgba(255, 0, 0, 0.3)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(muzzleX, 0);
                    ctx.lineTo(laserX, 0);
                    ctx.stroke();
                    
                    // æ¿€å…‰ç‚¹
                    const laserDot = ctx.createRadialGradient(laserX, 0, 0, laserX, 0, 3);
                    laserDot.addColorStop(0, 'rgba(255, 0, 0, 0.8)');
                    laserDot.addColorStop(1, 'rgba(255, 0, 0, 0)');
                    ctx.fillStyle = laserDot;
                    ctx.beginPath();
                    ctx.arc(laserX, 0, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // çŠ¶æ€æŒ‡ç¤ºç¯
                const indicatorColors = {
                    ready: '#10b981',
                    reloading: '#f59e0b', 
                    empty: '#ef4444'
                };
                
                let indicatorColor = indicatorColors.ready;
                if (gameState.isReloading) {
                    indicatorColor = indicatorColors.reloading;
                } else if (gameState.currentAmmo === 0) {
                    indicatorColor = indicatorColors.empty;
                }
                
                ctx.fillStyle = indicatorColor;
                ctx.beginPath();
                ctx.arc(-gun.width/3, -gun.height/3, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // æŒ‡ç¤ºç¯å‘å…‰
                const indicatorGlow = ctx.createRadialGradient(-gun.width/3, -gun.height/3, 0, -gun.width/3, -gun.height/3, 8);
                indicatorGlow.addColorStop(0, indicatorColor + '80');
                indicatorGlow.addColorStop(1, 'transparent');
                ctx.fillStyle = indicatorGlow;
                ctx.beginPath();
                ctx.arc(-gun.width/3, -gun.height/3, 8, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
            }

            // ç»˜åˆ¶å­å¼¹
            function drawBullets() {
                for (const bullet of gameState.bullets) {
                    ctx.save();
                    
                    // å­å¼¹æ‹–å°¾æ•ˆæœ
                    const tailLength = 15;
                    const tailGradient = ctx.createLinearGradient(
                        bullet.x - Math.cos(bullet.angle) * tailLength, 
                        bullet.y - Math.sin(bullet.angle) * tailLength,
                        bullet.x, bullet.y
                    );
                    tailGradient.addColorStop(0, 'rgba(255, 255, 255, 0)');
                    tailGradient.addColorStop(0.5, 'rgba(255, 215, 0, 0.3)');
                    tailGradient.addColorStop(1, 'rgba(255, 140, 0, 0.8)');
                    
                    ctx.strokeStyle = tailGradient;
                    ctx.lineWidth = bullet.radius * 2;
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(bullet.x - Math.cos(bullet.angle) * tailLength, bullet.y - Math.sin(bullet.angle) * tailLength);
                    ctx.lineTo(bullet.x, bullet.y);
                    ctx.stroke();
                    
                    // å­å¼¹å¤–å±‚å…‰æ™•
                    const outerGlow = ctx.createRadialGradient(bullet.x, bullet.y, 0, bullet.x, bullet.y, bullet.radius + 6);
                    outerGlow.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
                    outerGlow.addColorStop(0.4, 'rgba(255, 215, 0, 0.6)');
                    outerGlow.addColorStop(0.7, 'rgba(255, 140, 0, 0.3)');
                    outerGlow.addColorStop(1, 'rgba(255, 69, 0, 0)');
                    ctx.fillStyle = outerGlow;
                    ctx.beginPath();
                    ctx.arc(bullet.x, bullet.y, bullet.radius + 6, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // å­å¼¹ä¸»ä½“
                    const bulletGradient = ctx.createRadialGradient(bullet.x - 1, bullet.y - 1, 0, bullet.x, bullet.y, bullet.radius);
                    bulletGradient.addColorStop(0, '#ffffff');
                    bulletGradient.addColorStop(0.3, '#ffd700');
                    bulletGradient.addColorStop(0.7, '#ff8c00');
                    bulletGradient.addColorStop(1, '#ff4500');
                    ctx.fillStyle = bulletGradient;
                    ctx.beginPath();
                    ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // å­å¼¹é«˜å…‰ç‚¹
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.beginPath();
                    ctx.arc(bullet.x - bullet.radius * 0.3, bullet.y - bullet.radius * 0.3, bullet.radius * 0.4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // èƒ½é‡è„‰å†²æ•ˆæœï¼ˆéšæ—¶é—´å˜åŒ–ï¼‰
                    const pulsePhase = (Date.now() * 0.01) % (Math.PI * 2);
                    const pulseIntensity = (Math.sin(pulsePhase) + 1) * 0.5;
                    const pulseGlow = ctx.createRadialGradient(bullet.x, bullet.y, 0, bullet.x, bullet.y, bullet.radius + 3);
                    pulseGlow.addColorStop(0, `rgba(135, 206, 250, ${pulseIntensity * 0.6})`);
                    pulseGlow.addColorStop(1, 'rgba(135, 206, 250, 0)');
                    ctx.fillStyle = pulseGlow;
                    ctx.beginPath();
                    ctx.arc(bullet.x, bullet.y, bullet.radius + 3, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.restore();
                }
            }

            // ç»˜åˆ¶çˆ†ç‚¸æ•ˆæœ
            function drawExplosions() {
                for (const explosion of gameState.explosions) {
                    ctx.save();
                    
                    const alpha = explosion.life / explosion.maxLife;
                    
                    if (explosion.type === 'shockwave') {
                        // å†²å‡»æ³¢ç¯å½¢æ•ˆæœ
                        ctx.globalAlpha = alpha * 0.6;
                        ctx.strokeStyle = explosion.color;
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                        ctx.stroke();
                        
                        // å†…éƒ¨å‘å…‰
                        ctx.globalAlpha = alpha * 0.3;
                        const shockGradient = ctx.createRadialGradient(
                            explosion.x, explosion.y, 0,
                            explosion.x, explosion.y, explosion.radius
                        );
                        shockGradient.addColorStop(0, explosion.secondaryColor);
                        shockGradient.addColorStop(0.7, explosion.color);
                        shockGradient.addColorStop(1, 'transparent');
                        ctx.fillStyle = shockGradient;
                        ctx.beginPath();
                        ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                        ctx.fill();
                    } else if (explosion.type === 'spark') {
                        // ç«èŠ±æ•ˆæœ
                        ctx.globalAlpha = alpha;
                        
                        // åˆ›å»ºç«èŠ±æ¸å˜
                        const sparkGradient = ctx.createRadialGradient(
                            explosion.x, explosion.y, 0,
                            explosion.x, explosion.y, explosion.radius
                        );
                        sparkGradient.addColorStop(0, explosion.color);
                        sparkGradient.addColorStop(0.5, explosion.secondaryColor);
                        sparkGradient.addColorStop(1, 'transparent');
                        
                        ctx.fillStyle = sparkGradient;
                        ctx.beginPath();
                        ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // æ·»åŠ å…‰èŠ’æ•ˆæœ
                        ctx.strokeStyle = explosion.color;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(explosion.x - explosion.radius * 2, explosion.y);
                        ctx.lineTo(explosion.x + explosion.radius * 2, explosion.y);
                        ctx.moveTo(explosion.x, explosion.y - explosion.radius * 2);
                        ctx.lineTo(explosion.x, explosion.y + explosion.radius * 2);
                        ctx.stroke();
                    } else {
                        // æ™®é€šçˆ†ç‚¸ç²’å­
                        ctx.globalAlpha = alpha;
                        
                        // åˆ›å»ºçˆ†ç‚¸ç²’å­æ¸å˜
                        const explosionGradient = ctx.createRadialGradient(
                            explosion.x, explosion.y, 0,
                            explosion.x, explosion.y, explosion.radius
                        );
                        explosionGradient.addColorStop(0, explosion.secondaryColor);
                        explosionGradient.addColorStop(0.4, explosion.color);
                        explosionGradient.addColorStop(1, 'transparent');
                        
                        ctx.fillStyle = explosionGradient;
                        ctx.beginPath();
                        ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // æ·»åŠ è¾¹æ¡†å…‰æ™•
                        ctx.globalAlpha = alpha * 0.5;
                        ctx.strokeStyle = explosion.secondaryColor;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                        ctx.stroke();
                    }
                    
                    ctx.restore();
                }
            }

            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            function showTip(text, color) {
                const tip = document.createElement('div');
                tip.textContent = text;
                tip.style.position = 'absolute';
                tip.style.left = (canvas.offsetLeft + 20) + 'px';
                tip.style.top = (canvas.offsetTop - 30) + 'px';
                tip.style.color = color;
                tip.style.fontWeight = 'bold';
                tip.style.textShadow = '1px 1px 2px black';
                document.body.appendChild(tip);
                
                setTimeout(() => {
                    tip.style.transition = 'opacity 0.5s, transform 0.5s';
                    tip.style.opacity = '0';
                    tip.style.transform = 'translateY(-20px)';
                    setTimeout(() => document.body.removeChild(tip), 500);
                }, 800);
            }

            // æ˜¾ç¤ºå…³å¡å®Œæˆ
            function showLevelComplete() {
                gameState.running = false;
                
                // è®¡ç®—å…³å¡å¾—åˆ†
                const timeBonus = Math.max(0, Math.floor(gameState.remainingTime / 1000)) * 5; // æ¯å‰©ä½™1ç§’å¾—5åˆ†
                const finalLevelScore = gameState.score + timeBonus;
                
                // åˆ›å»ºå…³å¡å®Œæˆç•Œé¢
                const levelCompleteDiv = document.createElement('div');
                levelCompleteDiv.className = 'game-over';
                levelCompleteDiv.innerHTML = `
                    <h2>ğŸ‰ ç¬¬${gameState.level}å…³å®Œæˆï¼</h2>
                    <p>åŸºç¡€å¾—åˆ†: ${gameState.score}åˆ†</p>
                    <p>æ—¶é—´å¥–åŠ±: ${timeBonus}åˆ† (å‰©ä½™${Math.floor(gameState.remainingTime / 1000)}ç§’)</p>
                    <p><strong>å…³å¡æ€»åˆ†: ${finalLevelScore}åˆ†</strong></p>
                    <button id="backToMenuBtn" class="start-button" style="margin: 10px;">è¿”å›é¦–é¡µ</button>
                `;
                
                document.getElementById('gamePage').appendChild(levelCompleteDiv);
                levelCompleteDiv.style.display = 'block';
                
                // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
                audioSystem.playSuccess();
                
                // æ·»åŠ è¿”å›é¦–é¡µæŒ‰é’®äº‹ä»¶
                document.getElementById('backToMenuBtn').addEventListener('click', function() {
                    levelCompleteDiv.remove();
                    document.getElementById('gamePage').style.display = 'none';
                    document.getElementById('startPage').style.display = 'flex';
                    
                    // é‡ç½®é£æœºå›¾æ ‡åŠ¨ç”»
                    const airplaneIcon = document.getElementById('airplaneIcon');
                    airplaneIcon.style.animation = 'float 3s ease-in-out infinite';
                    airplaneIcon.style.transform = 'scale(1)';
                });
            }

            // æ¸¸æˆç»“æŸ
            function endGame() {
                gameState.gameOver = true;
                gameState.running = false;
                
                audioSystem.playGameOver();
                document.getElementById('finalScore').textContent = gameState.score;
                gameOverDiv.style.display = 'block';
            }

            // é‡æ–°å¼€å§‹æ¸¸æˆ
            function restartGame() {
                gameState.running = true;
                gameState.score = 0;
                gameState.level = 1;
                gameState.gameOver = false;
                gameState.items = [];
                gameState.bullets = [];
                gameState.explosions = [];
                gameState.particles = [];
                gameState.backgroundParticles = [];
                gameState.lastItemTime = 0;
                gameState.itemInterval = 1500;
                gameState.combo = 0;
                gameState.lastComboTime = 0;
                gameState.isReloading = false;
                gameState.levelStartTime = Date.now();
                gameState.remainingTime = gameState.levelTimeLimit;
                
                resizeCanvas();
                updateGunPosition();
                setDifficulty();
                
                // é‡æ–°åˆå§‹åŒ–èƒŒæ™¯ç²’å­
                initBackgroundParticles();
                
                document.getElementById('score').textContent = gameState.score;
                document.getElementById('level').textContent = gameState.level;
                document.getElementById('lives').textContent = gameState.lives;
                updateAmmoDisplay();
                updateTimeDisplay();
                
                gameOverDiv.style.display = 'none';
                
                // é‡æ–°åˆ›å»ºèƒŒæ™¯ç²’å­
                createGamePageParticles();
                
                // é‡æ–°å¼€å§‹æ¸¸æˆå¾ªç¯
                gameLoop(0);
            }
            
            restartBtn.addEventListener('click', restartGame);
            restartBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                restartGame();
            });

            // è£…å¼¹æŒ‰é’®å·²ç§»è‡³æ‚¬æµ®æ§åˆ¶
            
            // åˆå§‹åŒ–éš¾åº¦
            setDifficulty();
            
            // ç¡®ä¿æ¸¸æˆç»“æŸç•Œé¢éšè—
            gameOverDiv.style.display = 'none';
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.running = true;
            gameState.gameOver = false;
            gameState.items = [];
            gameState.bullets = [];
            gameState.explosions = [];
            gameState.particles = [];
            gameState.backgroundParticles = [];
            gameState.lastItemTime = 0;
            
            // åˆå§‹åŒ–èƒŒæ™¯ç²’å­
            initBackgroundParticles();
            
            // ç§»åŠ¨ç«¯é€‚é…ä¼˜åŒ–
            if (isMobileDevice()) {
                // éšè—é¼ æ ‡æŒ‡é’ˆ
                canvas.style.cursor = 'none';
                // ç¦ç”¨ä¸Šä¸‹æ–‡èœå•
                canvas.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    return false;
                });
                // ç¦ç”¨åŒå‡»ç¼©æ”¾
                canvas.addEventListener('dblclick', function(e) {
                    e.preventDefault();
                    return false;
                });
            }
            
            // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´æªçš„ä½ç½®
            window.addEventListener('resize', function() {
                setTimeout(() => {
                    updateGunPosition();
                }, 100);
            });
            
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    updateGunPosition();
                }, 100);
            });

            // æ¸¸æˆä¸»å¾ªç¯
            function gameLoop(timestamp) {
                if (!gameState.running || gameState.gameOver) return;
                
                // æ¸…é™¤ç”»å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶å’Œæ›´æ–°èƒŒæ™¯ç²’å­
                updateBackgroundParticles();
                drawBackgroundParticles();
                
                // ç”Ÿæˆæ–°ç‰©å“
                generateItem(timestamp);
                
                // æ›´æ–°å’Œç»˜åˆ¶ç‰©å“
                for (let i = 0; i < gameState.items.length; i++) {
                    const item = gameState.items[i];
                    item.y += item.speed;
                    item.rotation += item.rotationSpeed;
                    drawRotatedItem(item);
                }
                
                // æ›´æ–°å’Œç»˜åˆ¶å­å¼¹
                checkBulletCollisions();
                drawBullets();
                
                // æ›´æ–°å’Œç»˜åˆ¶çˆ†ç‚¸æ•ˆæœ
                updateExplosions();
                drawExplosions();
                
                // æ›´æ–°å’Œç»˜åˆ¶ç‰¹æ•ˆç²’å­
                updateParticles();
                drawParticles();
                
                // æ£€æŸ¥ç‰©å“æ˜¯å¦è½åˆ°åº•éƒ¨
                checkItemBottom();
                
                // æ›´æ–°æ—¶é—´
                gameState.remainingTime = gameState.levelTimeLimit - (Date.now() - gameState.levelStartTime);
                updateTimeDisplay();
                
                // æ£€æŸ¥æ—¶é—´æ˜¯å¦ç”¨å®Œ
                if (gameState.remainingTime <= 0) {
                    showLevelComplete();
                    return;
                }
                
                // æ£€æŸ¥å¼¹è¯æ˜¯å¦ä¸º0ä¸”æ— å‰©ä½™å­å¼¹
                if (gameState.currentAmmo === 0 && gameState.bullets.length === 0) {
                    showTip(`å¼¹è¯è€—å°½ï¼å…³å¡å¤±è´¥ï¼`, 'red');
                    audioSystem.playGameOver();
                    endGame();
                    return;
                }
                
                // ç»˜åˆ¶å®‰æ£€æª
                drawGun();
                
                
                requestAnimationFrame(gameLoop);
            }

            // å¼€å§‹æ¸¸æˆå¾ªç¯
            gameLoop(0);
        }
    </script>
</body>
</html>