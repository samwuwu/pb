<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æ‰‹åŠ¿æ§åˆ¶ç§‘æŠ€åœ°çƒ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Segoe UI', sans-serif; }
        
        /* å¯åŠ¨é®ç½©å±‚ */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 999;
            color: white;
            text-align: center;
        }

        button {
            padding: 15px 40px; font-size: 20px; cursor: pointer;
            background: #00d2ff; color: #000; border: none; border-radius: 30px;
            font-weight: bold; margin-top: 20px;
            box-shadow: 0 0 20px #00d2ff;
            transition: transform 0.2s;
        }
        button:hover { transform: scale(1.05); background: #fff; }

        /* è°ƒè¯•çª—å£ */
        #debug-win {
            position: absolute; top: 10px; left: 10px;
            width: 160px; height: 120px;
            border: 2px solid #333;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            z-index: 10;
        }
        #input-video {
            width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* é•œåƒ */
        }

        #status-bar {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            color: #00d2ff;
            font-size: 16px;
            text-shadow: 0 0 5px #00d2ff;
            pointer-events: none;
        }
    </style>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>
<body>

    <!-- 1. å¯åŠ¨ç•Œé¢ -->
    <div id="overlay">
        <h1>ğŸ–ï¸ æ‰‹åŠ¿æ§åˆ¶ 3D åœ°çƒ</h1>
        <p>æ— éœ€å›¾ç‰‡èµ„æº | çº¯ä»£ç æ¸²æŸ“ | äº¤äº’å¯åŠ¨</p>
        <div id="error-msg" style="color: #ff4444; margin-top:10px; display:none;"></div>
        <button id="start-btn">ç‚¹å‡»å¯åŠ¨æ‘„åƒå¤´</button>
    </div>

    <!-- 2. æ‘„åƒå¤´å°çª—å£ -->
    <div id="debug-win">
        <video id="input-video" playsinline muted></video>
    </div>

    <!-- 3. çŠ¶æ€æ  -->
    <div id="status-bar">ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…å¯åŠ¨...</div>

<script>
    // ------------------------------------------------------------------
    // ç¬¬ä¸€æ­¥ï¼šæ„å»º 3D åœºæ™¯ (æ— éœ€è´´å›¾ï¼Œç”¨çº¿æ¡æ¨¡æ‹Ÿç§‘æŠ€æ„Ÿåœ°çƒ)
    // ------------------------------------------------------------------
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050505);
    // å¢åŠ ä¸€ç‚¹é›¾æ•ˆï¼Œåˆ¶é€ æ·±é‚ƒæ„Ÿ
    scene.fog = new THREE.FogExp2(0x050505, 0.15);

    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
    camera.position.z = 6;

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // æ ¸å¿ƒç»„
    const earthGroup = new THREE.Group();
    scene.add(earthGroup);

    // 1. åŸºç¡€è“çƒ
    const sphereGeo = new THREE.SphereGeometry(1.5, 32, 32);
    const sphereMat = new THREE.MeshBasicMaterial({ color: 0x001133 });
    const earthBase = new THREE.Mesh(sphereGeo, sphereMat);
    earthGroup.add(earthBase);

    // 2. çº¿æ¡† (ç§‘æŠ€æ„Ÿç»çº¬çº¿)
    const wireframeGeo = new THREE.WireframeGeometry(sphereGeo);
    const wireframeMat = new THREE.LineBasicMaterial({ color: 0x00aaff, transparent: true, opacity: 0.3 });
    const wireframe = new THREE.LineSegments(wireframeGeo, wireframeMat);
    // è®©çº¿æ¡†ç¨å¾®å¤§ä¸€ç‚¹ç‚¹ï¼Œé¿å…é‡å é—ªçƒ
    wireframe.scale.set(1.01, 1.01, 1.01); 
    earthGroup.add(wireframe);

    // 3. ç²’å­å…‰ç¯ (ä»£æ›¿æ˜Ÿæ˜Ÿ)
    const particlesGeo = new THREE.BufferGeometry();
    const particleCount = 800;
    const posArray = new Float32Array(particleCount * 3);
    for(let i=0; i<particleCount*3; i++){
        posArray[i] = (Math.random() - 0.5) * 15;
    }
    particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
    const particlesMat = new THREE.PointsMaterial({ size: 0.05, color: 0xffffff });
    const starField = new THREE.Points(particlesGeo, particlesMat);
    scene.add(starField);

    // æ¸²æŸ“å¾ªç¯
    let isControlling = false;
    function animate() {
        requestAnimationFrame(animate);
        
        // å¦‚æœæ²¡äººæ§åˆ¶ï¼Œåœ°çƒè‡ªå·±ç¼“æ…¢ç©ºè½¬
        if (!isControlling) {
            earthGroup.rotation.y += 0.002;
            earthGroup.rotation.x += 0.0005;
        }

        renderer.render(scene, camera);
    }
    animate();

    // çª—å£è‡ªé€‚åº”
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // ------------------------------------------------------------------
    // ç¬¬äºŒæ­¥ï¼šMediaPipe æ‰‹åŠ¿è¯†åˆ«é€»è¾‘
    // ------------------------------------------------------------------
    const statusBar = document.getElementById('status-bar');
    const videoElement = document.getElementById('input-video');
    let hands;

    function setupMediaPipe() {
        hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults((results) => {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                isControlling = true;
                statusBar.innerText = "ğŸ–ï¸ æ‰‹åŠ¿å·²è¯†åˆ«ï¼šæåˆç¼©æ”¾ | ç§»åŠ¨æ—‹è½¬";
                statusBar.style.color = "#00ff00";

                const landmarks = results.multiHandLandmarks[0];

                // 1. ç¼©æ”¾æ§åˆ¶ (å¤§æ‹‡æŒ‡ index:4 ä¸ é£ŸæŒ‡ index:8)
                const p1 = landmarks[4];
                const p2 = landmarks[8];
                // è®¡ç®—æ¬§å‡ é‡Œå¾—è·ç¦»
                const dist = Math.sqrt(Math.pow(p1.x-p2.x, 2) + Math.pow(p1.y-p2.y, 2));
                
                // è·ç¦»æ˜ å°„ï¼š0.05(æåˆ) ~ 0.25(å¼ å¼€)
                let scale = dist * 8; 
                scale = Math.max(0.5, Math.min(scale, 3.5)); // é™åˆ¶èŒƒå›´
                
                // çº¿æ€§æ’å€¼è®©ç¼©æ”¾å˜å¹³æ»‘
                earthGroup.scale.lerp(new THREE.Vector3(scale, scale, scale), 0.1);

                // 2. æ—‹è½¬æ§åˆ¶ (å–æ‰‹æŒä¸­å¿ƒ)
                const wrist = landmarks[0];
                const mid = landmarks[9];
                const cx = (wrist.x + mid.x) / 2;
                const cy = (wrist.y + mid.y) / 2;

                // æ˜ å°„åæ ‡ 0~1 åˆ°æ—‹è½¬è§’åº¦
                const rotX = (cy - 0.5) * 5; 
                const rotY = (cx - 0.5) * 5;

                earthGroup.rotation.x += (rotX - earthGroup.rotation.x) * 0.1;
                earthGroup.rotation.y += (rotY - earthGroup.rotation.y) * 0.1;

            } else {
                isControlling = false;
                statusBar.innerText = "ğŸ‘€ æ­£åœ¨å¯»æ‰¾æ‰‹éƒ¨...";
                statusBar.style.color = "#00d2ff";
            }
        });
    }

    // ------------------------------------------------------------------
    // ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨é€»è¾‘ (è§£å†³æµè§ˆå™¨æ‹¦æˆªé—®é¢˜)
    // ------------------------------------------------------------------
    const startBtn = document.getElementById('start-btn');
    const overlay = document.getElementById('overlay');
    const errorMsg = document.getElementById('error-msg');

    startBtn.addEventListener('click', async () => {
        startBtn.innerText = "æ­£åœ¨å¯åŠ¨...";
        startBtn.disabled = true;

        try {
            // 1. åˆå§‹åŒ– MediaPipe
            setupMediaPipe();

            // 2. è¯·æ±‚æ‘„åƒå¤´ (å¿…é¡»åœ¨ç‚¹å‡»äº‹ä»¶ä¸­è§¦å‘)
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: 320, height: 240, facingMode: 'user' },
                audio: false
            });

            videoElement.srcObject = stream;
            
            videoElement.onloadedmetadata = () => {
                videoElement.play();
                overlay.style.display = 'none'; // éšè—å¯åŠ¨å±‚
                detectLoop(); // å¼€å§‹æ£€æµ‹å¾ªç¯
            };

        } catch (err) {
            console.error(err);
            startBtn.innerText = "å¯åŠ¨å¤±è´¥";
            startBtn.disabled = false;
            errorMsg.style.display = 'block';
            
            // ç»™å‡ºå…·ä½“ä¸­æ–‡é”™è¯¯å»ºè®®
            if(window.location.protocol === 'file:') {
                errorMsg.innerHTML = "âŒ é”™è¯¯ï¼šä¸èƒ½ç›´æ¥æ‰“å¼€ html æ–‡ä»¶ã€‚<br>è¯·ä½¿ç”¨ VS Code Live Server æˆ–æœ¬åœ°æœåŠ¡å™¨ (localhost) è¿è¡Œã€‚";
            } else if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                errorMsg.innerHTML = "âŒ é”™è¯¯ï¼šä½ æ‹’ç»äº†æ‘„åƒå¤´æƒé™ã€‚<br>è¯·åœ¨æµè§ˆå™¨åœ°å€æ å·¦ä¾§ç‚¹å‡»å›¾æ ‡å…è®¸è®¿é—®ã€‚";
            } else {
                errorMsg.innerText = "âŒ é”™è¯¯: " + err.message;
            }
        }
    });

    async function detectLoop() {
        // åªæœ‰è§†é¢‘åœ¨æ’­æ”¾æ—¶æ‰å‘é€æ•°æ®
        if (videoElement.readyState >= 2) {
            await hands.send({image: videoElement});
        }
        requestAnimationFrame(detectLoop);
    }

</script>
</body>
</html>