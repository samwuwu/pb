<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>随音而行 - 致敬方大同</title>
    <link rel="icon" type="image/png" href="assets/album-cover-192.png">
    <link rel="manifest" href="manifest.json">
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                bg: '#2A2A2A',
                fg: '#FFFFFF',
                muted: 'rgba(255, 255, 255, 0.6)'
              }
            },
            boxShadow: {
              album: '0 8px 32px rgba(0,0,0,0.45)'
            }
          }
        }
      }
    </script>
    <!-- iOS 锁屏显示相关 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="随音而行">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/album-cover-180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="assets/album-cover-167.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/album-cover-152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="assets/album-cover-120.png">
    <link rel="apple-touch-icon-precomposed" href="assets/album-cover-180.png">
    <link rel="apple-touch-startup-image" href="assets/album-cover-512.png">
    <meta name="theme-color" content="#2A2A2A">
    <meta name="description" content="随音而行 - 致敬方大同，一首充满音乐情怀的歌曲">
    <meta property="og:title" content="随音而行 - 致敬方大同">
    <meta property="og:description" content="随音而行 - 致敬方大同，一首充满音乐情怀的歌曲">
    <meta property="og:image" content="assets/share-1200x630.jpg">
    <meta property="og:url" content="https://example.com/music/song.html">
    <meta property="og:type" content="music.song">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="随音而行 - 致敬方大同">
    <meta name="twitter:description" content="随音而行 - 致敬方大同，一首充满音乐情怀的歌曲">
    <meta name="twitter:image" content="assets/share-1200x630.jpg">
    <!-- 微信分享相关 -->
    <meta itemprop="name" content="随音而行 - 致敬方大同">
    <meta itemprop="description" content="随音而行 - 致敬方大同，一首充满音乐情怀的歌曲">
    <meta itemprop="image" content="assets/share-1200x630.jpg">
    <meta name="weixin:card" content="summary_large_image">
    <meta name="weixin:title" content="随音而行 - 致敬方大同">
    <meta name="weixin:description" content="随音而行 - 致敬方大同，一首充满音乐情怀的歌曲">
    <meta name="weixin:image" content="assets/share-1200x630.jpg">
    <!-- PWA iOS 特定标签 -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- 移除音频预加载，移动端首开降流量 -->
    <!-- 预加载封面图片 -->
    <link rel="preload" href="assets/album-cover.jpg" as="image" type="image/jpeg">
    <style>
        :root {
            --background-color: #2A2A2A;
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --progress-bar-bg: rgba(255, 255, 255, 0.2);
            --progress-bar-fg: #FFFFFF;
            --bottom-bar-bg: rgba(40, 40, 40, 0.8);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'PingFang SC', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .song-container {
            background: linear-gradient(180deg, rgba(60,60,60,0.5) 0%, var(--background-color) 30%);
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 3rem;
            position: relative;
        }

        .lyrics-container {
            /* 位置/布局/显示由 Tailwind 类控制 */
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: var(--text-secondary) transparent;
        }

        .lyrics-container::-webkit-scrollbar {
            width: 6px;
        }

        .lyrics-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .lyrics-container::-webkit-scrollbar-thumb {
            background-color: var(--text-secondary);
            border-radius: 3px;
        }

        /* 使用 Tailwind 的 transition-opacity 控制显隐，无需自定义 keyframes */

        /* 歌词顶部栏布局/背景交由 Tailwind 控制 */

        /* 歌词标题与关闭按钮样式交由 Tailwind 控制 */

        /* .lyric-line 的基础排版与悬停交互改由 Tailwind 类实现 */

        .lyric-line.active {
            color: var(--text-primary);
            opacity: 1;
            font-size: 20px;
            font-weight: 600;
            transform: scale(1.05);
            animation: highlight-no-bg 2s ease;
            margin: 0.5rem 0;
            filter: blur(0);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .lyric-line.near-active {
            opacity: 0.8;
            filter: blur(0.2px);
            transform: scale(1.01);
            transition: all 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .lyric-line.far {
            opacity: 0.3;
            filter: blur(1px);
            transition: all 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        @keyframes highlight-no-bg {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }
            40% {
                transform: scale(1.07);
                opacity: 1;
            }
            100% {
                transform: scale(1.05);
                opacity: 1;
            }
        }
        
        @keyframes highlight {
            0% { opacity: 0; }
            100% { opacity: 0; }
        }

        .album-cover {
            width: 320px;
            height: 320px;
            margin: 1rem auto;
            position: relative;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 4px 60px rgba(0,0,0,0.5);
            animation: rotate 20s linear infinite;
            animation-play-state: paused;
            background: #000;
            padding: 16px;
        }

        .album-cover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: linear-gradient(45deg, #000 0%, #333 100%);
            z-index: 1;
        }

        .album-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            position: relative;
            z-index: 1;
        }

        .album-cover.playing {
            animation-play-state: running;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* .song-title 的基础样式由 Tailwind 提供，移除冗余规则 */

        .artist {
            font-size: 19px;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 1rem;
            font-weight: normal;
        }

        .song-info {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--text-secondary);
            color: var(--text-secondary);
            font-size: 0.9rem;
            width: 100%;
            max-width: 600px;
        }

        /* fixed-player 的定位与安全区内边距在后续块中统一设置 */
        .fixed-player {
            background: linear-gradient(to top, var(--background-color) 70%, transparent);
            box-shadow: none;
            position: fixed;
            left: 0;
            right: 0;
            z-index: 2001;
        }

        /* 控制区布局/尺寸/颜色均交由 Tailwind，保留播放图标显隐规则 */
        
        .play-button.playing .play-icon {
            display: none;
        }
        
        .play-button.playing .pause-icon {
            display: block;
        }
        
        .play-button.paused .play-icon {
            display: block;
        }
        
        .play-button.paused .pause-icon {
            display: none;
        }

        /* 歌词按钮交互与配色由 Tailwind 提供 */

        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 180px;
        }

        .bottom-controls {
            display: none;
        }

        .additional-controls {
            display: none;
        }

        .volume-control {
            display: none;
        }

        .volume-slider {
            display: none;
        }

        .volume-progress {
            display: none;
        }

        #audio-player {
            position: absolute;
            opacity: 0;
            height: 0;
            width: 0;
            z-index: -1;
        }

        @media (max-width: 480px) {
            .album-cover {
                width: 280px;
                height: 280px;
                padding: 12px;
            }
            
            .player-controls {
                gap: 3rem;
            }
            
            .control-button {
                font-size: 24px;
                width: 30px;
                height: 30px;
            }
            
            .play-button {
                font-size: 36px;
                width: 40px;
                height: 40px;
            }
            
            /* 歌词行的字号与间距在元素上用 Tailwind 控制 */
            
            .section-title {
                font-size: 13px;
                margin-top: 1.5rem;
                margin-bottom: 0.8rem;
            }
        }
    </style>
    <style>
        /* 覆盖与增强：移动端进度条、安全区与性能优化 */
        .album-cover { box-shadow: 0 8px 32px rgba(0,0,0,0.45); will-change: transform; }
        .lyric-line.active { will-change: transform, opacity; }
        .fixed-player { bottom: 0; padding: 2rem 1.5rem calc(0.75rem + env(safe-area-inset-bottom)); }

        .seek-range {
            -webkit-appearance: none; appearance: none; width: 100%; height: 4px;
            border-radius: 2px; background: var(--progress-bar-bg); outline: none; margin: 0;
            cursor: pointer; touch-action: none;
            background-image: linear-gradient(to right, var(--progress-bar-fg) 0%, var(--progress-bar-fg) 0%, var(--progress-bar-bg) 0%, var(--progress-bar-bg) 100%);
            background-repeat: no-repeat;
        }
        .seek-range::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%;
            background: var(--text-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.25); margin-top: -6px;
        }
        .seek-range::-moz-range-thumb {
            width: 14px; height: 14px; border: none; border-radius: 50%; background: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
        }
        /* 取消歌词校准的样式（不再使用） */
    </style>
</head>
<body>
    <div class="song-container min-h-screen flex flex-col items-center px-4">
        <div class="main-content flex flex-col items-center pb-[180px] w-full max-w-screen-sm">
            <div class="album-cover mx-auto my-4">
                <img src="assets/album-cover.jpg" alt="专辑封面">
            </div>
            <h1 class="song-title text-2xl text-white mt-6 font-medium text-center">随音而行</h1>
            <div class="artist text-lg text-brand-muted mb-4 text-center">- 致敬方大同</div>
            <button class="lyrics-button inline-flex items-center gap-1.5 rounded-full px-5 py-2 bg-white/10 text-brand-muted hover:bg-white/20 hover:text-white transition-colors transform hover:scale-105 active:scale-95">
                <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M2 4v16h20V4H2zm2 14V6h16v12H4zm2-6h12v2H6v-2zm0-3h12v2H6V9z"/>
                </svg>
                歌词
            </button>
        </div>
    </div>

    <div class="lyrics-container fixed top-0 left-0 right-0 bottom-[200px] bg-[var(--background-color)] z-[2000] hidden flex flex-col overflow-y-auto px-4 overscroll-contain pointer-events-none transition-opacity opacity-0">
        <div class="lyrics-header fixed top-0 left-0 right-0 p-4 bg-gradient-to-b from-[var(--background-color)] to-transparent z-[2001] flex justify-between items-center pointer-events-auto">
            <div style="width: 20px;"></div>
            <div class="lyrics-title text-white text-lg font-semibold text-center">随音而行</div>
            <button class="close-lyrics inline-flex items-center justify-center cursor-pointer text-white/60 hover:text-white transition p-2" aria-label="关闭歌词">
                <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
        </div>
        <div class="lyrics show mx-auto max-w-[680px] px-4 text-center text-brand-muted relative mt-16">
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="11">《黑白》琴键上 听见风</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="16">《南音》 回荡着 自由歌声</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="21">你我和旋律，《三人游》</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="26">节奏在心中 跳动着自由</div>

            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="30">你是 《特别的人》 教我懂得 《爱爱爱》</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="36">陪我走过 《危险世界》 迎接 《未来》</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="41">你的音乐如清风 将心打开</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="46">自由不羁灵魂 永不被阻碍</div>

            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="51">《橙月》 光下 轻轻哼唱</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="56">放飞 《千纸鹤》 承载愿望</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="62">纵然渺小如 《小小虫》</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="67">音符也能照亮寂寞夜空</div>

            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="72">你是 《特别的人》 教我懂得 《爱爱爱》</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="78">陪我走过 《危险世界》 迎接 《未来》</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="83">你的音乐如清风 将心打开</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="88">自由不羁灵魂 永不被阻碍</div>

            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="95">《橙月》 光下 轻轻哼唱</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="99">放飞 《千纸鹤》 承载愿望</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="104">纵然渺小如 《小小虫》</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="109">音符也能照亮寂寞夜空</div>

            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="115">你是 《特别的人》 教我懂得 《爱爱爱》</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="120">陪我走过 《危险世界》 迎接 《未来》</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="126">你的音乐如清风 将心打开</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="131">自由不羁灵魂 永不被阻碍</div>

            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="136">旋律在耳边 轻轻流淌</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="141">歌声在世界 回响不忘</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="146">《如果爱》 能跨越时光</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="152">音乐是最温暖的光</div>

            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="157">你是 《特别的人》 教我懂得 《爱爱爱》</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="162">陪我走过 《危险世界》 迎接 《未来》</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="168">你的音乐如清风 将心打开</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="173">自由不羁灵魂 永不被阻碍</div>

            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="177">风吹起 旋律仍在耳际</div>
            <div class="lyric-line select-none transition duration-500 ease-[cubic-bezier(0.25,0.1,0.25,1)] cursor-pointer text-center opacity-50 my-1.5 py-4 rounded-lg tracking-[0.5px] filter blur-[0.5px] hover:text-white hover:opacity-90 hover:scale-[1.02] hover:blur-0 leading-[1.6]" data-time="181">音乐不停 记忆随音延续……</div>
        </div>
    </div>

    <div class="fixed-player">
        <input type="range" id="seek" class="seek-range w-full" min="0" max="100" step="0.1" value="0" aria-label="进度">
        <div class="time-info flex justify-between text-xs text-brand-muted my-2 font-medium">
            <span id="current-time">0:03</span>
            <span id="duration">-3:04</span>
        </div>
        <div class="player-controls flex items-center justify-center gap-16 my-2">
            <button class="control-button w-9 h-9 flex items-center justify-center text-white transition-transform duration-150 hover:scale-110 active:scale-95" id="prev" aria-label="上一首">
                <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24">
                    <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                </svg>
            </button>
            <button class="control-button play-button paused w-10 h-10 flex items-center justify-center text-white transition-transform duration-150 hover:scale-110 active:scale-95" id="play" aria-label="播放/暂停">
                <svg class="play-icon w-6 h-6 fill-current" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                <svg class="pause-icon w-6 h-6 fill-current" viewBox="0 0 24 24">
                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                </svg>
            </button>
            <button class="control-button w-9 h-9 flex items-center justify-center text-white transition-transform duration-150 hover:scale-110 active:scale-95" id="next" aria-label="下一首">
                <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24">
                    <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                </svg>
            </button>
        </div>
        <div class="additional-controls hidden"></div>
        <audio id="audio-player" controls preload="metadata" playsinline webkit-playsinline x-webkit-airplay="allow">
            <source src="assets/随音而行.mp3" type="audio/mpeg">
            您的浏览器不支持音频播放。
        </audio>
    </div>

    <script>
        const audio = document.getElementById('audio-player');
        const lyrics = document.querySelectorAll('.lyric-line');
        const playButton = document.getElementById('play');
        const seek = document.getElementById('seek');
        const currentTimeDisplay = document.getElementById('current-time');
        const durationDisplay = document.getElementById('duration');
        const prevButton = document.getElementById('prev');
        const nextButton = document.getElementById('next');
        let currentLyric = null;
        let isPlaying = false;
        let lastUpdateTime = 0;
        const UPDATE_INTERVAL = 100; // 更新间隔（毫秒）
        let lastSaveTime = 0;
        const SAVE_INTERVAL = 5000; // 进度保存间隔（毫秒）

        // 默认不注册 Service Worker（网页浏览优先）。如需开启，使用 ?sw=1
        (function(){
            try {
                const params = new URLSearchParams(location.search);
                const enableSW = params.get('sw') === '1';
                if (enableSW && 'serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('./sw.js').then(reg => {
                            console.log('Service Worker 注册成功:', reg.scope);
                        }).catch(err => console.warn('Service Worker 注册失败:', err));
                    });
                }
            } catch(_) {}
        })();

        // —— Media Session 统一初始化（iOS/Android）与节流 ——
        let mediaSessionInitialized = false;
        const artworkUrl = 'album-cover.jpg';
        const throttle = (fn, wait) => { let last=0, timer=null; return (...args)=>{ const now=Date.now(); const remain=wait-(now-last); if (remain<=0){ last=now; fn(...args);} else { clearTimeout(timer); timer=setTimeout(()=>{ last=Date.now(); fn(...args); }, remain);} }; };

        function setMediaMetadataIfChanged() {
            if (!('mediaSession' in navigator)) return;
            const md = navigator.mediaSession.metadata;
            const next = { title:'随音而行', artist:'致敬方大同', album:'随音而行', artwork:[
                { src: 'assets/album-cover-96.jpg', sizes:'96x96', type:'image/jpeg' },
                { src: 'assets/album-cover-128.jpg', sizes:'128x128', type:'image/jpeg' },
                { src: 'assets/album-cover-192.jpg', sizes:'192x192', type:'image/jpeg' },
                { src: 'assets/album-cover-256.jpg', sizes:'256x256', type:'image/jpeg' },
                { src: 'assets/album-cover-384.jpg', sizes:'384x384', type:'image/jpeg' },
                { src: 'assets/album-cover-512.jpg', sizes:'512x512', type:'image/jpeg' }
            ]};
            const same = md && md.title===next.title && md.artist===next.artist && md.album===next.album;
            if (!same) { try { navigator.mediaSession.metadata = new MediaMetadata(next); } catch(_) {} }
            navigator.mediaSession.playbackState = audio.paused ? 'paused' : 'playing';
        }

        const updatePositionState = () => {
            if (!('mediaSession' in navigator) || !('setPositionState' in navigator.mediaSession)) return;
            try {
                navigator.mediaSession.setPositionState({
                    duration: isFinite(audio.duration) ? audio.duration : 0,
                    playbackRate: audio.playbackRate || 1,
                    position: isFinite(audio.currentTime) ? audio.currentTime : 0
                });
            } catch(_) {}
        };
        const updatePositionStateThrottled = throttle(updatePositionState, 1000);

        function setupMediaSession() {
            if (!('mediaSession' in navigator)) return;
            if (!mediaSessionInitialized) {
                setMediaMetadataIfChanged();
                navigator.mediaSession.setActionHandler('play', () => audio.play());
                navigator.mediaSession.setActionHandler('pause', () => audio.pause());
                navigator.mediaSession.setActionHandler('previoustrack', () => { audio.currentTime = 0; updatePositionState(); });
                navigator.mediaSession.setActionHandler('nexttrack', () => { audio.currentTime = 0; updatePositionState(); });
                navigator.mediaSession.setActionHandler('seekto', details => {
                    if (details.fastSeek && 'fastSeek' in audio) audio.fastSeek(details.seekTime);
                    else audio.currentTime = details.seekTime;
                    updatePositionState();
                });
                const SKIP = 10;
                navigator.mediaSession.setActionHandler('seekbackward', e => { const d=(e&&e.seekOffset)||SKIP; audio.currentTime=Math.max(0, audio.currentTime-d); updatePositionState(); });
                navigator.mediaSession.setActionHandler('seekforward', e => { const d=(e&&e.seekOffset)||SKIP; audio.currentTime=Math.min(isFinite(audio.duration)?audio.duration:audio.currentTime+d, audio.currentTime+d); updatePositionState(); });
                try { navigator.mediaSession.setActionHandler('stop', ()=>{ audio.pause(); audio.currentTime=0; navigator.mediaSession.playbackState='none'; updatePositionState(); }); } catch(_) {}
                mediaSessionInitialized = true;
            } else {
                setMediaMetadataIfChanged();
            }

            audio.addEventListener('play', ()=>{ navigator.mediaSession.playbackState='playing'; updatePositionState(); });
            audio.addEventListener('pause', ()=>{ navigator.mediaSession.playbackState='paused'; updatePositionState(); });
            audio.addEventListener('timeupdate', ()=>{ if (!audio.paused) updatePositionStateThrottled(); });
            audio.addEventListener('seeked', ()=>{ updatePositionState(); });
            document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState==='visible'){ setMediaMetadataIfChanged(); updatePositionState(); } });
        }

        // 播放按钮点击事件
        playButton.addEventListener('click', function() {
            if (audio.paused) {
                // 播放音频
                const playPromise = audio.play();
                
                // 处理播放承诺
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        // 播放成功
                        playButton.classList.add('playing');
                        playButton.classList.remove('paused');
                        isPlaying = true;
                        albumCover.classList.add('playing');
                        
                        if ('mediaSession' in navigator) {
                            navigator.mediaSession.playbackState = 'playing';
                            updatePositionState();
                        }
                    }).catch(error => {
                        // 播放失败
                        console.error('播放失败:', error);
                        showToast('播放失败，请点按页面后重试（iOS 需用户交互）');
                    });
                }
            } else {
                // 暂停音频
                audio.pause();
                playButton.classList.remove('playing');
                playButton.classList.add('paused');
                isPlaying = false;
                albumCover.classList.remove('playing');
                
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.playbackState = 'paused';
                    updatePositionState();
                }
            }
        });

        // 上一首/下一首控制
        prevButton.addEventListener('click', () => {
            audio.currentTime = 0;
        });

        nextButton.addEventListener('click', () => {
            audio.currentTime = 0;
        });

        // 进度条UI更新
        function updateSeekUI() {
            if (!audio.duration || !seek) return;
            const progress = (audio.currentTime / audio.duration) * 100;
            seek.value = isNaN(progress) ? 0 : progress;

            // 计算缓冲进度
            let bufferedEnd = 0;
            try {
                if (audio.buffered && audio.buffered.length) {
                    bufferedEnd = audio.buffered.end(audio.buffered.length - 1);
                }
            } catch (_) {}
            const bufferedPercent = audio.duration ? Math.min(100, (bufferedEnd / audio.duration) * 100) : 0;

            // 更新range背景（已播放/已缓冲/未缓冲）
            const played = Math.max(0, Math.min(100, progress));
            const buff = Math.max(played, bufferedPercent);
            seek.style.backgroundImage = `linear-gradient(to right,
                var(--progress-bar-fg) 0%,
                var(--progress-bar-fg) ${played}%,
                rgba(255,255,255,0.35) ${played}%,
                rgba(255,255,255,0.35) ${buff}%,
                var(--progress-bar-bg) ${buff}%,
                var(--progress-bar-bg) 100%)`;
        }

        audio.addEventListener('timeupdate', () => {
            const now = Date.now();
            if (now - lastUpdateTime >= UPDATE_INTERVAL) {
                updateSeekUI();
                currentTimeDisplay.textContent = formatTime(audio.currentTime);
                lastUpdateTime = now;
            }

            // 定期保存播放进度
            if (now - lastSaveTime >= SAVE_INTERVAL) {
                try {
                    localStorage.setItem('song:lastTime', String(Math.floor(audio.currentTime)));
                } catch (_) {}
                lastSaveTime = now;
            }
        });

        audio.addEventListener('progress', updateSeekUI);

        // 拖动进度条跳转
        seek.addEventListener('input', (e) => {
            if (!audio.duration) return;
            const pos = Number(e.target.value) / 100;
            audio.currentTime = pos * audio.duration;
            updateSeekUI();
        });

        // 格式化时间
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // 设置总时长
        audio.addEventListener('loadedmetadata', () => {
            durationDisplay.textContent = formatTime(audio.duration);
            setupMediaSession(); // 在音频加载后设置MediaSession
            updatePositionState(); // 初始化位置状态
            updateSeekUI();

            // 恢复播放进度
            try {
                const saved = Number(localStorage.getItem('song:lastTime'));
                if (!isNaN(saved) && saved > 0 && saved < audio.duration - 1) {
                    audio.currentTime = saved;
                    updateSeekUI();
                }
            } catch (_) {}
            
            // 移除 iOS 后台播放的 AudioContext hack，保持网页端纯净实现
        });

        // 优化后的歌词同步
        let lastLyricUpdate = 0;
        audio.addEventListener('timeupdate', () => {
            const now = Date.now();
            if (now - lastLyricUpdate >= UPDATE_INTERVAL) {
                const currentTime = audio.currentTime;
                let activeLyric = null;
                let minTimeDiff = Infinity;
                
                // 查找最接近当前时间的歌词
                for (let i = 0; i < lyrics.length; i++) {
                    const time = parseFloat(lyrics[i].dataset.time);
                    const timeDiff = currentTime - time;
                    
                    // 延长歌词停留时间（从8秒增加到15秒）
                    if (timeDiff >= -0.5 && timeDiff < minTimeDiff && timeDiff < 15) {
                        minTimeDiff = timeDiff;
                        activeLyric = lyrics[i];
                    }
                }
                
                // 如果找到了活跃歌词且与当前活跃歌词不同
                if (activeLyric && activeLyric !== currentLyric) {
                    if (currentLyric) {
                        currentLyric.classList.remove('active');
                    }
                    
                    // 设置当前活跃歌词
                    currentLyric = activeLyric;
                    
                    // 更新歌词样式
                    updateLyricStyles();
                    
                    // 使用 requestAnimationFrame 优化滚动性能
                    requestAnimationFrame(() => {
                        // 计算滚动位置，使活跃歌词在容器中居中显示
                        const lyricsContainer = document.querySelector('.lyrics-container');
                        if (lyricsContainer && !lyricsContainer.classList.contains('hidden')) {
                            const containerHeight = lyricsContainer.clientHeight;
                            const lyricPosition = activeLyric.offsetTop;
                            const lyricHeight = activeLyric.clientHeight;
                            const scrollPosition = lyricPosition - (containerHeight / 2) + (lyricHeight / 2);
                            
                            lyricsContainer.scrollTo({
                                top: scrollPosition,
                                behavior: 'smooth'
                            });
                        }
                    });
                }
                
                lastLyricUpdate = now;
            }
        });

        // 更新歌词样式函数 - 优化过渡效果
        function updateLyricStyles() {
            if (!currentLyric) return;
            
            // 移除所有歌词的特殊类
            lyrics.forEach(lyric => {
                lyric.classList.remove('active', 'near-active', 'far');
            });
            
            // 添加活跃歌词类
            currentLyric.classList.add('active');
            
            // 为活跃歌词周围的歌词添加近距离类
            const activeIndex = Array.from(lyrics).indexOf(currentLyric);
            
            // 增加近距离类的范围（从前后2行扩展到前后3行）
            for (let i = Math.max(0, activeIndex - 3); i <= Math.min(lyrics.length - 1, activeIndex + 3); i++) {
                if (i !== activeIndex) {
                    lyrics[i].classList.add('near-active');
                }
            }
            
            // 为其他歌词添加远距离类
            for (let i = 0; i < lyrics.length; i++) {
                if (i < activeIndex - 3 || i > activeIndex + 3) {
                    lyrics[i].classList.add('far');
                }
            }
        }

        // 专辑封面旋转动画
        const albumCover = document.querySelector('.album-cover');
        
        // 播放结束处理
        audio.addEventListener('ended', () => {
            isPlaying = false;
            playButton.classList.remove('playing');
            playButton.classList.add('paused');
            navigator.mediaSession.playbackState = 'none';
        });

        // 歌词显示/隐藏功能
        const lyricsButton = document.querySelector('.lyrics-button');
        const lyricsContainer = document.querySelector('.lyrics-container');
        const closeLyricsButton = document.querySelector('.close-lyrics');
        const lyricLines = document.querySelectorAll('.lyric-line');

        lyricsButton.addEventListener('click', () => {
            lyricsContainer.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            lyricsContainer.classList.add('opacity-100', 'pointer-events-auto');
            document.body.style.overflow = 'hidden';
            // 初始化歌词状态
            updateLyricStyles();
        });

        closeLyricsButton.addEventListener('click', () => {
            lyricsContainer.classList.add('opacity-0');
            lyricsContainer.classList.remove('opacity-100', 'pointer-events-auto');
            setTimeout(() => {
                lyricsContainer.classList.add('hidden', 'pointer-events-none');
                document.body.style.overflow = '';
            }, 300);
        });

        // 歌词点击事件处理
        lyricLines.forEach(lyric => {
            lyric.addEventListener('click', () => {
                const time = parseFloat(lyric.dataset.time);
                if (!isNaN(time)) {
                    audio.currentTime = time;
                    
                    // 立即更新当前歌词，不等待timeupdate事件
                    if (currentLyric) {
                        currentLyric.classList.remove('active');
                    }
                    currentLyric = lyric;
                    updateLyricStyles();
                    
                    // 移除自动播放的逻辑
                    // 如果音乐没有播放，显示一个提示，告知用户需要点击播放按钮
                    if (!isPlaying) {
                        const playHint = document.createElement('div');
                        playHint.className = 'play-hint';
                        playHint.textContent = '请点击播放按钮开始播放';
                        playHint.style.position = 'fixed';
                        playHint.style.bottom = '180px';
                        playHint.style.left = '50%';
                        playHint.style.transform = 'translateX(-50%)';
                        playHint.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                        playHint.style.color = '#fff';
                        playHint.style.padding = '8px 16px';
                        playHint.style.borderRadius = '20px';
                        playHint.style.fontSize = '14px';
                        playHint.style.zIndex = '3000';
                        document.body.appendChild(playHint);
                        
                        // 3秒后自动移除提示
                        setTimeout(() => {
                            document.body.removeChild(playHint);
                        }, 3000);
                    }
                }
            });
        });

        // 处理页面可见性变化，优化后台播放体验
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // 页面可见时，如果正在播放，确保UI状态正确
                if (!audio.paused) {
                    playButton.classList.add('playing');
                    playButton.classList.remove('paused');
                    isPlaying = true;
                    albumCover.classList.add('playing');
                    
                    // 重新设置MediaSession，确保锁屏控制正常
                    if ('mediaSession' in navigator && /iPad|iPhone|iPod/.test(navigator.userAgent)) {
                        const currentMetadata = navigator.mediaSession.metadata;
                        if (currentMetadata) {
                            navigator.mediaSession.metadata = new MediaMetadata({
                                title: currentMetadata.title,
                                artist: currentMetadata.artist,
                                album: currentMetadata.album,
                                artwork: currentMetadata.artwork
                            });
                        }
                    }
                }
            } else {
                // 页面不可见时，确保MediaSession状态正确
                if (!audio.paused && 'mediaSession' in navigator) {
                    navigator.mediaSession.playbackState = 'playing';
                    updatePositionState();
                }
            }
        });

        // 处理音频错误
        audio.addEventListener('error', (e) => {
            console.error('音频播放错误:', e);
            showToast('音频加载失败，请检查网络或刷新重试');
        });

        // 轻量 Toast 提示
        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.left = '50%';
            toast.style.bottom = 'calc(120px + env(safe-area-inset-bottom))';
            toast.style.transform = 'translateX(-50%)';
            toast.style.background = 'rgba(0,0,0,0.8)';
            toast.style.color = '#fff';
            toast.style.padding = '10px 14px';
            toast.style.borderRadius = '20px';
            toast.style.fontSize = '14px';
            toast.style.zIndex = '3000';
            toast.style.opacity = '0';
            toast.style.transition = 'opacity .2s ease';
            document.body.appendChild(toast);
            requestAnimationFrame(() => { toast.style.opacity = '1'; });
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => document.body.removeChild(toast), 200);
            }, 2400);
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 预加载封面图片
            const preloadImg = new Image();
            preloadImg.src = 'assets/album-cover.jpg';
            
            // 不再进行歌词时间整体校准
            
            // 移除全局点击自动播放逻辑
            // 仅在必要时设置媒体会话，但不自动播放
            setupMediaSession();
        });

        // —— 内置一键自检（可通过 ?selfcheck=1 自动运行）——
        window.runMusicSelfCheck = async () => {
            const style = {
                pass: 'color:#10B981;font-weight:600',
                warn: 'color:#F59E0B;font-weight:600',
                fail: 'color:#EF4444;font-weight:600',
                info: 'color:#60A5FA',
                sec: 'color:#a78bfa;font-weight:600',
            };
            const res = [];
            const log = {
                pass: (msg, d='') => { console.log('%c✔ PASS', style.pass, msg, d); res.push({check: msg, status: 'PASS', detail: d}); },
                warn: (msg, d='') => { console.log('%c⚠ WARN', style.warn, msg, d); res.push({check: msg, status: 'WARN', detail: d}); },
                fail: (msg, d='') => { console.log('%c✖ FAIL', style.fail, msg, d); res.push({check: msg, status: 'FAIL', detail: d}); },
                info: (msg, d='') => { console.log('%cℹ INFO', style.info, msg, d); },
                sec:  (title) => { console.log('%c— ' + title + ' —', style.sec); }
            };
            const waitFor = (condFn, timeoutMs=3000, interval=50) => new Promise((resolve) => {
                const t0 = performance.now();
                const timer = setInterval(() => {
                    if (condFn()) { clearInterval(timer); resolve(true); }
                    else if (performance.now() - t0 > timeoutMs) { clearInterval(timer); resolve(false); }
                }, interval);
            });
            const requireGestureIfNeeded = () => new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.setAttribute('data-selfcheck-overlay', '1');
                Object.assign(overlay.style, {
                    position: 'fixed', inset: '0', background: 'rgba(0,0,0,.45)', zIndex: 99999,
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    color: '#fff', fontSize: '16px', lineHeight: '1.6', textAlign: 'center', padding: '20px'
                });
                overlay.innerHTML = '由于浏览器策略，需要一次用户手势<br>请点击任意位置继续自检';
                const onClick = () => {
                    overlay.removeEventListener('click', onClick);
                    if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                    resolve();
                };
                overlay.addEventListener('click', onClick);
                document.body.appendChild(overlay);
            });

            try { console.clear(); } catch(_) {}
            console.log('%c🎧 Music Player 一键自检开始', 'font-weight:700;color:#fff;background:#111;padding:2px 6px;border-radius:4px;');

            // 0) 句柄
            const artistEl = document.querySelector('.artist');
            log.sec('Tailwind 与结构');
            const twScript = document.querySelector('script[src*="cdn.tailwindcss.com"]');
            if (twScript) log.pass('Tailwind CDN 脚本存在', twScript.src); else log.warn('未检测到 Tailwind CDN 脚本');
            if (artistEl) {
                const color = getComputedStyle(artistEl).color;
                if (color.replace(/\s/g,'') === 'rgba(255,255,255,0.6)') {
                    log.pass('Tailwind 自定义颜色生效', 'text-brand-muted → rgba(255,255,255,0.6)');
                } else {
                    log.warn('Tailwind 自定义颜色未匹配预期', color);
                }
            } else {
                log.warn('未找到 .artist 元素用于校验 Tailwind 颜色');
            }

            if (audio) log.pass('找到音频元素 #audio-player'); else log.fail('未找到音频元素 #audio-player');
            if (seek) log.pass('找到进度条 #seek'); else log.fail('未找到进度条 #seek');
            if (playButton && prevButton && nextButton) log.pass('找到控制按钮 #play/#prev/#next');
            if (document.querySelector('.lyrics-button') && document.querySelector('.lyrics-container')) log.pass('找到歌词按钮与容器');

            if (audio) {
                const preloadOk = audio.getAttribute('preload') === 'metadata';
                const playsInline = audio.hasAttribute('playsinline') || audio.hasAttribute('webkit-playsinline');
                preloadOk ? log.pass('音频 preload=metadata') : log.warn('音频 preload 非 metadata', audio.getAttribute('preload'));
                playsInline ? log.pass('移动端 playsinline 设置就绪') : log.warn('缺少 playsinline/webkit-playsinline');
            }

            log.sec('Service Worker');
            if ('serviceWorker' in navigator) {
                const ready = await Promise.race([navigator.serviceWorker.ready, waitFor(()=>false, 2000)]);
                if (ready && ready.active) log.pass('Service Worker 已激活', ready.scope);
                else log.warn('Service Worker 未就绪（非 HTTPS 或尚未激活）');
            } else {
                log.warn('该环境不支持 Service Worker');
            }

            log.sec('音频元数据');
            if (!audio) {
                log.fail('缺少音频元素，跳过音频相关检查');
            } else {
                if (audio.readyState >= 1 || await waitFor(()=> audio.readyState >= 1, 5000)) {
                    if (isFinite(audio.duration) && audio.duration > 0) log.pass('已加载元数据', `duration=${audio.duration.toFixed(2)}s`);
                    else log.warn('元数据已触发但 duration 异常', audio.duration);
                } else {
                    log.fail('5s 内未加载元数据（网络慢或资源不可达）');
                }
            }

            log.sec('Media Session');
            if ('mediaSession' in navigator) {
                const md = navigator.mediaSession.metadata;
                if (md && md.title) log.pass('Media Session 元数据存在', `${md.title} / ${md.artist || ''}`);
                else log.warn('Media Session 元数据为空（稍后播放时再观察）');
            } else {
                log.warn('该环境不支持 Media Session');
            }

            // 试播，处理用户手势
            log.sec('播放与进度');
            let played = false;
            try {
                await audio.play();
                played = true;
                log.pass('播放启动成功（无需额外手势）');
            } catch (e) {
                if (e && (e.name === 'NotAllowedError' || /gesture/i.test(String(e)))) {
                    log.warn('浏览器阻止自动播放，等待用户手势…');
                    await requireGestureIfNeeded();
                    try { await audio.play(); played = true; log.pass('用户手势后播放成功'); }
                    catch (e2) { log.fail('用户手势后仍无法播放', e2?.name || String(e2)); }
                } else {
                    log.fail('播放启动失败', e?.name || String(e));
                }
            }

            if (played) {
                const t0 = audio.currentTime; await new Promise(r => setTimeout(r, 1200)); const t1 = audio.currentTime;
                if (t1 > t0) log.pass('播放时间推进正常', `${t0.toFixed(2)}s → ${t1.toFixed(2)}s`);
                else log.fail('播放时间未推进', `${t0.toFixed(2)}s → ${t1.toFixed(2)}s`);

                const hasPlayingClass = playButton?.classList.contains('playing');
                hasPlayingClass ? log.pass('播放按钮状态切换到 playing') : log.warn('播放按钮未见 playing 类');

                const seekVal = Number(seek?.value || 0);
                if (!isNaN(seekVal) && seekVal >= 0) log.pass('进度条数值存在', `value=${seekVal.toFixed(2)}%`);
                else log.warn('进度条数值异常', seek?.value);

                try { if (typeof updateSeekUI === 'function') { updateSeekUI(); } } catch {}
                const bg = (seek?.style.backgroundImage || seek?.style.background || '');
                if (/linear-gradient/i.test(bg)) log.pass('进度条缓冲渐变已应用'); else log.warn('未检测到缓冲渐变背景');
            }

            log.sec('进度保存');
            if (played) {
                await new Promise(r => setTimeout(r, 5200));
                const key = 'song:lastTime';
                const val = localStorage.getItem(key);
                if (val !== null) {
                    const v = Number(val); const diff = Math.abs(Math.floor(audio.currentTime) - v);
                    if (!isNaN(v) && diff <= 2) log.pass('已保存播放进度到 localStorage', `${key}=${v}`);
                    else log.warn('本地保存存在但值偏差较大', `${key}=${val}, now=${audio.currentTime.toFixed(2)}`);
                } else {
                    log.warn('5s 内未检测到本地进度保存（可能播放中断或后台标签页）');
                }
            } else {
                log.warn('未播放，跳过本地进度保存检查');
            }

            log.sec('歌词面板');
            const lyricsBtn = document.querySelector('.lyrics-button');
            const lyricsContainer = document.querySelector('.lyrics-container');
            if (lyricsBtn && lyricsContainer) {
                lyricsBtn.click();
                await waitFor(()=> !lyricsContainer.classList.contains('hidden'), 1000);
                if (!lyricsContainer.classList.contains('hidden')) log.pass('歌词面板打开'); else log.warn('歌词面板未能打开');
                const closeBtn = document.querySelector('.close-lyrics');
                if (closeBtn) { closeBtn.click(); await new Promise(r => setTimeout(r, 350)); if (lyricsContainer.classList.contains('hidden')) log.pass('歌词面板关闭'); else log.warn('歌词面板未能关闭'); }
                else { log.warn('未找到关闭按钮 .close-lyrics'); }
                const anyActive = document.querySelector('.lyric-line.active');
                if (anyActive) log.pass('检测到活跃歌词行 .active'); else log.warn('暂未检测到活跃歌词');
            } else {
                log.warn('缺少歌词按钮或容器，跳过歌词检查');
            }

            log.sec('Range 请求绕过缓存');
            try {
                const mp3 = audio?.querySelector('source')?.src || audio?.currentSrc;
                if (mp3) {
                    const rsp = await fetch(mp3, { headers: { Range: 'bytes=0-0' } });
                    if (rsp.status === 206) log.pass('Range 请求状态码 206（已绕过 SW 缓存）');
                    else if (rsp.status === 200) log.warn('Range 返回 200，服务器可能未开启分段或合并响应');
                    else log.warn('Range 响应状态', rsp.status);
                } else {
                    log.warn('未能定位 MP3 地址以测试 Range 请求');
                }
            } catch (e) {
                log.warn('Range 请求测试失败', e?.message || String(e));
            }

            log.sec('控制键');
            if (played) {
                const before = audio.currentTime;
                document.getElementById('prev')?.click();
                await new Promise(r => setTimeout(r, 50));
                if (audio.currentTime <= 0.2) log.pass('上一首按钮将进度归零'); else log.warn('上一首未归零', audio.currentTime.toFixed(2));
                if (isFinite(audio.duration) && audio.duration > 10) audio.currentTime = Math.min(before + 5, audio.duration - 1);
                document.getElementById('next')?.click();
                await new Promise(r => setTimeout(r, 50));
                if (audio.currentTime <= 0.3) log.pass('下一首按钮将进度归零'); else log.warn('下一首未归零', audio.currentTime.toFixed(2));
            } else {
                log.warn('未播放，跳过控制键行为检查');
            }

            console.log(''); console.log('%c自检结果汇总', 'font-weight:700');
            const passN = res.filter(r => r.status === 'PASS').length;
            const warnN = res.filter(r => r.status === 'WARN').length;
            const failN = res.filter(r => r.status === 'FAIL').length;
            try { console.table(res); } catch(_) { console.log(res); }
            const badge = failN ? style.fail : (warnN ? style.warn : style.pass);
            console.log('%c完成: PASS ' + passN + ' | WARN ' + warnN + ' | FAIL ' + failN, badge);

            // 屏幕内也显示一个简明结果徽章
            const badgeDiv = document.createElement('div');
            badgeDiv.textContent = `自检完成 · PASS ${passN} | WARN ${warnN} | FAIL ${failN}`;
            Object.assign(badgeDiv.style, {
                position: 'fixed', left: '50%', bottom: 'calc(120px + env(safe-area-inset-bottom))', transform: 'translateX(-50%)',
                background: failN ? '#EF4444' : (warnN ? '#F59E0B' : '#10B981'), color: '#fff',
                padding: '10px 14px', borderRadius: '20px', fontSize: '14px', zIndex: 3000, opacity: '0', transition: 'opacity .2s ease'
            });
            document.body.appendChild(badgeDiv);
            requestAnimationFrame(() => { badgeDiv.style.opacity = '1'; });
            setTimeout(() => { badgeDiv.style.opacity = '0'; setTimeout(() => badgeDiv.remove(), 600); }, 3600);
        };

        // 地址栏参数触发：?selfcheck=1 自动执行
        (function(){
            try {
                const p = new URLSearchParams(location.search);
                if (p.get('selfcheck') === '1') {
                    // 延迟到 onload 后执行，避免 SW/媒体会话尚未就绪
                    window.addEventListener('load', () => {
                        setTimeout(() => { window.runMusicSelfCheck(); }, 300);
                    });
                }
            } catch(_) {}
        })();
    </script>
</body>
</html> 
