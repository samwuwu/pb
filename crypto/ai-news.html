<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI 前沿新闻 · 热度自动排行（中英源 / 中文摘要 / 趋势展望）</title>
<style>
:root{
  --bg:#0a0f16; --panel:#101827; --text:#e6edf3; --muted:#9fb0c2; --line:#1f2a37;
  --chip:#162133; --link:#8ab4ff; --accent:#4c82ff; --danger:#ff8a8a; --ok:#25d07f;
}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(1200px 600px at 70% -10%, #142036 0%, transparent 70%) no-repeat, var(--bg);
  color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"SF Pro Text",Inter,"PingFang SC","Noto Sans CJK SC","Microsoft YaHei",Arial,sans-serif}
a{color:var(--link);text-decoration:none}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(10,15,22,.9), rgba(10,15,22,.6));backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
.wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
h1{margin:0;font-size:22px}
.sub{color:var(--muted);font-size:13px;margin-top:4px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
input[type="search"]{background:#0f1623;border:1px solid #263144;color:var(--text);border-radius:10px;padding:10px 12px;outline:none;width:280px}
button{background:linear-gradient(180deg,#507bff,#3a63f0);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;box-shadow:0 8px 18px rgba(76,130,255,.25)}
button.secondary{background:#182235;border:1px solid #2a3852;box-shadow:none;color:#d5e4ff}
select{background:#0f1623;border:1px solid #263144;color:var(--text);border-radius:8px;padding:6px 8px;margin-left:6px}
input[type="number"]{width:70px;background:#0f1623;border:1px solid #263144;color:var(--text);border-radius:8px;padding:4px 6px;margin-left:6px}
input[type="checkbox"]{margin-left:6px;transform:scale(1.1)}
main{max-width:1200px;margin:0 auto;padding:18px 16px 40px}
.grid{display:grid;grid-template-columns: 2fr 1fr;gap:16px}
@media (max-width:1000px){.grid{grid-template-columns:1fr}}
.panel{background:linear-gradient(180deg,#0f1726,#0c1421);border:1px solid var(--line);border-radius:14px;padding:14px}
.panel h2{margin:0 0 12px 0;font-size:16px;display:flex;align-items:center;gap:8px}
.chip{display:inline-flex;gap:6px;align-items:center;background:var(--chip);color:#cfe0ff;border:1px solid #27334a;border-radius:999px;padding:3px 8px;font-size:12px}
.list{display:flex;flex-direction:column;gap:10px}
.item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:start;background:#0c1421;border:1px solid #1b2436;border-radius:12px;padding:12px}
.item:hover{border-color:#2b3a58;background:#0f1827}
.rank{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;background:#19263b;color:#cfe0ff}
.item h3{margin:0;font-size:15px;line-height:1.4}
.meta{color:#a7b9cc;font-size:12px;display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
.badge{font-size:11px;border:1px solid #2a3852;border-radius:999px;padding:2px 6px;background:#141d2b}
.score{font-variant-numeric:tabular-nums}
.desc{color:#c6d3e2;font-size:13px;margin-top:8px}
footer{color:#8aa0b4;font-size:12px;border-top:1px solid var(--line);padding:18px 16px 48px;max-width:1200px;margin:0 auto}
.skeleton{height:14px;width:100%;border-radius:6px;background:linear-gradient(90deg,#0f1622,#121b2c,#0f1622);background-size:200% 100%;animation:shine 1.4s linear infinite}
@keyframes shine{0%{background-position:200% 0}100%{background-position:-200% 0}}
/* CN summary & trends */
.desc-cn{color:#d8e7ff;font-size:13px;margin-top:6px;border-left:3px solid #2a3a56;padding-left:10px}
.cn-tag{display:inline-block;margin-right:6px}
.trend-card{background:linear-gradient(180deg,#0d1626,#0a1220);border:1px solid #22304a;border-radius:14px;padding:14px}
.trend-card h3{margin:0 0 8px 0;font-size:15px}
.trend-list{margin:0;padding-left:18px;color:#cfe0ff}
.kpi{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
.kpi .badge{background:#0f1a2b}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>AI 前沿新闻 · 热度自动排行</h1>
    <div class="sub">来源涵盖：TechCrunch / VentureBeat / MIT Tech Review / Ars Technica / Wired / OpenAI / Google AI / DeepMind / Hugging Face / arXiv 等（含中文：机器之心、量子位）</div>
    <div class="controls">
      <input id="q" type="search" placeholder="搜索标题 / 来源 / 关键词…">
      <label class="chip">时间窗口
        <select id="timewin">
          <option value="latest" selected>最新</option>
          <option value="24h">近 24 小时</option>
          <option value="48h">近 48 小时</option>
        </select>
      </label>
      <button id="refresh">立即刷新</button>
      <button id="toggleAuto" class="secondary">自动刷新：开启</button>
      <button id="toggleCN" class="secondary">中文摘要：开启</button>
      <label class="chip">中文源计入热度 <input id="cnInHot" type="checkbox"></label>
      <label class="chip">中文源权重 <input id="cnWeight" type="number" step="0.05" min="0" max="1" value="0"></label>
      <label class="chip">LLM/AGI 权重 <input id="wLLM" type="number" step="0.01" min="0" max="1" value="0.22"></label>
      <label class="chip">RAG 权重 <input id="wRAG" type="number" step="0.01" min="0" max="1" value="0.14"></label>
      <label class="chip">MoE 权重 <input id="wMOE" type="number" step="0.01" min="0" max="1" value="0.14"></label>
      <label class="chip">视频生成 权重 <input id="wVideo" type="number" step="0.01" min="0" max="1" value="0.16"></label>
      <span class="chip">本地时间 <span id="now"></span></span>
    </div>
  </div>
</header>

<main>
  <!-- TOP: Trend panel -->
  <section class="panel" id="trend" style="margin-bottom:20px">
    <h2>📈 总体趋势 & 30 天展望 <span class="chip" id="trendUpdated">生成中…</span></h2>
    <div id="trendBody">
      <div class="skeleton" style="height:18px"></div>
      <div class="skeleton" style="height:14px;width:80%"></div>
      <div class="skeleton" style="height:14px;width:60%"></div>
    </div>
  </section>

  <div class="grid">
    <section class="panel" id="hot">
      <h2>🔥 热点 Top 10 <span class="chip" id="hotUpdated">加载中…</span></h2>
      <div class="list" id="hotList">
        <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
        <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
      </div>
    </section>

    <section class="panel src-panel" id="bySource">
      <h2>📰 按来源浏览 <span class="chip" id="srcUpdated">加载中…</span></h2>
      <div id="srcLists"></div>
    </section>
  </div>
</main>

<footer>
  注：本页通过官方/公开 RSS 获取标题与摘要，无法获取付费墙全文；“热度分”采用启发式算法：<span class="badge">时效性衰减</span> + <span class="badge">多源重复度</span> + <span class="badge">关键词加权</span>（如 LLM/AGI、RAG、MoE、视频生成、芯片等）。仅作资讯排序参考。
</footer>

<script>
const feeds = [
  // 中文资讯源（默认不计入热度，可切换/设置权重）
  { name: "机器之心", home: "https://www.jiqizhixin.com", url: "https://www.jiqizhixin.com/rss", isCN:true },
  { name: "量子位",   home: "https://www.qbitai.com",    url: "https://www.qbitai.com/feed", isCN:true },

  // 英文资讯源（媒体）
  { name: "TechCrunch AI",     home: "https://techcrunch.com",         url: "https://techcrunch.com/category/artificial-intelligence/feed/" },
  { name: "VentureBeat AI",    home: "https://venturebeat.com",        url: "https://venturebeat.com/category/ai/feed/" },
  { name: "MIT Tech Review",   home: "https://www.technologyreview.com", url: "https://www.technologyreview.com/feed/" },
  { name: "The Verge",         home: "https://www.theverge.com",       url: "https://www.theverge.com/rss/index.xml" },
  { name: "Ars Technica AI",   home: "https://arstechnica.com",        url: "https://arstechnica.com/tag/artificial-intelligence/feed/" },
  { name: "Wired AI",          home: "https://www.wired.com",          url: "https://www.wired.com/feed/tag/ai/latest/rss" },

  // 官方/研究博客
  { name: "OpenAI Blog",       home: "https://openai.com/blog",        url: "https://openai.com/blog/rss" },
  { name: "Google AI Blog",    home: "https://ai.googleblog.com",      url: "https://ai.googleblog.com/feeds/posts/default" },
  { name: "DeepMind Blog",     home: "https://deepmind.google/discover/blog", url: "https://deepmind.google/discover/blog/rss/" },
  { name: "Hugging Face Blog", home: "https://huggingface.co/blog",    url: "https://huggingface.co/blog/feed.xml" },

  // 学术/论文
  { name: "arXiv cs.AI",       home: "https://arxiv.org",              url: "https://export.arxiv.org/rss/cs.AI" },
  { name: "arXiv cs.CL",       home: "https://arxiv.org",              url: "https://export.arxiv.org/rss/cs.CL" }
];

const MAX_PER_FEED = 14;
const HOT_LIMIT = 10;
let auto = true, autoTimer = null;
let showCN = true;

// time & controls
const hotList = document.getElementById('hotList');
const hotUpdated = document.getElementById('hotUpdated');
const srcUpdated = document.getElementById('srcUpdated');
const trendUpdated = document.getElementById('trendUpdated');
const trendBody = document.getElementById('trendBody');

const q = document.getElementById('q');
const nowEl = document.getElementById('now');
const btnRefresh = document.getElementById('refresh');
const btnAuto = document.getElementById('toggleAuto');
const btnCN = document.getElementById('toggleCN');

const selTime = document.getElementById('timewin');
const chkCnInHot = document.getElementById('cnInHot');
const inpCnWeight = document.getElementById('cnWeight');
const wLLM = document.getElementById('wLLM');
const wRAG = document.getElementById('wRAG');
const wMOE = document.getElementById('wMOE');
const wVideo = document.getElementById('wVideo');

let CN_INCLUDE_IN_HOT = false;
let CN_WEIGHT = 0.0;

function tickNow(){ nowEl.textContent = new Date().toLocaleString(); }
setInterval(tickNow, 1000); tickNow();

btnRefresh.addEventListener('click', refreshAll);
btnAuto.addEventListener('click', ()=>{
  auto = !auto;
  btnAuto.textContent = '自动刷新：' + (auto ? '开启' : '关闭');
  btnAuto.classList.toggle('secondary', !auto);
  if(auto) autoTimer = setInterval(refreshAll, 15*60*1000);
  else clearInterval(autoTimer);
});
btnCN.addEventListener('click', ()=>{
  showCN = !showCN;
  btnCN.textContent = '中文摘要：' + (showCN ? '开启' : '关闭');
  for(const el of document.querySelectorAll('.desc-cn')) el.style.display = showCN ? '' : 'none';
});

q.addEventListener('input', ()=>{
  for (const el of document.querySelectorAll('[data-search]')){
    const hit = (el.dataset.search || '').includes(q.value.trim().toLowerCase());
    el.style.display = hit ? '' : 'none';
  }
});

chkCnInHot.addEventListener('change', ()=>{ CN_INCLUDE_IN_HOT = chkCnInHot.checked; refreshAll(); });
inpCnWeight.addEventListener('input', ()=>{ CN_WEIGHT = Math.max(0, Math.min(1, parseFloat(inpCnWeight.value||'0')||0)); });
[wLLM, wRAG, wMOE, wVideo, selTime].forEach(el => el.addEventListener('input', ()=> refreshAll()));
selTime.addEventListener('change', ()=> refreshAll());

function getKeywordBoosts(){
  const wLLMV = parseFloat(wLLM.value||'0.22') || 0;
  const wRAGV = parseFloat(wRAG.value||'0.14') || 0;
  const wMOEV = parseFloat(wMOE.value||'0.14') || 0;
  const wVideoV = parseFloat(wVideo.value||'0.16') || 0;
  return [
    // 产品/行业级关键词
    {re:/\b(AGI|LLM|GPT|Claude|Gemini|Llama|Mistral|o1|o3|Sora)\b/i, w:wLLMV},
    {re:/\b(RAG|retrieval[- ]augmented|vector|embedding)\b/i, w:wRAGV},
    {re:/\b(MoE|Mixture of Experts|experts)\b/i, w:wMOEV},
    {re:/\b(video generation|text-to-video|sora|vlogr|runway|pika)\b/i, w:wVideoV},
    // 芯片/算力/基建
    {re:/\b(H100|H200|H200|B200|GB200|TPU|MI300|MI325|Blackwell|Grace|NVLink|inference|throughput)\b/i, w:0.18},
    // 安全与政策
    {re:/\b(AI safety|alignment|red teaming|evals|policy|regulation|compliance|copyright|lawsuit)\b/i, w:0.18},
    // 研究指标
    {re:/\b(SOTA|benchmark|MMLU|Arena|MT-Bench|HumanEval|GSM8K|TÜLU|Tulu|L-Eval)\b/i, w:0.16},
    // 开源与模型发布
    {re:/\b(release|weights|checkpoint|open source|opensource|license|Apache-2\.0|MIT)\b/i, w:0.14}
  ];
}

function inTimeWindow(pubDate){
  if(!pubDate) return true;
  const mode = selTime.value || 'latest';
  if(mode==='latest') return true;
  const ageMs = Date.now() - new Date(pubDate).getTime();
  const limit = (mode==='24h') ? 24*3600000 : 48*3600000;
  return ageMs <= limit;
}

function domainFrom(u){ try{ return new URL(u).hostname.replace(/^www\./,''); }catch(_){ return ''; } }
function strip(html){ const d = document.createElement('div'); d.innerHTML = html; return d.textContent || d.innerText || ''; }
function trunc(s, n=200){ if(!s) return ''; return s.length>n ? s.slice(0,n-1) + '…' : s; }

async function fetchWithFallbacks(url){
  try{ const r = await fetch(url, {mode:'cors'}); if(r.ok){ return { kind:'xml', text: await r.text() }; } }catch(e){}
  try{ const r = await fetch('https://api.allorigins.win/raw?url='+encodeURIComponent(url)); if(r.ok){ return { kind:'xml', text: await r.text() }; } }catch(e){}
  try{ const r = await fetch('https://api.rss2json.com/v1/api.json?rss_url='+encodeURIComponent(url)); if(r.ok){ return { kind:'json', json: await r.json() }; } }catch(e){}
  throw new Error('获取失败：'+url);
}

function parseXMLItems(xmlText){
  const dp = new DOMParser(); const doc = dp.parseFromString(xmlText, 'text/xml');
  let nodes = [...doc.querySelectorAll('item')]; if(nodes.length===0) nodes = [...doc.querySelectorAll('entry')];
  const items = nodes.map(n=>{
    const title = n.querySelector('title')?.textContent?.trim() || 'Untitled';
    const link = n.querySelector('link')?.getAttribute?.('href') || n.querySelector('link')?.textContent?.trim() || '#';
    const pubDate = n.querySelector('pubDate')?.textContent?.trim() || n.querySelector('updated')?.textContent?.trim() || n.querySelector('published')?.textContent?.trim() || '';
    const desc = n.querySelector('description')?.textContent || n.querySelector('content\\:encoded')?.textContent || '';
    return { title, link, pubDate, desc };
  });
  return items;
}
function parseJSONItems(j){
  return (j.items||[]).map(x=>({ title:x.title, link:x.link, pubDate:x.pubDate||x.published||'', desc:x.description||'' }));
}

function normalizeTitle(s){
  return (s||'').toLowerCase()
    .replace(/[\|\-–—·•:;,_()\[\]{}]/g,' ')
    .replace(/\s+/g,' ')
    .replace(/\b(breaking|update|news)\b/g,'')
    .trim();
}

function classifyCategory(text){
  const t = text.toLowerCase();
  if(/(policy|regulation|copyright|lawsuit|compliance|eu ai act|white house)/i.test(t)) return '政策/合规';
  if(/(h100|b200|gb200|tpu|mi300|blackwell|inference|throughput|latency)/i.test(t)) return '芯片/算力';
  if(/(rag|retrieval[- ]augmented|vector|embedding|bedrock|pinecone|faiss|milvus)/i.test(t)) return 'RAG/检索';
  if(/(moe|mixture of experts|experts)/i.test(t)) return 'MoE 架构';
  if(/(video generation|text-to-video|sora|runway|pika|gen-3)/i.test(t)) return '视频生成';
  if(/(sota|benchmark|mmlu|human ?eval|gsm8k|mt[- ]bench|arena|eval)/i.test(t)) return '评测/SOTA';
  if(/(release|weights|checkpoint|open source|license|apache|mit|hugging face)/i.test(t)) return '开源/发布';
  if(/(bug|exploit|red team|abuse|safety|alignment)/i.test(t)) return '安全/对齐';
  if(/(agi|llm|gpt|claude|gemini|llama|mistral|o1|o3)/i.test(t)) return '模型/产品';
  return '其他';
}

function cnSummary(it){
  const title = it.title || '';
  const desc = (it.desc || '').replace(/\s+/g,' ').trim();
  const cat = classifyCategory(title + ' ' + desc);
  const time = it.pubDate ? new Date(it.pubDate).toLocaleString() : '';

  let point = '';
  switch(cat){
    case '政策/合规':
      point = '政策与合规动态将影响产品合规边界与商用落地节奏，短期或带来估值重定价。'; break;
    case '芯片/算力':
      point = '芯片与算力供给决定训练与推理成本，中期影响模型迭代速度与商业可行性。'; break;
    case 'RAG/检索':
      point = 'RAG 基建升级提升企业级准确性与可控性，是落地路径的重要增量。'; break;
    case 'MoE 架构':
      point = 'MoE 在效率与质量间平衡，若工具链成熟，可能成为主流架构之一。'; break;
    case '视频生成':
      point = '视频生成进入高质量阶段，应用扩展迅速，但版权与合规挑战上升。'; break;
    case '评测/SOTA':
      point = '评测与对齐指标更新可快速改变行业排名，需关注评测客观性与作弊防范。'; break;
    case '开源/发布':
      point = '开源发布与权重开放能快速扩散能力，生态与许可证选择决定产业影响。'; break;
    case '安全/对齐':
      point = '安全与对齐研究决定可控性边界，短期压制风险，长期提升可用性。'; break;
    case '模型/产品':
      point = '模型/产品更新影响用户面与生态竞争格局，常与算力与评测联动。'; break;
    default:
      point = '该消息影响需结合后续披露与多源验证再判断。';
  }

  let concl = '';
  switch(cat){
    case '政策/合规':
      concl = '结论：跟踪官方文本与实施细则；企业应用需同步评估合规成本与数据治理。'; break;
    case '芯片/算力':
      concl = '结论：关注供给节奏与价格曲线；推理成本下降将释放更多商业场景。'; break;
    case 'RAG/检索':
      concl = '结论：优先验证检索质量与知识时效；结合观测日志进行评估闭环。'; break;
    case 'MoE 架构':
      concl = '结论：评估路由稳定性与工具链成熟度；在高吞吐场景渐进式试点。'; break;
    case '视频生成':
      concl = '结论：重视版权合规与安全水印；优先选择可控度高的应用场景。'; break;
    case '评测/SOTA':
      concl = '结论：避免唯指标论；结合企业任务集进行对齐与稳健性验证。'; break;
    case '开源/发布':
      concl = '结论：核对许可证与商用条款；结合团队能力选择自研/集成路径。'; break;
    case '安全/对齐':
      concl = '结论：建立红队与自动化评测；安全能力纳入采购与上线门槛。'; break;
    case '模型/产品':
      concl = '结论：结合真实用例进行 A/B 与成本评估；关注生态与插件扩展。'; break;
    default:
      concl = '结论：维持观察，等待多源确认后再评估价值。';
  }

  return {cat, point, concl, time};
}

function renderCnBlock(it){
  const s = cnSummary(it);
  return `<div class="desc-cn" style="${showCN?'':'display:none'}">
    <span class="badge cn-tag">类别：${s.cat}</span>
    <span class="badge">${s.time || ''}</span>
    <div style="margin-top:6px">${s.point}</div>
    <div class="muted" style="margin-top:4px">${s.concl}</div>
  </div>`;
}

function buildTrends(hot){
  const counts = { '政策/合规':0, '芯片/算力':0, 'RAG/检索':0, 'MoE 架构':0, '视频生成':0, '评测/SOTA':0, '开源/发布':0, '安全/对齐':0, '模型/产品':0, '其他':0 };
  let newestTs = 0;
  for(const it of hot){
    const cat = classifyCategory((it.title||'') + ' ' + (it.desc||''));
    counts[cat] = (counts[cat]||0) + 1;
    const ts = it.pubDate ? new Date(it.pubDate).getTime() : 0;
    if(ts > newestTs) newestTs = ts;
  }
  const focus = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,3);
  const dateStr = newestTs? new Date(newestTs).toLocaleString() : '';

  const bullets = [];
  if(counts['模型/产品']>0) bullets.push('模型/产品更新密集，生态竞争加速；注意评测与成本的联动变化。');
  if(counts['芯片/算力']>0) bullets.push('芯片/算力供给与价格曲线是关键变量，决定训练/推理节奏。');
  if(counts['开源/发布']>0) bullets.push('开源与权重开放带来扩散效应，应用侧将快速跟进。');
  if(counts['视频生成']>0) bullets.push('视频生成热度上升，需关注版权与安全水印技术。');
  if(counts['政策/合规']>0) bullets.push('政策合规事项增多，企业落地需同步升级治理与审计能力。');
  if(bullets.length===0) bullets.push('市场主题分散，建议以风控与评测先行，谨慎扩张。');

  const outlook = [];
  outlook.push('30 天展望：');
  if(counts['芯片/算力']>=counts['政策/合规']) {
    outlook.push('若算力与工具链利好占优，产品与开源更新将继续高频出现，B端验证加速。');
  } else {
    outlook.push('若政策/合规扰动增强，节奏或放缓；优先巩固安全与治理能力。');
  }
  outlook.push('建议关注：模型更新 → 评测验证 → 成本结构 → 实际落地的闭环。');

  const kpi = `
    <div class="kpi">
      ${focus.map(([k,v])=>`<span class="badge">${k}：${v} 条</span>`).join('')}
      <span class="badge">最新时间：${dateStr||'—'}</span>
    </div>`;

  return `
    <div class="trend-card">
      <h3>要点</h3>
      ${kpi}
      <ul class="trend-list">
        ${bullets.map(x=>`<li>${x}</li>`).join('')}
      </ul>
      <h3 style="margin-top:10px">预测</h3>
      <ul class="trend-list">
        ${outlook.map(x=>`<li>${x}</li>`).join('')}
      </ul>
    </div>
  `;
}

// ===== Aggregation & Scoring =====
function inTimeWindow(pubDate){
  if(!pubDate) return true;
  const mode = selTime.value || 'latest';
  if(mode==='latest') return true;
  const ageMs = Date.now() - new Date(pubDate).getTime();
  const limit = (mode==='24h') ? 24*3600000 : 48*3600000;
  return ageMs <= limit;
}

function scoreItem(it, appearances=1){
  const KEYWORD_BOOSTS = getKeywordBoosts();
  // recency
  let recency = 0;
  if(it.pubDate){
    const ageMs = Date.now() - new Date(it.pubDate).getTime();
    const ageH = Math.max(0, ageMs/3600000);
    recency = Math.exp(-ageH/24); // 24h 半衰
  }
  // keywords
  const text = (it.title + ' ' + (it.desc||'')).toLowerCase();
  let ksum = 0;
  for (const r of KEYWORD_BOOSTS){ if(r.re.test(text)) ksum += r.w; }
  // multi-source
  const multi = Math.min(1, 0.3 * Math.max(0, appearances-1));
  let score = 0.6*recency + ksum + multi + 0.1;

  if(it.isCN){ score = score * (CN_WEIGHT>0 ? (1+CN_WEIGHT) : 1); }
  return Math.round(score*100)/100;
}

async function refreshAll(){
  hotUpdated.textContent = '更新中…';
  srcUpdated.textContent = '更新中…';
  trendUpdated.textContent = '生成中…';
  hotList.innerHTML = '<div class="skeleton"></div>'.repeat(10);
  document.getElementById('srcLists').innerHTML = '';

  const allBySource = [];
  await Promise.all(feeds.map(async f=>{
    try{
      const res = await fetchWithFallbacks(f.url);
      let items = res.kind==='xml' ? parseXMLItems(res.text) : parseJSONItems(res.json);
      items = items.slice(0, MAX_PER_FEED).map(x=>({ ...x, source:f.name, home:f.home, isCN: !!f.isCN }));
      allBySource.push({ source:f.name, home:f.home, items, isCN: !!f.isCN });
    }catch(e){
      allBySource.push({ source:f.name, home:f.home, items:[{ title:'❌ 拉取失败：'+e.message, link:f.home, pubDate:'', desc:'' }], isCN: !!f.isCN });
    }
  }));

  // 重复聚合
  const bucket = new Map();
  for (const pkg of allBySource){
    for (const it of pkg.items){
      if (!inTimeWindow(it.pubDate)) continue; // 时间窗口过滤（进入 HOT 的前置条件）
      const key = normalizeTitle(it.title);
      if(!bucket.has(key)) bucket.set(key, { item: it, appearances:1, sources:new Set([it.source]) });
      else{
        const o = bucket.get(key);
        o.appearances += 1; o.sources.add(it.source);
        if(new Date(it.pubDate) > new Date(o.item.pubDate)) o.item = it;
        o.item.isCN = o.item.isCN || it.isCN;
      }
    }
  }

  // 计算热度
  let hot = [];
  for (const [_, obj] of bucket){
    const isCN = !!obj.item.isCN || (obj.item.source && (obj.item.source.includes('机器之心') || obj.item.source.includes('量子位')));
    if(isCN && !CN_INCLUDE_IN_HOT) continue; // 中文源不计入 HOT（可切换）
    const s = scoreItem(obj.item, obj.appearances);
    hot.push({ ...obj.item, appearances: obj.appearances, sources: [...obj.sources], score: s });
  }
  hot.sort((a,b)=> b.score - a.score);
  hot = hot.slice(0, HOT_LIMIT);

  // 渲染 HOT
  hotList.innerHTML = hot.map((it, idx)=>{
    const dom = domainFrom(it.link) || it.source;
    const time = it.pubDate ? new Date(it.pubDate).toLocaleString() : '';
    const search = (it.title + ' ' + dom + ' ' + it.source).toLowerCase();
    const excerpt = trunc(strip(it.desc||''), 220);
    return `
      <article class="item" data-search="${search}">
        <div class="rank">${idx+1}</div>
        <div>
          <h3><a href="${it.link}" target="_blank" rel="noopener">${it.title}</a></h3>
          <div class="meta">
            <span class="badge">来源：${it.source}${it.appearances>1?` · ${it.appearances}源共识`:''}</span>
            ${time?`<span class="badge">${time}</span>`:''}
            <span class="badge score">热度分：${it.score.toFixed(2)}</span>
          </div>
          ${excerpt?`<div class="desc">${excerpt}</div>`:''}
          ${renderCnBlock(it)}
          <div class="actions" style="margin-top:8px">
            <a class="chip" href="${it.link}" target="_blank" rel="noopener">阅读全文 →</a>
            <a class="chip" href="${feeds.find(f=>f.name===it.source)?.home||'#'}" target="_blank" rel="noopener">访问 ${it.source}</a>
          </div>
        </div>
        <div><span class="chip">${dom}</span></div>
      </article>
    `;
  }).join('');
  hotUpdated.textContent = '更新完成 · ' + new Date().toLocaleTimeString();

  // 趋势面板（基于 HOT，以便与时间窗口一致）
  trendBody.innerHTML = buildTrends(hot);
  trendUpdated.textContent = '已生成';

  // 按来源渲染（不强制时间窗口过滤，便于核对）
  const srcLists = document.getElementById('srcLists');
  srcLists.innerHTML = allBySource.map(pkg=>{
    const list = pkg.items.map(it=>{
      const t = it.pubDate ? new Date(it.pubDate).toLocaleString() : '';
      const ex = trunc(strip(it.desc||''), 140);
      const s = inTimeWindow(it.pubDate) ? scoreItem(it, 1) : NaN;
      const search = (it.title + ' ' + pkg.source + ' ' + (it.link||'')).toLowerCase();
      return `
        <div class="item" data-search="${search}" style="grid-template-columns:1fr auto">
          <div>
            <h3><a href="${it.link}" target="_blank" rel="noopener">${it.title}</a></h3>
            <div class="meta">
              ${t?`<span class="badge">${t}</span>`:''}
              ${!isNaN(s)?`<span class="badge score">热度分：${s.toFixed(2)}</span>`:'<span class="badge">窗口外</span>'}
            </div>
            ${ex?`<div class="desc">${ex}</div>`:''}
            ${inTimeWindow(it.pubDate)?renderCnBlock(it):''}
          </div>
          <div><a class="chip" href="${pkg.home}" target="_blank" rel="noopener">主页</a></div>
        </div>
      `;
    }).join('');
    return `
      <div class="panel" style="margin-bottom:12px">
        <h2>${pkg.source}${pkg.isCN?' <span class="badge">中文</span>':''}</h2>
        <div class="list">${list}</div>
      </div>
    `;
  }).join('');

  // 应用搜索过滤（若有关键字）
  q.dispatchEvent(new Event('input'));
}

// init
refreshAll();
autoTimer = setInterval(refreshAll, 15*60*1000);
</script>
</body>
</html>
